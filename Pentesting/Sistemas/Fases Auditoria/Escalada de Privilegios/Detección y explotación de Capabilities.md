-----
- Tags: #escalada #teoria #practica
-----

# Detección y explotación de Capabilities 

### En sistemas Linux, las capabilities son una funcionalidad de seguridad que permite a los usuarios realizar acciones que normalmente requiere privilegios de superusuario (**root**), sin tener que concederles acceso completo de superusuario. Esto se hace para mejorar la seguridad, ya que solo necesita ciertos privilegios puede obtenerlos sin tener que ejecutarse como root. 

### Las capabilities se dividen en 3 tipos: 

- ### **Permisos efectivos (Effective capabilities):** son los permisos que se aplica directamente al proceso que los posee. estos permisos determinan  las acciones que ele proceso puede realizar. Por ejemplo, la capability **"CAP_NET_ADMIN"** permite al proceso modificar las configuración de red.
- ### **Permisos heredados (Inheritablese capabilities):** son los permisos que se hereda por los procesos hijos que son creados. Estos permisos puede ser adicionales a los permisos efectivos que ya posee el proceso padre. Por ejemplo, si un proceso padre tiene la capability **"CAP_NET_ADMIN"** y esta capability se configura como heredable, entonces los procesos hijos también tendrán la capability **"CAP_NET_ADMIN"**.
- ### **Permisos permitidos (Permitted capabilities):** son los permisos que un proceso tiene permitidos. Esto incluye tanto permisos efectivos como heredados. Un proceso solo puede ejecutar acciones para las que tiene permisos permitidos. Por ejemplo, si un proceso tiene la capability **"CAP_NET_ADMIN"** y la capability **"CAP_SETUID"** configurada como permitida, entonces el proceso puede modificar la configuración de red y cambiar su **UID (User ID)**. 

### Algunas capabilities pueden suponer un riesgo desde el punto de vista de la seguridad si se les asignan a determinado binarios. Por ejemplo, la capability **CAP_SETUID** permite a un proceso establecer el UID de un proceso a otro valor diferente al suyo, lo que puede permitir que un usuario malintencionado ejecute código malicioso con privilegios elevados.

### Para **listar** las capabilities de un archivo binario en Linux, se puede usar el comando **getcap**. Este comando muestra las capabilities efectivas, heredables y permitidas del archivo. Por ejemplo, para ver las capabilities del binario **/usr/bin/ping**, podemos ejecutar el comando: 

### `getcap /usr/bin/ping`

### La salida del comando mostrará las capabilities asignadas al archivo: 

### `/usr/bin/ping = cap_net_admin,cap_net_raw+ep`

### En este ejemplo, el binario ping tiene dos capabilities asignadas. 

### Para asignar una capability a un archivo binario, se puede utilizar el comando **setcap**. Este comando establece capabilities efectivas, heredables y permitidas para el archivo especificado.  (**sudo setcap {capability} {binario}**)

### Es importante tener en cuenta que los permisos permitidos pueden ser limitados aún más mediante el uso de un mecanismo de control de acceso obligatorio (MAC, Mandatory Access Control), como **SELinux** o **AppArmor**, que restringen las acciones que los procesos puede realizar en función de la política de seguridad del sistema. 

# Escalada 

### Para ver las capabilitys existentes, podríamos fijarnos algún proceso, por ejemplo, tomar algún PID obtenido al realizar el comando **ps -faux** y dirigirnos a su ruta, supongamos que tomamos el proceso *480*, nos dirigimos a **/proc/480/status** y veríamos info del proceso, donde, si grepeamos por *Cap* veríamos 5 resultados:

```bash 
ps -faux 
# 480 ..... 

cat /proc/480/status | grep Cap 
#CapInh:	0000000000000000
#CapPrm:	000001ffffffffff
#CapEff:	000001ffffffffff
#CapBnd:	000001ffffffffff
#CapAmb:	0000000000000000

# Para ver las capabilities disponibles y asignadas podemos usar el sig comando: 
capsh --decode=000001ffffffffff

# Listar capabilities desde la raiz 
getcap -r / 2>/dev/null

# También se podría usar una herramienta 
getpcaps {PID}

# -----------------------

# Setear una capabilitie 
setcap cap_setuid+ep /usr/bin/python3.10 
# Eliminar una capabilitie 
setcap -r /usr/bin/python3.10 
```

### Para escalar los privilegios podríamos ver páginas, una vez más, como [gtfobins](https://gtfobins.github.io/gtfobins) para ver que capabilities son peligrosas para determinados usuarios así como poder explotar estas capabilities para dichos binarios. 