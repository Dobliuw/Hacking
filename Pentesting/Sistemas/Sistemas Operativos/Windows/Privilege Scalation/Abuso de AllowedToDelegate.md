-----
- Tags: #ataque #teoria #practica #windows 
-----

# AllowedToDelegate

### El privilegio **AllowedToDelegate** (También conocido como **SeEnableDelegationPrivilege**) en Windows se refiere a un privilegio de seguridad que se puede asignar a una cuenta de usuario o grupo. Este privilegio permite que una cuenta delegue sus credenciales a otros servicios o sistemas en la red. 

### Cuando este privilegio es asignado a una cuenta, esta cuenta puede actuar como intermediario para la autenticación y la delegación de sus credencial4es a otros servicos o sistemas en la red. Esto significa que la cuenta puede proporcionar sus credenciales a otros servicios o sistemas para que puedan autenticarse en nombre de esa cuenta y realizar acciones en su nombre. 

-----

# Explotación 

### Al tener una cuenta con el privilegio **AllowedToDelegate** podríamos intentar impersonar a otro usuario como bien vimos, siendo así posible impersonar al usuario administrador para solicitar un ticket TGS el cual contiene el hash NTLM del usuario que lo solicita. 

### Para explotar esto, podríamos hacer uso de la herramienta **impacket-getST** para intentar obtener un ticket de servicio (TGS) para posteriormente solicitar acceso a un servicio específico dentro del AD. 

### La herramienta **getST** para abusar del privilegio **AllowedToDelegate** nos solicitará el **SPN (Service Principal Name)**, es decir el nombre (identificador) único del servicio al que se le desea solicitar el TGS.

### Para obtener esto, podríamos hacer uso de otra herramienta llamada **pywerview**, herramienta que se utiliza para enumerar y explotar acticos de Active Directory en entornos de Windows. 

```bash
pywerview get-netcompute -u '{username}' -t {target_ip} --full-data 
```

### Esto lo que hará es listar múltiple información dentro de ella una línea denominada "**msds-allowedtodelegateto:**" el cual será el nombre del SPN al que podremos solicitar el TGS. Una vez obtenido este, podemos proseguir con el ataque para solicitar un TGS.

```bash
impacket-getST -spn {spn_name} -impersonate Administrator {domain}/{username} -hashes :{NT_HASH}
```

### A la hora de ejecutar el ataque, puede ser que no funcione por no estar sincronizada la hora con el AD. Para sincronizar la hora podríamos instalar la herramienta **ntpdate** (apt install ntpdate). 

```bash
sudo ntpdate {target_IP}
sudo ntpdate -s {target_IP}
```

### Una vez sincronizado el tiempo de nuestra máquina de atacantes con el AD, podremos hacer uso otra vez del comando de **impacket-getST**. Una vez ejecutado exitosamente nos alojara en el directorio de trabajo el archivo **Administrator.ccache**, el cual usaremos para autenticarnos al sistema haciendo uso de la autenticación de kerberos, por lo que primero deberíamos exportar una variable de entorno llamada **KRB5CCNAME**.

```bash
export KRB5CCNAME=Administrator.ccache
```

### Una vez exportada, podríamos hacer uso de la herramienta **impacket-wmiexec**. WMI es una interfaz de administración de Windows que permite a los administradores gestionar y consultar información sobre los sistemas operativos Windows y los servicios que se ejecutan en ellos. Esta herramienta (wmiexec) aprovecha el protocolo WMI para ejecutar comandos y scripts en hosts remotos que admiten este protocolo. 

```bash
impacket-wmiexec {complete_name_dc} -k -no-pass
```

### Una vez ejecutado este comando, obtendriamos acceso al sistema como el usuario Administrador. 