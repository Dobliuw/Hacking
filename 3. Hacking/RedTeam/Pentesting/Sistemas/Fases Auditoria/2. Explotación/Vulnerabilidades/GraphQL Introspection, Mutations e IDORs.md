----
- Tags: #basico #teoria #practica #ataques 
----

# ¿ Que es **GraphQL** ? 

**GraphQL** es un lenguaje de consultas para **APIs (Application Programming Interfaces)** que se ha vuelto cada vez más popular en los últimos años. A diferencia de las APIs tradicionales que tiene endpoints fijos, GraphQL permite a los clientes solicitar sólo la información que necesita y obtener una respuesta personalizada en función de sus necesidades. 

----

# ¿ Que es **Introspection** ? 

**Introspection** en GraphQL es un mecanismo que permite a los clientes **obtener información** sobre el esquema GraphQL de una API. Esto significa que los clientes pueden explorar y descubrir los tipos de datos, los campos y las relaciones que existen en la API, lo que puede ser muy útil para los desarrolladores que necesitan construir clientes GraphQL. Sin embargo, la introspección también puede ser utilizada por los atacantes para obtener información sensible sobre la estructura y los datos que existen en la API, lo que puede ser utilizado para llevar a cabo ataques más sofisticados. 

----

# ¿ Que son las **Mutations** ? 

Las **Mutations** en GraphQL son operaciones que permiten a los clientes **modificar los datos** en la API. A diferencia de las consultas, que sólo permiten la lectura de los datos, las mutaciones permiten a los clientes agregar, actualizar o eliminar datos .Esto significa que las mutaciones tiene el potencial de ser utilizadas para realizar cambios importantes en la base de datos subyacente de la API. Si no se protegen adecuadamente, las mutaciones pueden ser explotadas por los atacantes para realizar cambios malintencionados en la API, como la eliminación de datos importantes o la creación de nuevos registros. 

----

# ¿ Que son los **IDORs** en GraphQL ? 

En el contexto de GraphQL, los [[IDORs - ( Insecure Direct Object Reference )]] pueden ocurrir cuando un atacantes es capaz de adivinar o enumerar identificadores (**IDs**) de objetos dentro de la API, y puede utilizar esos IDs para acceder a objetos a los que no debería tener acceso. Esto puede ocurrir porque los desarrolladores de la API pueden no haber implementado adecuadamente los mecanismos de autenticación y autorización en su API. 

------------

# Explotación 

- ## IDORs: 

Por ejemplo a la hora de explotar un [[IDORs - ( Insecure Direct Object Reference )]] en el contexto de GraphQL, se puede dar debido a una mala configuración de los desarrolladores permitiendo a un usuario enumerar información privada de otros usuarios, por ejemplo...

Nos encontramos en una aplicación en donde con una de las [[⚒ Herramientas ⚒]] de enumeración como **gobuster** encontramos una ruta, supongamos que */settings*, en esta lo que vemos es información de nuestra cuenta ( Estando logueados como un usuario ). Si interceptamos esta petición con [[Burpsuite]] veremos que se tramita una petición de tipo POST a una API de GraphQL en donde por body se envía algo tal que así: 

```json
{"query":"{ UserInfo (id: 43) {\n          \t\t\t\tapi_key\n          \t\t\t\tname\n          \t\t\t\tsurname\n          \t\t\t\tdate_of_birth\n        \t\t\t\t}\n      \t\t\t}\n        \t\t\t\t"}
```

Por lo que deducimos que se esta solicitando los campos **api_key, name, surname y date_of_birth** del user donde el **id** es **43**, por lo que este ID haría referencia a nuestro ID de usuario, por lo que si cambiamos dicho ID por el **1** u otros y recibo los datos de vuelta, estaríamos explotando un [[IDORs - ( Insecure Direct Object Reference )]] ya que como un usuario no debería poder tener acceso a datos personales de un usuario ajeno. 

----

- ## Introspection: 

En la **introspection** como mencionamos anteriormente, podemos **obtener información** acerca de la base de datos mediante peticiones de GraphQL, por lo que si viéramos como en el caso anterior, una petición que se lanza hacía una ruta **/graphql**, ya que esto no deja de ser una API podríamos ver si tenemos la posibilidad de ingresar a esta ruta para interactuar con el apartado de búsqueda de GraphQL: 

![[graphql.png]]

En donde, si hiciéramos uso de páginas como [Hack Tricks](https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/graphql) podríamos obtener querys para enumerar toda la información acerca de la base da datos  (Tablas, campos, etc) como la siguiente query: 

```json
fragment FullType on __Type {
  kind
  name
  description
  fields {
    name
    description
    args {
      ...InputValue
    }
    type {
      ...TypeRef
    }
  }
  inputFields {
    ...InputValue
  }
  interfaces {
    ...TypeRef
  }
  enumValues {
    name
    description
  }
  possibleTypes {
    ...TypeRef
  }
}

fragment InputValue on __InputValue {
  name
  description
  type {
    ...TypeRef
  }
  defaultValue
}

fragment TypeRef on __Type {
  kind
  name
  ofType {
    kind
    name
    ofType {
      kind
      name
      ofType {
        kind
        name
        ofType {
          kind
          name
          ofType {
            kind
            name
            ofType {
              kind
              name
              ofType {
                kind
                name
              }
            }
          }
        }hicieramos
      }
    }
  }
}

query IntrospectionQuery {
  __schema {
    queryType {
      name
    }
    mutationType {
      name
    }
    types {
      ...FullType
    }
    directives {
      name
      description
      locations
      args {
        ...InputValue
      }
    }
  }
}
```

#### PD: Esta query suele estar mal en **Hack Tricks** por lo que hay que modificar agregando __ en los apartados de **Type, InputValue y schema**. 

Una vez tengamos la respuesta de GraphQL con toda la información acerca de las base de datos, simplemente deberíamos copiar dicha información devuelta, para pasarla a un [proyecto de GitHub](https://github.com/graphql-kit/graphql-voyager) (El cual tiene [Live Mode](https://graphql-kit.com/graphql-voyager/)) donde podríamos ver de una manera más visual la administración de la/s base de dato/s: 

![[LiveMode_graphql-kit.png]]

Una vez entendida la administración de la/s base/s de dato/s, podríamos realizar peticiones más especificas para enumerar información sensible de usuarios, obtener contraseñas, ID's , etc. 

```json
# Si me interesara ver el ID, username y si es administrador en base al ejemplo anterior dado: 
{"query":"{Users{id, username, isAdmin}}"}
```

----

- ## Mutation: 

Por ultimo, como vimos, las **mutations** son interacciones con GraphQL que permiten al usuario modificar, agregar o eliminar datos, por ejemplo, si siguiendo el ejemplo dado tuviéramos un botón de crear post, en donde podríamos crear un "post" con un titulo, mensaje, etc. si lo interceptáramos con [[Burpsuite]] veríamos algo como lo siguiente: 

```json
{
	"query":"mutation { createPost(title: \"I'm the best hacker in this fucking life\", body: \"Bye\", author_id: 1) { id, title, body, author_id }}"
}
```

Podríamos probar alterar, en este caso, el ID para intentar crear un nuevo post como otro usuario, de esta manera estaríamos abusando de **mutations** para realizar acciones que no deberían estar permitidas. 