--- 
- Tags: #tools #ataques #reconocimiento #basico #web 
---

# **Nmap** y modos de escaneo: 

Con el comando `route -n` podemos ver la dirección ip de nuestro router, en el apartado de Gateway.

```shell
# Abrir manual de nmap.
man nmap 

# Escanear todos los rangos de puertos
nmap -p1-65535 {to_scan_ip}
namp -p- {to_scan_ip}

# Escanear los 500 puertos más comunes
nmap --top-ports 500 {to_scan_ip}

# Filtrar solo por aquellos puertos que esten abiertos, ignorando puerots filtrados. 
nmap -p- --open {to_scan_ip}

# Verbose para listar a medida que se vayan detectando puertos abiertos, los vaya reportando en tiempo de ejecución. 
nmap -p- --open -v {to_scan_ip}

# Quitar resolución DNS
nmap -p- --open -v -n {to_scan_ip}

# Seleccionar la plantilla de temporizado para agilizar el escaneo
nmap -p- -T5 --open -v -n {to_scan_ip}

# Tirar de TCP Connect Scan para intentar establecer conexión con el Three-Way Handshake, es decir tramitar un paquete SYN, para recibir o un paquete (RST -> closed) o un paquete (SYN/ACK -> open) para posteriormente establecer la conexión con un paquete ACK (established)
nmap -p- -T5 --open -sT -v -n {to_scan_ip} 

# Quitar el "HOST DISCOVERY" 
nmap -p- -T5 --open -sT -v -n -Pn {to_scan_ip}

# Para escanear los rangos de UDP
namp -p- --open -sU -v -n -Pn {to_scan_ip}

# Asi como con arp-scan -I eth0 --localnet, podemos ver los hosts que tenemos activos en nuestra red. Con nmap tambien 
nmap -sn {our_ip}/{cidr} 

# Tratar de detectar el sistema operativo
nmap -O {to_scan_ip}

# Tratar de detectar versión y servicios que corre para ciertos puertos
nmap -p22,80 -sCV {to_scan_ip}

# Evasión de Firewalls 
nmap -p22 -f {to_scan_ip}
nmap -p22 --mtu {num_multiplo_8} {to_scan_ip}
nmap -p22 -D 11.11.11.11 {to_scan_ip}
nmap -p22 --source-port 443 {to_scan_ip}
nmap -p22 --data-length 21 {to_scan_ip}
nmap -p22 --spoof-mac 00:11:22:33:44:55 {to_scan_ip}
nmap -p22 -sS {to_scan_ip}

# Exportar evidencia 
nmap -p22 -sCV {to_scan_ip} -oN {file_nmap_format} -oG {file_grep_format} -oX {file_xml_format}
# Puede ser util realizar esto ya que con herramientas como xsltproc podemos convertir el XML a HTML
# Para que se vea más lindo: https://github.com/honze-net/nmap-bootstrap-xsl
```

## Scripts de Nmap: 

Nmap trae consigo muchos scripts codeados en lua que se pueden usar: 

```shell 
# Localizar los scripts de nmap
locate .nse

# Indicar un script en concreto: 
nmap --script 

# Ver categorias existentes en nmap 
locate .nse | xargs grep categories | grep -oP '".*?"' | sort -u

# Fusionar categorias para no romper algo de producción puede ser muy importante por lo que podemos hacer uso de fusión de categorias, por ejemplo, si quisieramos lanzar scripts de categoria vuln para evitar conflictos podriamos requerir que tenga ademas la categoria safe
nmap --script="vuln and safe" -sV
nmap --script="vuln or safe" 
```

Y como siempre, tanto con wireshark como con tshark podriamos ponernos a ver que es lo que se tramita

1. `sudo tcpdump -i lo -w Captura.cap --localnet`

2. `tshark -r Captura.cap 2>/dev/null`

Ahora podriamos con el parametro -Y de tshark, comenzar a jugar con filtros: 

`tshark -r Captura.cap -Tjson 2>/dev/null` -> Para ver la respuesta en formato JSON
`tshark -r Captura.cap -Tfields -e tcp.payload 2>/dev/null` -> Para ver el campo "tcp.payload"
