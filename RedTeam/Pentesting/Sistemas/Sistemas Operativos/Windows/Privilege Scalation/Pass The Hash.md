----
- Tags: #teoria #practica #windows #basico 
- ------

# Hash NTLM (Net LAN Manager)

### En Windows, los **hashes** NTLM (NT LAN Manager) se utilizan para almacenar **las contraseñas de los usuarios**. En lugar de almacenar las contraseñas en texto plano, se generan hashes mediante una función criptográfica a partir de las contraseñas. Estos hashes son valores de longitud fija que representan las contraseñas originales de forma no reversible.

### El hash NTLM es el resultado de aplicar una función criptográfica al valor de la contraseña original utilizando el protocolo NTLM. Este hash se utiliza para autenticar a los usuarios en un sistema Windows. Cuando un usuario inicia sesión, su contraseña se convierte en un hash NTLM y se compara con el hash almacenado en la base de datos del sistema. Si coinciden, se permite el acceso.

### **Este hash puede ser utilizado para realizar un Pass The Hash tanto como para intentar crackearlo, ya que es el hash original al cual fue convertida la contraseña en texto claro.**

---

# Hash NTLMv2 o Net-NTLM 

### Por otro lado, el hash **NTLMv2** es el hash que se genera en cada autenticación cliente/servidor, por lo que no es un hash que se almacene, sino que dependerá de cada comunicación.

### **Este hash puede ser utilizado para intentar crackearlo.**

----

# Pass The Hash 

### **Pass The Hash** consiste en un ataque en el que básicamente si se conoce el hash NTLM de un usuario, y ese usuario tiene los suficientes privilegios en el sistema. Se puede tanto ejecutar comandos como obtener una shell en el equipo Windows, solo conociendo su hash. 

```bash
# Una vez obtenido un hash NTLM, ejemplo: 
"aad3b435b51404eeaad3b435b51404ee:e0fb1fb85756c24235ff238cbe81fe00"

# Ambas maneras son validas para llevar a cabo el Pass The Hash
impacket-psexec WORKGROUP/Administrator@{target_ip} -hashes :e0fb1fb85756c24235ff238cbe81fe00
impacket-psexec -hashes aad3b435b51404eeaad3b435b51404ee:e0fb1fb85756c24235ff238cbe81fe00 Administrator@{target_ip}
```

### De esta manera nos podríamos autenticar como el usuario administrador en la máquina windows sin proporcionar contraseña ya que en lugar de esta proporcionamos el **hash NTLM**. 

------
# Obtener hashes NT 

### Para realizar un **Pass The Hash** en caso de que tengamos privilegios y poder así intentar escalar privilegios, podríamos hacer uso de la herramienta **impacket-secretsdump** junto al archivo *system* y *sam* del sistema víctima. 

### El archivo **system** es un archivo del registro de Wndows que contiene información sobre la conifuración y ajustes del sistema, así como detalles osbre los controladores dde dispositivos y la configuración del hardware. 

### El archivo **sam (Security Accounts Manager)** es un archivo del registro de Windows, que conteiene las cuentas de usuario y las claves de seguridad drelacionadas con la autenticación en el sistema.

#### En la máquina victima:
```shell
reg save HKLM\system system
reg save HKLM\sam sam 

# HKLM = HKEY_LOCAL_MACHINE (Una clave de raíz del Registro Windows)
```

### Con la instrucción **reg save** estamos creando una copia de seguridad del contenido del archivo **system** y del archivo **sam**, para posteriormente descargarlo a nuestra máquina y así poder dumpear los hashes NT para realizar un **Pass The Hash**. 

#### En la máquina atacante:
```bash
impacket-secretsdump -sam {sam_file} -system {system_file} LOCAL
```

### Una vez ejecutado este comando, obtendremos una lista de todos los hashes NT de los usuarios registrados en la máquina victima. 

#### IMPORTATEN: Es importante tener en cuenta que esto volcará los hashes almacenados en la máquina, por lo que si estamos en un entorno de Active Directory hay que entender que no se estan volcando los hashes NT del Domain Controler. Para obtener los hashes de los usuarios del dominio de Active Directory habría que enfocarse en el archivo **NTDS.dit**. 

