-----
- Tags: #ataque #windows #basico #teoria #practica 
-----
# Kerberoasting 

### El **Kerberoasting** attack es una técnica utilizada para extraer contraseñas de cuentas de usuarios en un dominio de Windows que utiliza el protocolo de autenticación de [[Kerberos]].

### Kerberos permite a los usuarios autenticarse de forma segura en un dominio y recibir un "ticket" (TGS) que se puede utilizar para acceder a los recursos de la red. Los tickets de Kerberos están encriptados utilizando la clave de cifrado del servidor de dominio (NTLM). 

### En este ataque, el atacante aprovecha una debilidad en el proceso de autenticación de Kerberos para extraer contraseñas en forma de "hashes" de los tickets de servicio. Los tickets de servicio son tickets utilizados por servicios de dominio para autenticarse en otros sistemas dentro de la red. Estos tickets contienen información cifrada, incluyendo el nombre de la cuenta de servicio y un hash de la contraseña de la cuenta. 

### El atacante recopila los tickets de servicio de la red y luego los extrae para obtener los hashes de las contraseñas asociadas a las cuentas de servicio. Estos hashes pueden ser descifrados offline utilizando técnicas de cracking para obtener las contraseñas en texto plano. 

-----
# Explotación 

- ### **Identificación de usuarios con cuentas de servicio**: Para llevar a cabo un ataque de **Kerberoasting** es importante identificar cuentas de servicio en el dominio de Active Directory. Estas son cuentas de usuario especiales que se utilizan para ejecutar servicios en servidores y a menudo se configuran par aque puedan autenticarse en un dominio y solicitar TS (Ticket Service).

- ### **Solicitud de tíquets de serivicio**: Una vez que se identifican las cuentas de servicio, un atacante solicita tíckets de servicio para estas cuentas utilizando [[Kerberos]]. Estos tickets de servicio se cifran utilizando el hash **NTLM** de la contraseña del servicio.

- ### **Exfiltración de tickets cifrados**: Una vez que el atacante ha obtenido los tickets cifrados, estos se extraen del entorno de AD. El atacante puede realizar esto de manera discrea y sin despertar sospechas.

- ### **Ataque offile**: Una vez con los tickets cifrados en su posesión, el atacnte intenta descrifrar los hashes NTLM correspondientes a las contraseñas de los serivcios. Esto se hace de forma offline, lo que significa que el atacante puede probar diferentes contraseñas sin activar alarmas de seguridad en el entorno de AD.

- ### **Contraseñas débilles o vulnerables**: Si las contraseñas de los serivcios son débiles o vulnerables, el ataque **Kerberoasting** tendrá éxito y el atacante obtendrá las contraseañs reales en texto claro correspondinetes a las cuentas de servicio comprometidas.

- ### **Uso de las contraseñas obtenidas**: Con las contraseñas de servicio en su poder, el atacnte puede utilizarlas para acceder a sistemas y servicios adeicionales en el entorno, lo que puede conducir a un mayor compromiso de la red. 
# PoC
### Para obtener SPNs (Service Principal Names), es decir, cuentas de servicio, podemos hacer uso de herramientas como **imapcket-GetUserSPNs**, perteneciente a la suite de impacket (Conjunto de herramientas desarrolladas en python para tareas relacionadas con la explotación y analisis de protocolos y servicios de Windows y redes). Por ejemplo, una vez que tengamos credenciales válidas (Las cuales podrían ser validadas con herramientas como **crackmapexec**), podríamos plantearnos realizar un **Kerberoasting attack**. 

```bash
impacket-GetUserSPNs -request -dc-ip {dc_ip} {domain.full}/{username}:{password} -outputfile hashes.kerberos

impacket-GetUserSPNs -request -dc-ip {dc_ip} -hashes :{nt_hash} {domain}/{username} -outputfile hashes.kerberos
```
### En caso de que haya algun usuario vulnerable el cual sea detectado con la herramienta **impacket-GetUserSPNs** podríamos utilizar el parametro **-request** para solicitar un **TGS** y así posteriormente intentar crackear este. 

### Otro ejemplo, en caso de que tengamos un usuarios que dispongan de **UF_DONT_REQUEST_PREAUTH** podríamos hacer uso de otra version de impacket disponible en el respositorio de [ShutDown Impacket](https://github.com/ShutdownRepo/impacket.git), en donde podremos cambiarnos a la rama de **getuserspns-nopreauth** para hacer uso de la herramienta **GetUserSPNs** con la flag `-no-preauth`. 

```bash
GetUserSPNs.py {domain}/ -no-preauth "{user_with_UF_DONT_REQUEST_PERAUTH=true}" -usersfile {users.txt} -dc-ip {ip} -request
```
### De esta manera, al ejecutar el anterior comando estaremos intentando solicitar un **TGS** para todas los usuarios almacenados, aunque solo tendremos éxito en este ataque, es decir, recibir el TGS con el hash NTLM en su interior si el usuario es kerberoasteable (Que las credenciales están configuradas de manera que se almacenan).

-----
# Prevenir Kerberoasting Attack

- ### **Uso de contraseñas fuertes**: La primera línea de defensa es asegurarse de que todas las cuetnas de servicio tengan contraseñas fuertes y únicas. Esto hace que sea mucho más difícil para los atacantes realizar este ataque, ya que la contraseña es más difícil de descifrar.
- ### **Uso de contraseñas gestionadas**: En lugar de permitir que los administradores configuren manulamente contraseñas para cuentas de servicio, considere el uso de soluciones de gestión de contraseñase que generen y almacenen contraseñas de manera segura.
- ### **Rotación regular de contraseñas**: Implementar políticas de rotración de contraseñas para ceuntas de servicio. Cuanto más a menudo cambie las contraseñas, menor será el tiempo que un atacante potencial tendría para realizar este ataque.
- ### **Monitoreo ode actividad anómala**: Establecer sistemas de monitoreo y alerta que puedan detectar actividades inusuales en el AD, como intentos repetidos de acceso a ceutnas de servicio o acceso no autorizado a los registros de eventos de [[Kerberos]].
- ### **Uso de soluciones de seguridad avanzadas**: Considerara la implementación de soluciones de seguiridad avanzada que puedan detectar y prevenir este ataque mediante la detección de patrones de comportamiento inusuales o el monitoreo en tiempo real de la autenticación de [[Kerberos]].
- ### **Implementacipón de políticas de seguridad adecuadas**: Asegurarsse de que la organización tenga políticas de segurida bien definidas y qeu se sigan de manera consistente. Esto incluye el acceso a cuetnas de servicio y el uso de cuentas con privilegios elevados.