''-----
- Tags: #ataque #windows #basico #teoria #practica 
-----

# Kerberoasting 

### El **Kerberoasting** attack es una técnica utilizada para extraer contraseñas de cuentas de usuarios en un dominio de Windows que utiliza el protocolo de autenticación de Kerberos.

### Kerberos permite a los usuarios autenticarse de forma segura en un dominio y recibir un "ticket" (TGS) que se puede utilizar para acceder a los recursos de la red. Los tickets de Kerberos están encriptados utilizando la clave de cifrado del servidor de dominio (NTLM). 

### En este ataque, el atacante aprovecha una debilidad en el proceso de autenticación de Kerberos para extraer contraseñas en forma de "hashes" de los tickets de servicio. Los tickets de servicio son tickets utilizados por servicios de dominio para autenticarse en otros sistemas dentro de la red. Estos tickets contienen información cifrada, incluyendo el nombre de la cuenta de servicio y un hash de la contraseña de la cuenta. 

### El atacante recopila los tickets de servicio de la red y luego los extrae para obtener los hashes de las contraseñas asociadas a las cuentas de servicio. Estos hashes pueden ser descifrados offline utilizando técnicas de cracking para obtener las contraseñas en texto plano. 

-----

# Explotación 

### Una vez que tengamos credenciales válidas (Las cuales podrían ser validadas con herramientas como **crackmapexec**), podríamos plantearnos realizar un **Kerberoasting attack**. 

```bash
impacket-GetUserSPNs {domain}/{user}:{password}
```
### En caso de que haya algun usuario vulnerable el cual sea detectado con la herramienta **impacket-GetUserSPNs** podríamos utilizar el parametro **-request** par solicitar un **TGS** y así posteriormente intentar crackear este. 

### En caso de que querramos abusar de esto para usuarios que dispongan de **UF_DONT_REQUEST_PREAUTH** podríamos hacer uso de otra version de impacket disponible en el respositorio de [ShutDown Impacket](https://github.com/ShutdownRepo/impacket.git), en donde podremos cambiarnos a la rama de **getuserspns-nopreauth** para hacer uso de la herramienta **GetUserSPNs** con la flag `-no-preauth`. 

```bash
GetUserSPNs.py {domain}/ -no-preauth "{user_with_UF_DONT_REQUEST_PERAUTH=true}" -usersfile {users.txt} -dc-ip {ip} -request
```
### De esta manera, al ejecutar el anterior comando estaremos intentando solicitar un **TGS** para todas los usuarios almacenados, aunque solo tendremos éxito en este ataque, es decir, recibir el TGS con el hash NTLM en su interior si el usuario es kerberoasteable (Que las credenciales están configuradas de manera que se almacenan).