# .img Files

En infromática, los archivos `.img` generalmente refieren a **Imagén de disco**. Estas imágenes son copias exactas de un disco, como un CD, DVD o disco duro, y se utilizan para respaldar datos, instalar software o crear unidades virtuales. Estas se utilizan para almacenar la información de instalación de programas, habitualmente *Sistemas Operativos*, permitiendo instalar el software directamente desde este archivo.

----
# Getting the original .img

Una vez con el dispositivo *rooteado temporalmente* (Proceso descrito en [[3. Getting root]]) podremos obtener la imagen del slot activamente:

- Entrar al dispositivo.
```bash
adb shell
```

 - Copiar la `boot.img` original **dependiendo del slot en uso**.
```bash
# Get current slot
getprop ro.boot.slot_suffix # Reutrn _a or _b --> Eg. with _a
su
dd if=/dev/block/by-name/boot_a of=/sdcard/boot_og_a.img
dd if=/dev/block/by-name/vendor_boot_a of=/sdcard/vendorboot_og_a.img
exit
exit
```

> [!warning] Extraer ambos archivos dará como resultado tener nuestro arranque original, listo para extraer a nuestra PC y posteriormente parchear o mismo restaurar en cualquier momento.

- Finalmente extraer la `boot.img` original utiliada por el dispositivo.
```bash
adb pull /sdcard/boot_og_a.img
adb pull /sdcard/vendorboot_og_a.img
```

Una vez en este punto si reiniciamos el bootloader y el fastboot, quitaremos de RAM la `boot.img` modificada con *Magisk* temporal (`magisk_patched-29000_x4V69.img` en mi caso) y al entrar nuevamente a al shell de adb y tratar de obtener privilegios o ingresar a la app instalada en el dispositivo de Magisk, ya no debería mostrar una versión (*29.0* en mi caso) y debería mostrar *N/A*.

Si todo va bien, en este punto estaríamos por fin con la imagen original utilizada por nuestro dispositivo lista para modificar con Magisk y remplazar permitiendonos finalmente rootear nuestro dispositivo.

---
# Getting root by default

En los *Pixel 6* (Y en general con los dispositivos con particiiones A/B y Android 12+) el arranque está dividido entre:

- `boot_a` / `boot_b`: Contiene el kernel y, si el dispositivo lo usa, el ramdisk de arranque.
- `vendor_boot_a` / `vendor_boot_b`: Contiene un ramdisk adicional con partes de los controladores, recovery, y otros binarios críticos para el arranque.

Magisk normalmente solo parchea `boot.img`, pero si el dispositivo no tiene ramdisk en bot (O el ramdisk principal está en `vendor_boot`), entonces hay que parechear este archivo también.

Una vez teniendo la "copia de respaldo" de las `.img` originales de nuestro dispositivo, deberemos subir a nuestro dispositivo estas, para hacer uso de Magisk y parchear ambas.

```bash
adb push boot_x.img /sdcard/Documents
adb push vendor_boot_x.img /sdcard/Documents
```

En este punto repetiremos el proceso antes llevado a cabo para obtener root temporal en una imagen base descargada de Google Factory, solo que en este caso son las imagenes originales de nuestro dispositivo que buscamos posteriormente instalar de manera por defecto para que siempre que arranque el dispositivo lo haga con estas y tengamos root completo del dispositivo.

Una vez instalado Magisk en ambas imagenes, solo queda traerlas a nuestra PC para cargarlas con fastboot. 

> [!warning] No olviden identificar tras cada instalación de Magisk en las imagenes originales cual corresponde a **boot_x** y cual a **vendor_boot_x**, ya que magisk reseteará el nombre de estas y deberán recordar cual es cual.

```bash
adb pull /storage/emulated/0/Download/magisk_patched-XXXXX_XXXXX.img ./boot_x_rooted.img
adb pull /storage/emulated/0/Download/magisk_patched-XXXXX_XXXXX.img ./vendor_boot_x_rooted.img
```

Una vez en este punto, con las *dos imagenes originales parcheadas con Magisk*, deberemos nuevamente poner el dispositivo movil en **fastboot mode**: 

```bash
adb reboot bootloader
```

Posteriormente:

- Si solo parchamos con Magisk `boot_x` : 
```bash
fastboot flash boot_x boot_x_rooted.img
```

- Si también parchamos con Magis `vendor_boot_x`:
```bash
fastboot flash boot_x boot_x_rooted.img
fastboot flash vendor_boot_x vendor_boot_x_rooted.img
```

> [!warning] Es importante utilizar `_a` o `_b` según nuestro slot activo, en este podríamos re-validarlo con el comando:
> 
> ```bash
> fastboot getvar current-slot
> ```

Igualmente podríamos *instalar* la versión rooteada del dispositivo en *ambos slots* para *mantener root* incluso si Android cambia de slot:

```bash
fastboot flash boot_a boot_x_rooted.img
fastboot flash vendor_boot_a vendor_boot_x_rooted.img
fastboot flash boot_b boot_x_rooted.img
fastboot flash vendor_boot_b vendor_boot_x_rooted.img
```

Luego, solo quedaría reiniciar y verificar si tenemos el dispositivo correctamente rooteado.

- Reiniciar.
```bash
fastboot reboot
```

- Verificar si tenemos acceso root.
```bash
adb shell
```

- El comand `whoami` luego de la ejecución de `su` debería devolver correctamente **root**. 
> [!warning]  Esto podría solicitarnos permiso mediante un popup en nuestro dispositivo.

```bash
su
whoami 
```

Adicionalmente, al igual que cuando obtuvimos root temporalmente, si nos dirigimos a la app de Magisk, deberíamos ver una versión instalada.