---

---
--------------------
- Tags: #teoria #practica #blue #analysis #malware
-----------
# Malware 

Un programa malicioso (**Malware**) es cualquier tipo de sogtware que realiza acciones dañinas en un sistema informático de forma intencionada y sin el concentimiento del usuario. 

-----
# Entorno de análisis de Malware

Para analizar y trabajar con malware, es importante tener en cuenta que es una actividad muy riesgosa, la cual puede conllevar a múltiples peligros como usuario, desde persistencia, commands and controls, etc. por lo que para análizar muestras de malware haremos uso de un entorno de análisis el cual permitira por un lado analizar el comportamiento del host tras la detonación del malware, como por otro, simular la red para recibir las peticiones que realize el malware.

En este entorno haremos uso de dos máquinas virtuales aisladas de la red principal para no poner en riesgo la máquina host, este entorno contará de dos máquinas virtuales con conexión entre si donde una tendrá el sistema operativo Windows 10 x64 bits a la cual se le instalará Flare-VM y por otro lado, una máquina Linux que contará acon [remnux](https://remnux.org/).

### Linux (Remnux)

**Remnux** es un popular kit de herramientas basado en Linux para analizar software malicioso de ingeniería inversa en el que los analistas de malware han estado confiando durante mucho tiempo para ayudarlos a investigar rápidamente programas sospechosos, sitios web y ficheros o archivos de documentos.
###### Instalación de Remmux

En esta caso la instalación consta en dirigirnos al [sitio oficial de descarga](https://remnux.org/) para descargar el **OVA** el cual posteriormente será utilizado para crear una máquina virtual en nuestro gestor de máquinas virtuales favorito.

### Windows 10 (Flare-VM)

**Flare-VM** es una suite de scripts de instalación de software para sistemas Windows que permite configurar y mantener fácilmente un entorno de ingeniería inversa en una máquina virtual. Esta suite incluye una variedad de herramientas y software preinstalado que los investigadores de seguridad y analistas de malware pueden utilizar para analizar, depurar y desmontar programas maliciosos, así como para investigar incidentes de seguridad en sistemas Windows. 
###### Instalación de Flare-VM

En este caso la instalación es un poco más extensa, primero que nada nos tenemos que descargar una **.iso** de un sistema Windows x64 bits, una vez descargada procederiamos a crear una máquina virtual haciendo uso de esta imagen iso y de nuestras configuraciones favoritas, una vez terminado este proceso continuariamos con los comandos a ejecutar.

De cara a los comandos a ejecutar son múltiples, los cuales ejecutaremos en una *PowerShell* como usuario administrador.

```powershell
# Install VCLibs
wget https://aka.ms/Microsoft.VCLibs.x64.14.00.Desktop.appx -usebasicparsing -o VCLibs.appx

# Install Windows Terminal MSIX bundle
wget https://github.com/microsoft/terminal/releases/download/v1.15.3465.0/Microsoft.WindowsTerminal_Win10_1.15.3465.0_8wekyb3d8bbwe.msixbundle -UseBasicParsing -o winterminal.msixbundle

# Add the VClibs package
Add-AppxPackage [C:\path\to\downloaded\VCLibs.appx]

# Add the Windows terminal MSIX bundle package
Add-AppxPackage [C:\path\to\downloaded\winterminal.msixbundle]
```

Una vez realizada la instalación de los paquetes anteriores y habiendolos agregado, procederemos con la **desactivación** de la opción **Automatically detect settings** en el apartado de **proxy settings**. Así mismo también deberemos desactivar el **Windows Defender**, para esto seguiremos los siguientes pasos.

- Buscar **Defender** en la barra de tareas, ingresar en las **configuraciones** del Windows Defender y cambiar a **off** todas las opciones del Defender.
- Para deshabilitar el Defender en el GPO nos dirigimos a **group policy** en la barra de tareas, posteriormente, una vez en el GPO nos dirigimos a -> **Administrative Templates** -> **Windows Componentes** -> **Microsoft Defender Antivirus** -> Enable **Turn off Microsoft Defender Antivirus**. 

Una vez hecho esto, procederemos a deshabilitar el **Windows Firewall**. para esto seguiremos los siguientes pasos.

- Buscar **group policy** en la barra de tareas, posteriormente, una vez en el GPO nos dirigimos a -> **Administrative Templates** -> **Network** -> **Network Connections** -> **Windows Defender Firewall** -> *Domain Profile* -> Deshabilitar **Protect All Network Connections**. Este proceso también deberá ser repetido para el *Standar Profile*.

En este punto, se recomendaría realizar una **SNAPCHOT** de nuestra máquina virtual con las configuraciones aplicadas.

Posterior a esto, continuaremos con la descarga de *Flare-VM*. 

```powershell
# In the Desktop -> Install FLARE-VM
(New-Object net.webclient).DownloadFile('https://raw.githubusercontent.com/mandiant/flare-vm/main/install.ps1',"$([Environment]::GetFolderPath("Desktop"))\install.ps1")

Unblock-File .\install.ps1

Set-ExecutionPolicy Unrestricted

# Accept the prompt to set the ExecPol to unrestricted if one appears

.\install.ps1 -customConfig https://raw.githubusercontent.com/HuskyHacks/PMAT-labs/main/config.xml
```

Una vez ejecutados estos comandos, contunaremos hasta que finalize la instalación y una vez finalizada la misma, tomaremos otra **SNAPCHOT** con las configuraciones aplicadas a la par que la resiente *Flare-VM* instalada y configurada. 
## Network Setup 

Como se menciono anteriormente, en este caso es de vital importancia que este entorno de análisis de malware se encuentre totalmente aislado sin conexión con nuestro host, por lo que la configuración de la red del mismo es clave para tener un entorno seguro. En este caso deberemos verificar y configurar que ninguna de las dos máquinas virtuales que conforman nuestro entorno se encuentren en modo *Bridged*, pero si crear una red (Esto será diferente según nuestro gestor de máquinas virtuales) en la cual ingresemos un segmento de red que diferencia a simple vista nuestra red local e ingresar ambas máquinas a esta nueva red creada.

![[network_setup_malware_analysis.png]]

En este caso se puede apreciar que además de nuestra red, se creo una (*VMnet1*) la cual tiene un segmento de red que nos permite diferenciar de manera rápida la red de nuestra red local. Así mismo, tanto la máquina **Windows** (**Flare-VM**) como la máquina **Linux** (**Remnux**) fueron agregadas a esta red *VMnet1* la cual no tiene conectividad con la red del host principal.
###### Fake Internet Setup

En este caso, como se menciono anteriormente la máquina Windows nos permitirá análizar que ocurre con esta cuando el malware es detonado, mientras que la máquina Linux funcionará como un **Fake Internet** permitiendonos recibir todas las peticiones que se realizen a nivel de red, ya sea HTTP, DNS, etc.

Para esto es importante configurar el software proveniente con **remnux** que nos permitirá realizar esto, por lo que en nuestra máquina Linux ejecutaremos los siguientes comandos. 

```bash
sudo nano /etc/inetsim/inetsim.conf
```

En este caso nos intereza realizar algunos cambios en la configuración de la herramienta que utilizaremos (**inetsim**).

- Descomentar la línea que se encarga de levantar el servidor DNS. (**#start_service dns**)
- Modificar la