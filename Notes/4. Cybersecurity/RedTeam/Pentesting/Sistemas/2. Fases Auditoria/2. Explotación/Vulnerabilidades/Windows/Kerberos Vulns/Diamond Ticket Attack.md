------
- Tags: #toeria #practica #ataque 
-----
# [Diamond Ticket Attack](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/diamond-ticket)
El ataque **Diamond Ticket** así como el [[Golden Ticket Attack]], permite obtener acceso a cualquier servicio como cualquier usuario. El **Golden Ticket** se falsifica completamente fuera de línea, se cifra con el hash krbtgt de ese dominio y luego se pasa a una sesión de inicio de sesión para su uso. El problema es que existen dos técnicas habituales para detectar el uso de **golden tickets** y es por la busqueda de **TGS-REQ** que no tengan **AS-REQ** (Mirar [[KERBEROS_AUTHETICATION_FLOW]]) o buscando **TGT** que tengan valores 'tontos' como vida útil predeterminada de 10 años de **Mimikatz**. 
Ahora... un **diamond ticket** se genera modificando los campos de un TGT legítimo emitido por un DC. Esto se logra solicitando un TGT, descifrándolo con el hash krbtgt del dominio, modificando los campos deseados del ticket y luego volviéndolo a cifrar. Esto supera las dos deficiencias del [[Golden Ticket Attack]]. Dado que el TGT es legítimo, tiene un AS-REQ previo así como al haber sido emitido por el DC, tendrá todos los detalles correctos.

----
# Explotación 

- ### **Recolección de Información**: En el ataque Diamond Ticket, el atacante comienza recopilando información crítica sobre la infraestructura de red del objetivo. Esto puede incluir la obtención del Hash NT de la cuenta **KRBTGT** en el Domain Controller, que es **esencial** para generar el Diamond Ticket.

- ### **Obtención de Credenciales**: Para generar un Diamond Ticket, el atacante debe obtener el **hash NT del KRBTGT** y otros datos sensibles del entorno, similar al Golden Ticket. Esto puede lograrse mediante técnicas como el robo de credenciales a través de herramientas como **Mimikatz** o mediante la explotación de vulnerabilidades.

- ### **Generación del Diamond Ticket**: Con el hash NT del KRBTGT y otros datos recopilados, el atacante utiliza herramientas especializadas para crear un Diamond Ticket. Este ticket forjado se firma criptográficamente y es prácticamente indistinguible de un TGT legítimo, al igual que en el Golden Ticket Attack.

- ### **Persistencia y Acceso Ilimitado**: Igual al Golden Ticket, el Diamond Ticket generado por el atacante tiene una vida útil larga y se puede utilizar de manera persistente. Proporciona acceso ilimitado a la red y a todos los recursos protegidos por el sistema de autenticación Kerberos, incluyendo servidores, sistemas de almacenamiento y otros recursos.

---
# PoC
Por ejemplo, supongamos que tenemos acceso al sistema víctima, en donde contamos con **rubeus** (Herramienta para realizar ataques y pruebas de penetración en Windows, con gran capacidad de llevar a cabo ataques y tareas relacionadas con [[Kerberos]]), con esta herramienta podemos llevar acabo un **Diamond Ticket Attack**.
Primero podríamos obtener el RID del usuario.

```bash
powershell Get-DomainUser -Identity <username> -Properties objectsid
```
Posteriormente hacer uso de **rubeus** para llevar a cabo este ataque. 

```bash
.\Rubeus.exe diamond /tgtdeleg /ticketuser:{username} /ticketuserid:{RID_username} /groups:512

# /tgtdeleg uses the Kerberos GSS-API to obtain a useable TGT for the user without needing to know their password, NTLM/AES hash, or elevation on the host.
# /ticketuser is the username of the principal to impersonate.
# /ticketuserid is the domain RID of that principal.
# /groups are the desired group RIDs (512 being Domain Admins).
# /krbkey is the krbtgt AES256 hash.
```

