# ¿ Que es el **Padding Oracle** ? 

Este ataque es un ataque contra datos cifrados que permite al atacante **descifrar** el contenido de los datos **sin conocer la clave**. 

Un "**oráculo**"  hacer referencia a una "indicación" que brinda a un atacante información sobre si la acción que ejecuta es correcta o no. 

El "**relleno**" es un término criptográfico especifico. Algunos cifrados, que son los algoritmos que se usan para cifrar los datos, funcionan en *bloques de datos* en los que cada bloque tiene un tamaño fijo. Si los datos que deseas cifrar no tienen el tamaño adecuado para rellenar los bloques, los datos se **rellenan** automáticamente hasta que lo hacen. Muchas formas de relleno requieren que este siempre esté presente, incluso si la entrada original tenía el tamaño correcto. Esto permite que el relleno siempre se quite de manera segura tras el descrifrado. 


Como dijimos, el padding no deja de ser relleno para completar un bloque de datos, de manera que, para que el contenido del mismo sea adecuado, se agrega un relleno en proporción a los bits faltantes con una tecnica denominada **PKCS7**.  De manera que si faltan 5 bits para completar el bloque se rellenarian los 5 espacios con "0x05"


Al combinar ambos elementos, una implementeación de software con un oráculo de relleno revela si los datos descrifrados tienen un relleno válido. El oráculo podría ser algo tan sencillo como devolver un valor que dice "Relleno no válido", o bien algo más complicado como tomar un tiempo considerablemente diferente para procesar un bloque válido en lugar de uno no válido. 

Los cifrados basados en bloques tienen otra propiedad, denominada "**modo**", que determina la relación de los datos del primer bloque con los datos del segundo bloque, y así sucesivamente. Uno de los modos más usados es **CBC**. Este representa un bloque aleatorio inicila, conocido como "**vector de inicialización (IV)**" (bloque de bits que se utiliza para cifrar el primer bloque de texto plano de un mensaje), y combina el bloque anterior con el resultado del cifrado estático a fin de que cifrar el mismo mensaje con la misma clave no siempre genere la misma salidad cifrada.

![[cbc.png]]


Un atacante puede usar un oráculo de relleno, en combinación con la manera de estrucutrar los datos de CBC, para enviar mensajes ligeramente modificados al código que expone el oráculo y seguir enviando datos hasta que el oráculo indique que son correctos. Desde esta respuesta, el atacante puede descifrar el mensaje byte a byte. 

Las redes informáticas modernas son de una calidad tan alta que un atacante puede detectar diferencias muy pequeñas (menos de 0,1 ms) en el timepo de ejecución en istemas remotos. Las aplicaciones que suponen que un descrifrado correcto solo puede ocurrir cuando no se alteran los datos pueden resultar vulnerables a ataques desde herramientas que están diseñadas para observar diferencias en el descrifrado correcto e incorrecto. Si bien esta diferencia de temporalización puede ser más significativa en algunos lenguajes o bibliotecas que en otros, ahora se cree que se trata de una amenaza práctica para todos los lenguajes y las bibliotecas cuando se tien en cuenta la respuesta de la aplicación ante el error. 

----

# Explotación 

Para poder explotar esto, primero hay que terminar de tener bien en claro que es lo que esta pasando [[CBC_padding]]. 

 Ahora, para explotar esto, podria ser mediante una cookie de sesión, en donde todo el proceso de la comparación *XOR* se vera automatizado por una [[Tools]] llamada *padbuster*, en la cual deberemos ingresar la url, el ejemplo del texto cifrado, el tamaño del bloque (multiplos de 8) y opciones adicionales. 

```shell
padbuseter http://192.168.1.39 S3HDJbyq%2BtCPkqTGexIT1czwPA9q4ym8 8 -cookies 'auth=S3HDJbyq%2BtCPkqTGexIT1czwPA9q4ym8' 
```

De esta manera la herramienta comenzara a descifrar el texto encriptado ingresado 'S3HDJbyq%2BtCPkqTGexIT1czwPA9q4ym8' (el cual se encuentra en la url de sesión) 

Una vez roto nos dara el valor, por ejemplo **auth=dobliuw**, haciendo uso de esta misma herramienta, aprovechando de que logramos desencriptar el valor, podremos encriptar lo que deseemos, por ejemplo **auth=admin**

```shell
padbuster http://192.168.1.39 S3HDJbyq%2BtCPkqTGexIT1czwPA9q4ym8 8 -cookies 'auth=S3HDJbyq%2BtCPkqTGexIT1czwPA9q4ym8' -plaintext 'auth=admin'
```

Lo que nos arrojara un valor encriptado que podriamos usar como cookie para de esta manera, realizar un **cookie hijacking**. 

Algo que se podria tener en cuenta que podriamos realizar es un ataque de tipo sniper con [[Burpsuite]] para haciendo uso de payload de tipo **bit flipper** filtrar bytes para que, por ejemplo, estando logeados como usuario *bdmin*, comenzar a variar algunos bytes hasta quedar logueados como admin. 



