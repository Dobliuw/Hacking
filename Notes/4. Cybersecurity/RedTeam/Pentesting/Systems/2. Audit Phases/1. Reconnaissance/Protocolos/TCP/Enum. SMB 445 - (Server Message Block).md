# Server Message Block 

El protocolo **SMB** (**Server Message Block**) es un protocolo de red que permite compartir archivos, impresoras, etc. entre nodos de una red de computadoras que usan el sistema operativo Microsoft Windows. 

---
# Diferencias entre SMB, NetBIOS y Microsoft-DS

- *NetBIOS*: Como podemos ver en [[Enum. NetBIOS 137]], este es un protocolo antiguo de redes quer permite que aplicaciones en diferentes computadoras se comuniquen dentro de una red local.
- *SMB*: Protocolo de transferencia de archivos a través de red que permite a las aplicaciones leer y escribir en archivos y solicitar servicios de programas de servidor en una red.
- *Microsoft-DS*: Se refeiere a **SMB** ejecutandose directamente sobre TCP/IP sin necesidad de NetBIOS, normalmente utilizado sobre el puerto 445. Es una aprte integral de las redes de Windows para compartir archivos e impresoras, entre otros servicios.


-----
# Reconocimiento 

Como sabemos lo primordial de cara a una auditoria de seguridad es el proceso de reconocimiento, muchas veces nos enfrentaremos a sistemas los cuales tengan el puerto **445** expuesto corriento el protoclo **SMB** el cual nos puede ser una gran fuente de información en el mejor de los casos privilegiada. 

Alguna de las herramientas más utilizadas para enumerar este protocolo son `crackmapexec`, `smbmap` y `smbclient`. 

- ## Enumeración con crackmapexec
#### Instalación
```bash
apt-get install -y libssl-dev libffi-dev python-dev-is-python3 build-essential
git clone https://github.com/mpgn/CrackMapExec
cd CrackMapExec
poetry install
poetry run crackmapexec
```
#### Enumeración 
```bash
crackmapexec smb {target_ip}
# Intentar listar información de la máquina victima, como nombre de la máquina, dominios, version de windows, etc. 
crackmapexec smb {target_ip} --shares
# Intentar listar recursos compartidos a nivel de red. 
crackmapexec smb {target_ip} -u 'kjdshgfkashgkj' -p '' --shares
# Intentar listar recursos compartidos como invitado
```
##### También podríamos utilizar **crackmapexec** para la validación tanto de **credenciales** como **hashes NT**. 
#### Validación de credenciales
```bash
crackmapexec smb {target_ip} -u '{username}' -p '{password}'
# Validar credenciales
crackmapexec smb {target_ip} -u '{username}' -H '{hash_NT}'
# Validar credencailes con el hash NT

crackmapexec winrm {target_ip} -u '{username}' -p/-H '{passowrd/hash_NT}'
# También se podrían validar dichas credenciales de cara a winrm 
# (Si el usuario pertenece al grupo REMOTE MANAGEMENTE USERS y las credenciales son válidas tendríamos acceso al sistema)
```
#### Intentar conseguir usuarios
```bash
crackmapexec smb {domain} -u 'dgadg' -p '' --rid-brute
# Intentar conseguir una potencial lista de usuarios haciendo uso de la conexión como invitado
```
##### Otra cosa para la que nos sirve **crackmapexec** es para realizar ataques de fuerza bruta de usuarios, contraseñas, etc.

#### Ataques de fuerza bruta
```bash
crackmapexec smb {target_ip} -u {users_dictionary.txt} -p "{password}" --continue-on-success
# Fuerza bruta para una lista de usuarios haciendo uso de una contraseña
crackmapexec smb {domain} -u {users_dictionary.txt} -p '' --continue-on-success
# Intentar loguearse sin contraseña con una potencial lista de usuarios
crackmapexec smb {domain} -u {users_dictionary.txt} -p {users_dictionary.txt} --no-bruteforce --continue-on-success
# Probar cada usuario de una lista con el mismo nombre de usuario como contraseña
```

- ## Enumeración con smbmap 
#### Enumeración 
```bash
smbmap -H {target_ip} -u "null"
# Intentar lilstar recursos compartidos a nivel de red haciendo uso de una NULL sesion (Para cuando no disponemos de credenciales)
smbmap -H {target_ip} -u '{username}' -p 'password'
# Listar recursos compartidos a nivel de red en caso de tener credenciales.

-r {$SHARE_NAME}
# Esta opción la podemos utilizar para listar un recurso compartido de manera recursiva.

--download {$SHARE_NAME/$FILE}
# Esta opción la podemos utilizar para descargar un recurso del recurso compartido a nivel de red. 
```

- ## Enumeración son smbclient 
#### Enumeración 
```bash
smblicent -L {target_ip} -N
# Intentar listar los recursos compartidos a nivel de red haciendo uso de una NULL session 
smbclient \\\\{target_ip}\\{shared_folder_name} -U '{username%password}'
# Conectarse a un recurso compartido a nivel de red haciendo uso de credenciales 
smbclient //{target_ip}/{shared_folder_name} -N 
# Listar un recurso compartido en particular disponiendo de una NULL session
smbclient 'asdfdafad@{computer_name}.{domain}' -no-pass
# Intentar conectarse como un usuario inexistente sin proporcionar contraseña
```

----
Es importante tener en cuenta que durante la enumeración, en caso de tener acceso a recursos compartidos a nivel de red, estos pueden ser muy dificiles de inspeccionar debido a que podrían contener mucha información, directorios, archvios, etc. En estos casos suele ser recomendable jugar con monturas para montar todo el contenido de uno de estos recursos compartidos a nivel de red para volcar el contenido en un path del sistema que querramos y así poder jugar con utilidades como **tree** las cuales nos permiten de una manera más visual y ordenada hacernos una idea de la distribución del cotenido. 

```bash
sudo apt install cifs-utils
# Instalar las dependencias necesarias para poder utilizar esto.

mount -t cifs //{target_ip}/{$SHARE_FOLDER} {/our/path}
# Intentar montar el recurso compartido a nivel de red seleccionado en una ruta específica

mount -t cifs //{target_ip}/{$SHARE_FOLDER} {/out/path} username=null,password=null,domain=,rw
# Intentar montar el recurso compartido a nivel de red seleccionado en una ruta específica (Manera alternativa)

mount -t cifs //{target_ip}/{$SHARE_FOLDER} {/out/path} -o username='{username}',password='{password}',rw
# Montar el recurso compartido a nivel de red en una ruta especifica

umount {/our/path}
# Demonstar la montura 
```

Para listar los permisos de carpetas alojadas en un recurso compartido, podríamos hacer uso de herramientas como **smbcacls**. 

```bash
smbcacls "//{taget_ip}/{share_folder}" {Path/to/File_or_Folder} -N 
# Intentarlistar los permisos de una carpeta o archivo haciendo uso de una NULL Sesion.
```

