# WinRM - (Windows Remote Management)

La Administración remota de Windows o **WinRM** es la implementación de Microsoft del protocolo **WS-Management**, que es un protocolo estándar basado en el Protocolo Simple de Acceso a Objetos (SOAP), que permite la interoperación entre hardware y sistemas operativos de diferentes proveedores.

-----
# Conexión a WinRM

De cara a auditorias de seguridad, puede ser que nos encontremos trás realizar, por ejemplo, una [[Enum. LDAP 389 & 636 - ( Lighweight Directory Access Protocol )]] con usuarios que forman parte del **Remote Management Users**, siendo los usuarios pertenecientes a este grupo quienes pueden concetarse a través de herramientas como **evil-winrm** para conseguir [[RCE - (Remote Command Execution)]]. 

En caso de que contemos con credenciales, podríamos validar si estas son válidas con herramientas como **crackmapexec**

```bash
crackmapexec winrm -u "{username}" -p "{password}" {target_ip}
```

En caso de que obtengamos un **Pwned** quiere decir no solo que las credenciales con la que contamos son válidas, si no también de que el usuario pertenece al grupo **Remote Management Users**. Puediendonos conectarnos así con estas de manera remota a nuestro equipo víctima.

```bash
evil-winrm -i {target_ip} -u "{useranme}" -p "{password}" 
```

-----
# WinRM a través de HTTPS

El propósito de configurar **WinRM** para **HTTPS** es cifrar los datos que se envían a través de la conexión. HTTPS de WinRM requiere un certificado de autenticación de servidor del equipo local con un CN que coincida con el nombre de host que se va a instalar. El certificado no debe expirar, revorcase ni ser autofirmado.

En auditorias en las cuales contamos por ejmplo con el puerto *5986*, en donde intuimos que se trata de WinRM haciendo uso de HTTPS, sabemos que necesitamos un certificado, por lo que en caso de no haber dado con este, podríamos (En caso de que tengamos una web HTTP o HTTPS y que sea un IIS) hacer uso de wordlists como **/usr/share/seclists/Discovery/Web-Content/IIS.fuzz.txt** para enumerar la web y en el mejor de los casos, dar con un certificado.cer.

Por ejemplo, supongamos que la página expuesta expone **Microsoft Active Directory Certificate Services (AD CS)** es un rol de Windows Server que permite el uso y manejo de infraestructura Public Key. De esta manera podríamos crear una clave privada a la par que la solicitud de un certificado.

```bash
openssl req -newkey rsa:2048 -nodes -keyout {user}.key -out {user}.csr
```

De esta manera, tendriamos para un determinado usuario, su clave privada en el archivo **.key** y la solicitud del certificado en el archivo **.csr** en donde haciendo uso de este último podríamos solicitar la clave pública al **AD CS**. 

```bash
cat {user}.csr | xclip -sel clip
```

Una vez pegado en el creador del ceritficado, lo podremos descargar y una vez descargado conectar mediante **evil-winrm** haciendo uso de **ssl**. 

```bash
evil-winrm -S -c {file_donwloaded}.cer -k {user}.key -i {target_ip} -u '{username}' -p '{password}'
```

Una vez introducido este comando, nos conectariamos de manera remota haciendo uso de **WinRM** a través de **HTTPS**.


