# Lighweight Directory Access Protocol 

El protocolo LDAP o **protocolo ligero de acceso a directorios** es un protocolo a nivel de aplicación que permite el acceso a un servicio de directorio ordenado y distrubido para buscar diversa información en un entorno de red. 

En este contexto, el significado de *directorio* no es más que el de una *base de datos optimizada para búsquedas rápidas y consultas jerárquicas*. Se utiliza para almacenar información estructurada, como usuarios, grupos, dispositivos, permisos, etc. Un ejemplo clásico es [[Active Directory]] de Microsoft, que implementa este protocolo, **LDAP**.

Un ejempo de la visualización de la jerarquía:

```sql
dc=dobliuw,dc=com
|___ ou=People
|	  |_ cn=Owen Bonoris
|	  |	  |_ uid=obonoris
|	  |	  |_ mail=dobliuw@dobliuw.com
|	  |	  |_ memberOf=cn=Admins,ou=Groups,dc=dobliuw,dc=com
|	  |_ cn=John Due
|		  |_ uid=jdoe
|		  |_ mail=jdoe@dobliuw.com
|		  |_ memberOf=cn=Users,ou=Groups,dc=dobliuw,dc=com
|___ ou=Groups
	  |_ cn=Admins
	  |_ cn=Users
```

- `dc` = Domain Component (dobliuw.com).
- `ou` = Organizational Unit (Carpetas lógicas: People, Groups).
- `cn` = Common Name (Entradas individuales: usuarios, grupos).

> [!warning] LDAP is of Interest
> Este protocolo de cara a red team es de gran interes para: 
> - **Enumeración** (Descrita en este artículo): Obtención de nombres de usuarios, grupos y máquinas en un dominio.
> - [[LDAP Injections]]: Explotar consultas LDAP mal sanitizadas en posibles aplicaciones web que integren este protocolo.
> - [[Active Directory]]: Conocer LDAP es esencial para entender cómo se autentican usuarios, cómo funcionan los grupos y cómo se hace *lateral movement* en redes Windows.

-----
# Reconocimiento

De cara a una auditoria de seguridad es muy importate la enumeración, y el protocolo **LDAP** puede ser una muy buena fuente de información, en caso de que podamos enumerarlo. 
#### Enumeración con ldapsearch
```shell
ldapsearch -H "ldap://{target_ip}" -x -s base namingcontexts
# Enumerar servicio ldap, en este caso, namingcontexts
ldapsearch -H "ldap://{target_ip}" -x -b {naming_context}
# Enumerar el servicio ldap
ldapsearch -H ldap://{target_ip}/ -x -D 'user@domain' -w 'password' -b "DC=subdomain,DC=tld"
# Corroborar credenciales validas
ldapsearch -H ldaps://{target_ip}/ -x -s base -b '' "(objectClass=*)" "*" +  
# Anonymous access
```
#### Enumeración con nmap 
```bash
nmap -n -sV --script "ldap* and not brute" -p 389 {target_ip}
```
#### Enumeración con ldapdomaindump
```bash
cd /var/www/html 
ldapdomaindump -u '{domain}\{username}' -p '{password}' {target_ip}
sudo systemctl start apache2 
```
De esta manera, estamos volcando toda la información recopilada por la herramienta dentro de **/var/www/html** y al levantar el servicio de apache, si nos dirigimos al **localhost** tendremós  información en formato HTML.

Adicionalmente, podemos encontrar más información sobre la enumeración del protoclo de **LDAP** en paǵinas como [hacktricks](https://book.hacktricks.xyz/network-services-pentesting/pentesting-ldap)

