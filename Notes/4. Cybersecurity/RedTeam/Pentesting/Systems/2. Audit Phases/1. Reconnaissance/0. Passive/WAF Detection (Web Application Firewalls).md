# WAF 

Un **WAF** (**W**eb **A**pplication **F**irewall) es un firewall diseñado para protegere aplicaciones web filtrando, monitoreando y bloqueando el tráfico HTTP/S malicioso. Opera entre el cliente y el servidor, aplicando reglas para detectar posibles ataques como:

- [[SQLI - (SQL Injections)]].
- [[XSS  - ( Cross-Site Scripting )]].
- [[LFI - (Local File Inclusion)]].
- [[RCE - (Remote Command Execution)]].
- Brute forcing y scraping.

----
# Why detect a WAF? 

Detectar la presencia de un WAF en las primeras fases de un pentesting es un punto clave para:

1. *Planificar ataques*: Ajustar payloads para evadirlo.
2. *Reconocer limitaciones*: Algunas pruebas activas pueden ser bloqueadas.
3. *Analizar configuración y debilidades*: Algunos WAFs tienen bypasses conocidos.
4. *Evitar falsas alertas*: Los bloques pueden interpretarse como fallas de conectividad o errores si no se reconoce que son filtrados.

----
# Passive detection methods

Un *análisis pasivo* busca indicios de un WAF *sin enviar payloads maliciosos evidentes* ni forzar bloques visibles.

Algunos indicadores comunes para saber que nos enfrentamos a un WAF son:

- **Encabezados HTTP específicos**:
	- `Server: cloudflare`.
	- `X-Sucuri-ID: ...`.
	- `X-CDN: Imperva`.
	- `X-Akamai-Transformed: ...`.
- **Cookies inusuales** (Ej: `__cfduid`, `incap_ses`, `visid_incap`).
- **Certificados SSL** emitidos por el proveedor del WAF.
- **Respuestas personalizadas** en códigos de error (403, 406).
- **Variaciones en tiempos de respuesta** antes de ciertas peticiones.

> La detección pasiva pura puede hacersa nalizando tráfico legítimo, por ejemplo, un `curl`, tráfico proxieado con [[Burpsuite]] en modo pasivo o tools/scripts simples qeu revisen cabeceras.

----
# Detection examples

Algunos ejemplos de detección básicos y pasivos se listan debajo junto a sus herramientas:

- [Wafw00f](https://github.com/EnableSecurity/wafw00f): Herramienta más popular para *fingerprinting* de Web Applications Firewalls.
```bash
pip3 install wafw00f
wafw00f https://dobliuw.com --noattack
```

- [[Nmap]]: Herramienta de preferencia para enumeración de puertos y servicios. En este caso, para detectar WAFs con los scripts NSE que incluye:
```bash
nmap -p80,443 --script http-waf-detect dobliuw.com
```

- `curl`: Se podría analizar manualmente con la herramienta `curl`: 
```bash
curl -I https://dobliuw.com
```

- `whatweb`: Otra manera de analizar manualmente:
```bash
whatweb -v https://dobliuw.com
```

----
# Commount WAFs and they fingerprinting

| WAF / CDN             | Fingerprint                                    |
| --------------------- | ---------------------------------------------- |
| **Cloudflare**        | Encabezados `cf-ray`, cookie `__cfduid`        |
| **Akamai**            | `X-Akamai-Transformed`, certificados Akamai    |
| **Sucuri**            | `X-Sucuri-ID`                                  |
| **Imperva Incapsula** | Cookies `incap_ses`, `visid_incap`             |
| **AWS WAF**           | Respuestas `403` con plantilla genérica de AWS |
| **F5 BIG-IP ASM**     | Cookie `TSxxxxxxxx`                            |
| **Barracuda WAF**     | Banner `Barracuda` en respuesta                |
Adicionalmente, podríamos utilizar nuevamente [Wafw00f](https://github.com/EnableSecurity/wafw00f) para listar los WAFs más comunes con la flag `-l`. 

----
# Resources

- [List of WAF Fingerprints](https://github.com/EnableSecurity/wafw00f/blob/master/wafw00f/fingerprints.json).
- [OWASP WAF Security Testing](https://owasp.org/www-project-web-security-testing-guide/).