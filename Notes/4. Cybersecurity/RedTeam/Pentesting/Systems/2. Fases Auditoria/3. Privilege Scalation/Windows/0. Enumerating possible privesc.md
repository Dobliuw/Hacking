# Privilege Scalation

Como en todo proceso de Hacking a un determinado host, no importa cual sea su Sistema Operativo, la meta siempre será hacernos como dueños del mismo, de esta manera podremos tener el absoluto control y poder en el mismo. Pero esto no siempre es alcanzado tras la explotación, a lo mejor ingresamos al sistema por medio de una explotación web de un servicio IIS, en el caso de Windows, o Apache o Nginx, en el caso de OS basados en Linux, y no necesariamente vamos a ser usuarios Administradores o root, en cambio, vamos a haber obtenido acceso al sistema como el usuario que ejecuta la acción, es decir que muy probablemente seamos un usuario con bajos permisos o mismo una cuenta de servicio, al final.... pudimos haber obtenido acceso al sistema explotando una vulnerabilidad que nos permite obtener [[RCE - (Remote Command Execution)]] y cuando ejecutemos los comandos, estos serán ejecutados por el usuario que corra el servicio.

La meta de la fase de *Privilege Escalation* es escalar los permisos o privilegios que tiene el usuario vulnerado, esto puede implicar convertirnos en el usuario *Administrator*,  pero también puede implicar convertirnos en otros usuarios del sistema que tengan mayor privilegios al usuario vulnerado en principio, si bien la meta es ser dueños del sistema, no necesariamente puede haber una vía directa del usuario vulnerado en principio al usuario con máximos privilegios, puede ser una suseción de escaladas de privilegios hasta lograr nuestro goal. 

----
# Basic System enumeration

###### System Enumeration

Una vez en el sistema, llevar a cabo una enumeración del mismo es un proceso clave antes de tomar desiciones de realizar tareas más tediosas o de análisis profundo para búscar posibles vias de aumentar nuestro privilegio. Algunos de los comandos más básicos utilizados que nos pueden ayudar a detectar usuarios del sistema, arquitectura, version, nombre, redes, etc. del mismo son:

```powershell
# Print information about the config and properties of Local Machine
> systeminfo
# We could filter the stdout with findstr command
> systeminfo | findstr /B /IC:"os name" /IC:"os version" /IC:"system type"
> wmic os get Caption, OSArchitecture, Version
# Hostname 
> hostname
# Use Windows Management Instrumentation for last patches
> wmic qfe
> wmic qfe get Caption, Description, HotFixID, InstalledOn
# 
> wmic logicaldisk get caption,description,providername
```
###### Users Enumeration

Algo totalmente fundamental tras comprometer un sistema, es entender quiénes son los usuarios presentes para comprender el alcance de las cuentas y posibles puntos de entrada. La enumeración de usuarios implica identificar cuentas activas, privilegios asociados y posibles vulnerabilidades relacionadas con la gestión de usuarios. Herramientas como `net user` o `whoami` pueden proporcionar detalles sobre los usuarios locales y sus atributos. 

```powershell
# Verify who user we are
> whoami
# List privileges
> whoami /priv
# List groups information
> whoami /groups
# Get all users on the machine
> net user 
# Get information about specific user
> net user {username}
# Try to get local groups information
> net localgroup 
# Get members about a group
> net localgroup {group_name}
```

###### Network Enumeration

La infraestructura de red ofrece un panorama más amplio y potencialmente revelador del entorno en el que se encuentra el sistema comprometido. La enumeración de red implica identificar hosts activos, servicios expuestos, topología de red y relaciones entre dispostivios. herramientas como `ipconfig`, `netstat` y `nmap` so ncomunes para revelar direcciones IP, puertos abiertos y  conexiones activas, proporcionando información valiosa para mapear la superficie de ataque y encontras posibles vectores de escalada de privilegios.

```powershell
# See information about arquitecture of the network
> ipconfig
> ipconfig /all
# Look arp tables
> arp -a 
# Print the routing table
> route print
# Print open ports in the system
> netstat -ano
```
###### Password Hunting

Las contraseñas débiles o mal gestionadas puede representar una vulnerabilidad significativa en cualquier sistema. La búsqueda de contraseñas implica la identificación y explotación de debilidades en las políticas de seguridad de contraseñas, archivos de configuración, almacenamiento de contraseñas y prácticas de usuario. Herramientas como `pwdump` o `mimikatz` pueden extraer contraseñas almacenadas en el sistema, mientras que técnicas como el atque de diccionario o la fuerza bruta se tuiliza para descirfrar contraseñas débiles. La búsqueda de contraseñas es fundamental para aprovechar credenciales comprometidas y avanzar en los viles de privilegio dentro del sistema comprometido.

```powershell
# Find recursive and insensitive mode the word "password" in txt, conf and xml file in owenp user desktop
> findstr /si 'password' *.txt *.conf *.xml C:\Users\owenp\Desktop
# Find an SSID
> netsh wlan show profile
# Try to get Wi-Fi clear text password 
> netsh wlan show profile "{ssid}" key=clear
```
###### Firewalls and Antivirus

La presencia de firewalls en un sistema puede influir significativamente en la efectividad de los ataques y la escalada de privilegios .La enumeración de firewalls implica idetnficar las reglas de filtrado de paquetes, puertos bloqueados y políticas de seguridad aplicadas a nivel de red, herramientas como `netsh advfirewall` o, aunque deprecada, `netsh firewall` pueden revelar la configuración del firewall. 
Por otro lado, la presencia de software de antivirus puede representar otro obstáculo significativo para nosotros los pentesters o los ciberdelincuentes. La enumeración de antivirus implica idetnficar la presencia de software de seguridad, versiones, firmas de virus y configuraciones de detección. Herramientas como `wmic product get` en Windows pueden revelar la existencia de estos. Además , la exploración proactiva de políticas de escaneo, exclusiones de archvios y comportamientos del software antivirus puede proporcionar información curcial sobre cómo evadir la detección y persistir en el sistema comprometido.

```powershell
# List information about Windows Defender
> sc query windefend
# Find all services running (For another AVs)
> sc queryex type= service
# Try to dump firewall configurations
> netsh advfirewall firewall dump
# Older command to list firewall status
> netsh firewall show state 
# Show firewall configuration
> netsh firewall show config
```

Recurso: [PayloadAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md)
Recurso: [TotalOSCPGuide](https://sushant747.gitbooks.io/total-oscp-guide/content/privilege_escalation_windows.html)
Recurso: [Windows Privesc Checklist]()

---
# Automated Tools
###### Executables
- [winPEAS.exe](https://github.com/peass-ng/PEASS-ng/tree/master/winPEAS)
- [Seatbelt.exe (Compile)](https://github.com/GhostPack/Seatbelt)
- [Watson.exe (Compile)](https://github.com/rasta-mouse/Watson)
- [SharpUp.exe (Compile)](https://github.com/GhostPack/SharpUp)
###### PowerShell
- [Sharlock.ps1](https://github.com/rasta-mouse/Sherlock)
- [PowerUp.ps1](https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc)
- [jaws-enum.ps1](https://github.com/411Hall/JAWS)
###### Other
- [windows-exploit-suggester.py (local)](https://github.com/AonCyberLabs/Windows-Exploit-Suggester)
- [Exploit Suggester (Metasploit)](https://www.rapid7.com/blog/post/2015/08/11/metasploit-local-exploit-suggester-do-less-get-more/)

Tanto los ejecutables como los scripts en powershell son herramientas que nos automatizan una gran parte de la detección de posibles vulnerabilidades, estos ejecutables y scripts se corren en la máquina víctima y obtendremos un output el cual podremos analizar con mayor cuidado. Pero también existen otras alternativas, como por ejemplo el uso de herramientas como [Windows Exploit Suggester](https://github.com/AonCyberLabs/Windows-Exploit-Suggester) el cual es un script en Python que corremos de manera local que hace uso de una base de datos de vulnerabilidades y lee un archivo .txt el cual debería tener el contenido del output del comando `systeminfo`. 

Por lo que en la máquina víctima ejecutamos el comando `systeminfo`, capturamos el output y lo guardamos en un archivo en nuestra máquina de atacante local y posteriormente instalamos las dependencias necesarias, ejectuamos los comandos adjuntados en la guía de uso de Windows Exploit Suggester y obtendríamos posibles vulnerabilidades a revisar y explotar.

```bash
# Clone the Windows Exploit Suggester tool
git clone https://github.com/AonCyberLabs/Windows-Exploit-Suggester -l windowsSuggester
# Install or Upgrade if is possible the dependencie xlrd
pip3 install xlrd --upgrade
# Update the database .xlsx file 
python2 windowsSuggester/windows-exploit-suggester.py --update
# Try to found vulnerabilities
python2 windowsSuggester/windows-exploit-suggester.py --database {database.xlsx} --systeminfo {path/to/file.txt/with/systeminfo/output}
```