-----
-  Tags: #ataques #practica #teoria #basico #reconocimiento
-----

# ¿ Que es **Squid Proxy** ? 

El **squid proxy** es un servidor web *proxy-caché* con licencia **GPL** cuyo objetivo es funcionar como **proxy** de la red y también como zona caché para almacenar páginas web, entre otros. Se trata de un servidor situado entre la máquina del usuario y otra red (a menudo internet) que actúa como protección separando de las dos redes y como zona caché para acelerar el acceso a páginas web o poder restringir el acceso a contenidos. 

La función de un sercidor proxy es centralizar el tráfico de una red local hacia el exterior (Internet). Sólo el equipo que incorpora el servicio proxy debe disponer de conexión a internet y el resto de equipos salen a tracés de él:

![[proxy.png.png||1300]]

Ahora bien, puede darse el caso en el que un servidor **squid proxy** se encuentre *mal configurado*, permitiendo en consecuencia a los atacantes recopilar información de dispositivos a los que normalmente no deberían tener acceso. 

Por ejemplo, en este tipo de situaciones, un atacante podría ser capaz de realizar peticiones a direcciones IP internas pasando sus consultas a través del squid proxy, pudiendo así realizar un escaneo de puertos contra determinados servidores situados en una **red interna**. 

Para ello, simplemente se podría hacer uso de extensiones de navegador como **FoxyProxy** o desde consola haciendo uso del comando **curl**: 

```shell
curl --proxy http://{ip_proxy}:{port_proxy} http://{ip}:{port}
```

En el mejor de los casos, si la conexión no requiere de autenticación, podríamos llevar a cabo una enumeración de puertos en servidores internos concretos. En caso de requerir autenticación, si el atacante dispone de las credenciales ,estas podrían ser especificadas haciendo uso del parámetro **-u**. 

Todo esto es posible debido a que el proxy actúa como intermediario entre la red **local** y la **externa**, lo que en parte permite el acceso a ciertos recursos internos qeu normalmente no estarían disponibles desde el exterior. 

Es importante tener en cuenta que el acceso a estos recursos a través del proxy puede estar restringido por políticas de seguridad, autenticación u otros mecanismos de control de acceso. Además, si el proxy está configurado correctamente, es probable que no permita el acceso a recursos internos desde el exterio, **incluso si está pasando a través de él**.

----

# Enumeración 

Una de las herramientas que se suelen emplear para enumerar puertos de un servidor concreto pasando por el **squid proxy** es *Spose*. 

Como mencionamos anteriormente, para utilizar el proxy podriamos hacer uso de **FoxyProxy** o mismo el comando **curl**: 

```shell 
curl --proxy http://<proxy_ip>:<proxy_port> http://<ip>:<port> 

# En caso de necesitar utilizar credenciales
curl --proxy 'http://{username}:{password}@<proxy_ip>:<proxy_port>' http://<ip>:<port>
```


Si estuviera el puerto 80 abierto, podríamos realizar [[Tools]] de enumeración como *goBuster* o **Wfuzz**: 

```shell
gobuster dir --help | grep -i proxy 

gobuser dir --proxy http://<proxy_ip>:<proxy_port> -w /usr/share/SecLists/Discovery/Web-Content/directory-list-2.3-medium.txt -u http://<ip>:<port> -t 20 

# En caso de necesitar utilizar credenciales 
gobuser dir --proxy 'http://<username>:<password>@<proxy_ip>:<proxy_port>' -w /usr/share/SecLists/Discovery/Web-Content/directory-list-2.3-medium.txt -u http://<ip>:<port> -t 20 
# En caso de que arroje error, poner los caracteres especiales (Por ejemplo de la password) en url encode (man ascii)
```

También podriamos crear un script en python para realizar un descubrimiento de puertos internos como por ejemplo: 

```python
#!/usr/bin/python3 

import sys, signal, requests 

# Ctrl + C 

def ctrl_c(sig, frame): 
    print("\ņ\n[!] Saliendo....\n\n")
    sys.exit(1)

signal.signal(signal.SIGINT, ctrl_c)

# Global Vars 

top_101_commouns_ports = {
    21, 22, 23, 25, 53, 80, 110, 115, 118, 119, 143, 156, 161, 194, 220, 389,
    443, 445, 465, 514, 515, 530, 543, 544, 548, 554, 587, 631, 636, 873, 989,
    990, 993, 995, 1080, 1099, 1433, 1521, 1701, 1723, 1883, 1900, 2082, 2083,
    2181, 2222, 2375, 2376, 3306, 3389, 3689, 3690, 3780, 4333, 4444, 4500, 4567, 
    4899, 5000, 5001, 5060, 5432, 5672, 5900, 5984, 6379, 6443, 6789, 6881, 8080, 
    8081, 8443, 8888, 9100, 9200, 9418, 9999, 11211, 27017, 27018, 27019, 28017, 
    50000, 50070, 50075, 50090, 61616, 8088, 9000, 9001, 9092, 9201, 9300, 10000, 
    11210, 11211, 27015, 27016, 27020, 28015, 28016, 48010, 48011, 48012, 48013, 
    48014
}

url = "http://127.0.0.1"
squid_proxy = {'http': 'http://192.168.1.34:3128'}

# Bin 

def port_discovery(): 
    for port in top_101_commouns_ports: 
        r = requests.get(url + ':' + str(port), proxies=squid_proxy)
    
        if r.status_code != 503: 
            print("(+) Port %d OPEN." % port)

if __name__ == "__main__":
    port_discovery() 

```

Otra cosa a tener en cuenta es que podríamos hacer uso de la herramienta **proxychains** para realizar esto, haciendo uso del archivo de configuración de **/etc/proxychains4.conf** podríamos indicar un **strict_chain** para configurar un proxy de tipo **http** con su respectiva ip y puerto. De manera que haciendo esto, posteriormente podríamos hacer uso de la herramienta proxychains para apuntar al localhost. 

```bash
proxychains -q nmap -Pn -sT --open -T5 -n -v 127.0.0.1 
```

Algo que puede ser importante a tener en cuenta en algunas ocaciones, es que podríamos obligar al flujo de conexiones a pasar por la propia interfaz del **squid proxy** para intentar tener conexión con servicios o dispositivos que tal vez no logramos tener. Es decir, en el archivo **/etc/poroxychains4.conf** puede ser buena ídea agregar la línea **http 127.0.0.1 3128** para obligar al flujo de conexiones a pasar por la porpia interfaz del squid proxy, quedando el flujo de conexiones de la siguiente manera. 

# (Nuestra máquina) ---> {target_ip}:3128 -----> 127.0.0.1:3128 -----> {otra_ip}

