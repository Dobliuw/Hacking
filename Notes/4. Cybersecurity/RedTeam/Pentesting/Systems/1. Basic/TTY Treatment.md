# TTY

En sistemas Unix y Unix-like, *TTY* (*teletyperwriter*) se refiere a cualquier terminal que proporciona una interfaz de usuario para interactuar con el sistema operativo. Se refiere principalmente a terminales virtuales que permiten la interacción con el sistema operativo.

Cuando hablamos del *tratamiento a la tty* en un contexto de pentesting, nos referimos a mejorar la manipulación y control de la terminal. Cuando obtenemos una [[Shells#Reverse Shell]] o una [[Shells#Bind Shell]], es común encontrarnos con que estas se encuentran limitadas. Esto significa que ciertas funcionalidades de la terminal no están disponbles, como el uso de las teclas de flechas para editar comandos, el autocompletado, la ejecución de ciertos comandos interactivos y el manejo adecuado de señales como ctrl c. 

Para obtener una terminal completa con las funcionalidades mejoradas, es necesario elevar la shell básica obtenida a una pseudo-terminal (PTY). Aca es donde entra el juego el tratamiento de la TTY:

###### Opción 1 (Sesión de terminal):
Utilizamos el comando `script` para iniciar una nueva sesión de terminal (*bash*) sin grabar nada (redirigiendo la salida al */dev/null*).

```bash
script /dev/null -c bash
```

Luego, presionamos la combinación de teclas `ctrl + z` para envíar la señal `SIGTSTP` al proceso en primer plano, suspendiéndolo temporalmente y devolviéndonos a la shell original de nuestro sistema.

Proseguimos con la ejecución del comando  `stty` para configurar el terminal en modo raw y desactivar el eco para posteriormente renaudar el proceso previamente suspendido:

```bash
stty raw -echo; fg
```

Con este comando, el terminal pasa a modo *raw*, donde el input se envía directamente al programa sin procesamiento (Sin interpretacinoes como EOF o señales) junto con la desactivación de el eco, por lo que las teclas presionadas no se muestran en la pantalla.

Tras la ejecución de estos comandos, veremos que se nos "buguea" la consola, donde en caso de escribir veremos que escribimos en el aire, de igual manera deberemos teclear el comando: 

```bash
reset xterm
```

Para limpiar el terminal y reconfigurar parámetros, asegurando que esté en un estado funcional adecuado junto con la configuración específica de *xterm*, que es un emulador de terminal común con diversas capacidades.

En este punto casi tendríamos una TTY 100% interactiva, pero algunas funcionalidades como el `ctrl + c` en este punto podrían seguir sin funcionar, aunque en caso de que funcione podríamos notar que al presionar esta combinación no perdemos la conexión, simplemente habría que retocar las variables de entorno `$SHELL` y `$TERM`, junto con *ajustar las proporciones* de la TTY en caso de ser necesario:

```bash
export SHELL=bash
export TERM=xterm
```

En este punto, para ajustar el tamaño de nuestra terminal de maner correcta en lo que a filas y columnas respecta, podríamos hacer uso del comando `stty` para visualizar nuestras proporciones (filas y columnas) utilizadas en una terminal de nuestro gusto:

```bash
stty -a
```

Una vez habiendo detectado las filas y columnas utilizadas, finalmente configuraremos estas proporciones a nuestra TTY, dandonos como resultado una TTY 100% interactiva como la que podríamos usar diariamente en nuestro sistema:

```bash
stty rows {rows_num} columns {columns_num}
```
###### Opción 2 (Python):
En este caso, podríamos optar por hacer uso de *python* para obtener una TTY interactiva y redirigiendo la entrada y salida al `/dev/null`:

```bash
python3 -c 'import pty; pyt.spwan("/bin/bash")' 2>&1 | tee /dev/null
```

Posteriormente, proseguiremos con suspender el proceso y configurar la terminal en modo raw y sin eco, nuevamente presionamos `ctrl + z` y ejecutamos el comando: 

```bash
stty raw -echo; fg
```

Luego de esto, simplemente restará ejecutar el comando `reset` para resetear la terminal y realizar las configuraciones de variables de entorno y de proporciones vistas en la *Opción 1*:

```bash
export TERM=xterm
export SHELL=bash
stty rows {rows_num} columns {columns_num}
```