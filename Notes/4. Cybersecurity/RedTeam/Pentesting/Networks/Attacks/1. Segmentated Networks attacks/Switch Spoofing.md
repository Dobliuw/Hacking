# Switch Spoofing

Muchos switches de red establecen tunk links de VLANs dinámicamente usando un *Cisco proprietary netwroking protocol* llamado **Dynamic Trunking Protocol** (**DTP**). DTP permite a dos swtiches conectados crear un trunk link y luego negociar la VLAN usando el método *tagging* mencionado en [[0. Segmentated Networks - VLANs#Trunk Links & VLAN Tagging]]. 

El ataque **Switch Spoofing** consiste en que el atacante abuse del protocolo **DTP** fingiendo que su dispositivo es un switch de la red, logrando así que su dispositivo genere un trunk link con un switch légitimo de la red. Como resultado, el atacante gana acceso a los paquetes provenientes de cualquier VLAN con la cual el switch légitimo interactuase.

---
# Exploit 

[Yersinia](https://github.com/tomac/yersinia) es una herramiente ade código abierto diseñada para realizar pentesting y explotar  vulnerabilidades de nprotocolos de red en la capa de enlace de datos (Capa 2 del [[Modelo OSI - OSI Model]]). Es muy útil para probar la seguridad de redes basadas en tecnologías como **VLANs**, *Spanning Tree Protocol* (*STP*), **Dynamic Trunking Protocol** (**DTP**), etc.

Si estamos usando *Kali Linux* esta herramienta ya viene pre-instalada, pero previamente necesitaremos instalar el paquete `kali-linux-large`:

```bash
sudo apt instal kali-linux-large
```

Este enfoque es el recomendado en lugar de compilar las herramientas manualmente, pero si quisieramos podríamos intentar compilar manulamente *Yersinia* de la siguiente manera:

```bash
sudo su
apt-get install libnet1-dev libgtk2.0-dev libpcap-dev
tar xvfz yernisia-0.8.2.tar.gz && cd yersinia-0.8.2 && ./autogen.sh
./configure
make && make install 
```

Para establecer el *trunk link* con el dispositivo del atacante, necesitaremos abrir la interfaz gráfica de *Yersinia*:

```bahs
yersinia -G
```

Una vez en la interfaz, clickearemos donde dice *Launch Attack* y posteriormente en la pestaña de *DTP* seleccionaremos la opción de *Enable trunking*. 

![[yersinia_dtp_tab.png]]

Cuando seleccionemos esta opción, Yersinia comenzará a imitar a un swtich que admita el protocolo FTP, conectarse al pueto de un switch víctima y enviar repetidamente los paquetes DTP necesarios para establecer un *trunk link* con el swtich víctima. 

Una vez que se haya realizado el trunk link deberíamos ver en la pestaña *802.1Q* los datos de las VLANs disponibles.

![[802.1Q_yersinia_tab_example.png|900]]

Los datos además incluyen las *VLAN IDs* disponibles. Para acceder a los paquetes de una vLAN, primero deberemos identificar nuestra interfaz de red con el comando `nmcli`:

```bash
nmcli
# eth0: connected to Wired connection 1
#        "Intel 82545EM"
#        ethernet (e1000), 00:0C:29:89:BB:DE, hw, mtu 1500
```

En este ejemplo, el dispositivo del atacante utiliza la interfaz de red *eth0*, por lo que ingresaremos los sigueintes comandos:

```bash
sudo modprobe 8021q
sudo vconfig add eth0 20
sudo ifconfig eth0.20 192.168.1.2 netmask 255.255.255.0 up
```

Con el comando `sudo modprobe 8021q` estamos cargando el modulo del kernel para el método de *VLAN Tagging*. Por otro lado, estamos creando una nueva interfaz de red con la *VLAN ID* deseada usando el comando `sudo vconfig add {netowrk_interface} {desired_VLAN_ID}`. Finalmente con el comando `sudo ifconfig {network_interface}.{sub_interface(VLAN_ID)} {IP_Address} netmask {netmask} up` estamos habilitando la interfaz de red luego de haberla configurado asignandole una dirección IP con la cual nos comunicaremos a la VLAN 20, previamente configurada, por ejemplo con *eth0.20*, donde indicamos que la interfaz de red física es *eth0* pero la subinterfaz es la *20*, así como su correspondiente netmask respectiva a la IP asignada. 
