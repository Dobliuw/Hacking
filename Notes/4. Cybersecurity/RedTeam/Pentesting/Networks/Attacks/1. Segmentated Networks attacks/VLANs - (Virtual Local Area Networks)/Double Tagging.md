# Double Tagging

El ataque de **Double Tagging** es una técnica de ataque en redes VLANs que explota una vulnerabilidad en la forma en que algunos swtiches manejan las etiquetas VLAN en tramas Ethernet. Este ataque permite a un atacante enviar tráfico no autorizado desde una VLAN a otra, lo que puede llevar a una violación de la segmentación de red y potencialmente a la exfiltración de datos o ataques más avanzados.

Como vimos en [[0. VLANs#Trunk Ports]], los *Trunk Ports* son puertos de un switch que pueden transportar tráfico de múltiple VLANS, siendo este etiquetado con el ID de la VLAN a la que pertenece el mismo.

Por otro lado, también hemos mencionado el proceso de *VLAN Tagging*  ([[0. VLANs#Trunk Links & VLAN Tagging]]), el cual se basa en el proceso de agregar una etiqueta/tag que incluye la *VLAN ID* al tráfico que pasa por un *Trunk Port*. Este proceso se maneja comúnmente meidante el protocolo **IEEE 802.1Q**. 

---
# Exploit

El atacante crea una trama Ethernet con dos etiquetas VLANS, una externa (La primera) y otra interna (La segunda). La primera etiqueta, ejemplo *VALN 1* corresponde a la VLAN a la que está conectado el atacante, mientras que la segunda etiqueta, ejemplo *VLAN 20* corresponde a la VLAN objetivo que quiere acceder.

El switch que recibe el paquete *Double Tagged* en un puerto de acceso, elimina la primera etiqueta (*VLAN 1*) porque asume que el mismo pertenece a su VLAN nativa. Ahora, el paquete, que aún contiene la segunda etiqeuta (*VALN 20*), se reenvía al puerto trunk conectado a otros switches.

Cuando el paquete llega a otro switch a través del *trunk link*, se trata como si perteneciera a la VLAN interna (*VLAN 20*) debido a la etiqueta restante. El switch entonces entrega la trama a la *VLAN 20*, permitiendo que el atacante envíe tráfico hacia una VLAN a la que no debería tener acceso.

![[double_tagging_attack_example.png]]

Para llevar a cabo este tipo de ataques, podríamos hacer uso del framework [Scapy](https://scapy.net) para programar herramientas de manipulación de paquetes en *Python*.

- Instalr *Scapy*:
```bash
pip install scapy
```

- Código de Python con Scapy que emite una traza ICMP a un dispositivo víctima con la IPv4 192.168.1.20 localizado en la VLAN 20. Lógicamente etiquetando el paquete con 2 VLAN ID's, 1 y 20.

```python
from scapy.all import *

packet = Ether()/Dot1Q(vlan=1)/Dot1Q(vlan=20)/IP(dst='192.168.1.20')/ICMP()
sendp(packet)
```

La función `Ether()` crea un capa de link auto generada. Luego utilizando la función `Dot1Q()` creamos tos *VLAN Tags*. Con la función `IP()` definimos una capa de red customizada para routear el paquete al dispositivo víctima. Finalmente, agregamos un payload auto generado que contiene la capa de transporte que queremos usar (Por ejemplo ICMP). 

Es importante tener en cuenta que la respuesta ICMP nunca llegará a nuestro dispositivo de atacante, pero podriamos verificar que el ataque tuvo éxito observando los paquetes de red en la VLAN de la víctima mediante herramientas como *Wireshark* o *Tshark*. 
