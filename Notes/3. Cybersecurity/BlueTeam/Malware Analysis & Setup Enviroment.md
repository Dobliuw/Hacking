---

---
--------------------
- Tags: #teoria #practica #blue #analysis #malware
-----------
# Entorno de análisis de Malware

Para analizar y trabajar con malware, es importante tener en cuenta que es una actividad muy riesgosa, la cual puede conllevar a múltiples peligros como usuario, desde persistencia, commands and controls, etc. por lo que para análizar muestras de malware haremos uso de un entorno de análisis el configuraremos el cual permitirá por un lado analizar el comportamiento del host tras la detonación del malware, como por otro, simular la red para recibir las peticiones que realize el malware.

En este entorno haremos uso de dos máquinas virtuales aisladas de la red principal para no poner en riesgo la máquina host, este entorno contará con dos máquinas virtuales con conexión entre si donde una tendrá el sistema operativo Windows 10 x64 bits a la cual se le instalará Flare-VM y por otro lado, una máquina Linux que contará acon [remnux](https://remnux.org/).

--------
# Setup Enviroment

### Linux (Remnux)

La primera máquina que formará parte de nuestro entorno de análisis es una máquina Linux que cuenta con **Remnux**, el cual es un popular kit de herramientas basado en Linux para analizar software malicioso de ingeniería inversa en el que los analistas de malware han estado confiando durante mucho tiempo para ayudarlos a investigar rápidamente programas sospechosos, sitios web y ficheros o archivos de documentos.
###### Instalación de Remmux
En esta caso la instalación consta en dirigirnos al [sitio oficial de descarga](https://remnux.org/) para descargar el **OVA** el cual posteriormente deberá ser utilizado para crear una máquina virtual en nuestro gestor de máquinas virtuales favorito.

### Windows 10 (Flare-VM)

La segunda y última máquina de nuetro entorno es una máquina Windows x64 que contará con **Flare-VM**, la cual es una suite de scripts de instalación de software para sistemas Windows que permite configurar y mantener fácilmente un entorno de ingeniería inversa en una máquina virtual. Esta suite incluye una variedad de herramientas y software preinstalado que los investigadores de seguridad y analistas de malware pueden utilizar para analizar, depurar y desmontar programas maliciosos, así como para investigar incidentes de seguridad en sistemas Windows. 
###### Instalación de Flare-VM
En este caso la instalación es un poco más extensa, primero que nada nos tenemos que descargar una **.iso** de un sistema Windows x64 bits (Esto se puede hacer desde [aquí](https://www.microsoft.com/en-us/evalcenter/download-windows-10-enterprise)), una vez descargada procederiamos a crear una máquina virtual haciendo uso de esta imagen iso y de nuestras configuraciones favoritas (En caso de sufrir problemas relacionados al error *Windows cannot find the Microsoft Software License Terms* ver [este video](https://www.youtube.com/watch?v=FgeZfpLUTGs&t)), una vez terminado este proceso continuariamos con los comandos a ejecutar. 

Una vez instalado Windows y estando dentro de el, procederemos a ejecutar en la *PowerShell* como *Administrador* los siguientes comandos: 

```powershell
# Install VCLibs
wget https://aka.ms/Microsoft.VCLibs.x64.14.00.Desktop.appx -usebasicparsing -o VCLibs.appx

# Install Windows Terminal MSIX bundle
wget https://github.com/microsoft/terminal/releases/download/v1.15.3465.0/Microsoft.WindowsTerminal_Win10_1.15.3465.0_8wekyb3d8bbwe.msixbundle -UseBasicParsing -o winterminal.msixbundle

# Add the VClibs package
Add-AppxPackage [C:\path\to\downloaded\VCLibs.appx]

# Add the Windows terminal MSIX bundle package
Add-AppxPackage [C:\path\to\downloaded\winterminal.msixbundle]
```

Una vez realizada la instalación de los paquetes anteriores y habiendolos agregado, procederemos con la **desactivación** de la opción **Automatically detect settings** en el apartado de **proxy settings**. Así mismo también deberemos desactivar el **Windows Defender**, para esto seguiremos los siguientes pasos:

- Buscar **Defender** en la barra de tareas, ingresar en las **configuraciones** del Windows Defender y cambiar a **off** todas las opciones del Defender.
- Para deshabilitar el Defender en el GPO nos dirigimos a **group policy** en la barra de tareas, posteriormente, una vez en el GPO nos dirigimos a -> **Administrative Templates** -> **Windows Componentes** -> **Microsoft Defender Antivirus** -> Enable **Turn off Microsoft Defender Antivirus**. 

Una vez hecho esto, procederemos a deshabilitar el **Windows Firewall**, para esto seguiremos los siguientes pasos:

- Buscar **group policy** en la barra de tareas, posteriormente, una vez en el GPO nos dirigimos a -> **Administrative Templates** -> **Network** -> **Network Connections** -> **Windows Defender Firewall** -> *Domain Profile* -> Deshabilitar **Protect All Network Connections**. Este proceso también deberá ser repetido para el *Standar Profile*.

En este punto, se recomendaría realizar una **SNAPSHOT** de nuestra máquina virtual con las configuraciones aplicadas.

Posterior a esto, continuaremos con la descarga de *Flare-VM*. 

```powershell
# In the Desktop -> Install FLARE-VM
(New-Object net.webclient).DownloadFile('https://raw.githubusercontent.com/mandiant/flare-vm/main/install.ps1',"$([Environment]::GetFolderPath("Desktop"))\install.ps1")

Unblock-File .\install.ps1

Set-ExecutionPolicy Unrestricted

# Accept the prompt to set the ExecPol to unrestricted if one appears

.\install.ps1 -customConfig https://raw.githubusercontent.com/HuskyHacks/PMAT-labs/main/config.xml
```

Una vez ejecutados estos comandos, contunaremos hasta que finalize la instalación y una vez finalizada la misma, tomaremos otra **SNAPSHOT** con las configuraciones aplicadas a la par que la resiente *Flare-VM* instalada y configurada. 

## Network Setup 

Como se menciono anteriormente, en este caso es de vital importancia que este entorno de análisis de malware se encuentre **totalmente aislado**, es decir,  sin conexión con nuestro host, por lo que la configuración de la red del mismo es clave para tener un entorno seguro. En este caso deberemos verificar y configurar que ninguna de las dos máquinas virtuales que conforman nuestro entorno se encuentren en modo *Bridged*.

La configuración de red necesaria en caso de contar con **VMWare Workstation PRO** será crear una red (Esto será diferente según nuestro gestor de máquinas virtuales) en la cual ingresemos un segmento de red que diferencia a simple vista nuestra red local e ingresar ambas máquinas a esta nueva red creada. Esto lo podemos hacer yendo a **Edit** -> **Virtual Network Editor...** -> **Change Settings** (Esto pedirá permisos de administrador) -> **Add Network**. 

Una vez configurada a nuestro gusto la red, la misma se verá algo así: 

![[network_setup_malware_analysis.png]]

En este caso las configuraciones se realizaron en **VMWare Workstation PRO** y en la imagen se puede apreciar que además de nuestra red NAT, se creo una nueva (*VMnet1*) la cual tiene un segmento de red que nos permite diferenciar de manera rápida la red de nuestra red local. 

Una vez creada esta red, deberemos configurar nuestras dos máquinas (Windows y Linux) para esto haremos click derecho sobre la máquina a modificar, nos dirigiremos a **Settings** -> **Network Adapter** -> y seleccionaremos la opcion **Custom** para seleccionar la red creada, en este caso *VMnet1*.

![[network_adapter_settings_vmware.png]]

### Fake Internet Setup
###### Linux Machine Setup

En este caso, como se menciono anteriormente la máquina Windows nos permitirá análizar que ocurre con esta cuando el malware es detonado, mientras que la máquina Linux funcionará como un **Fake Internet** permitiendonos recibir todas las peticiones que se realizen a nivel de red, ya sea HTTP, DNS, etc.

Para esto es importante configurar el software proveniente con **remnux** que nos permitirá realizar esto, por lo que en nuestra máquina Linux modificaremos la configuración de la herramienta **inetsim** la cual nos permitirá realizar esto:

```bash
sudo nano /etc/inetsim/inetsim.conf
```

En este caso nos intereza realizar los siguientes cambios:

- Descomentar la línea que se encarga de levantar el servidor DNS:
**#start_service dns**

- Modificar la línea de *service bind address* con el valor *0.0.0.0*:
**service_bind_address       0.0.0.0**

- Modificar el apartado *default IP* de la sección *service DNS* por la IP de nuestra máquina virtual de remnux, esto lo podemos ver con el comanod `hostname -I`: 
**dns_default_ip    {remnux_IP}**

Una vez configurado esto, con el comando `inetsim` podremos inicializar nuestra *fake network*. 
###### Windows Machine Setup

Una vez realizadas las configuraciones pertinentes en la máquina linux, deberemos modificar nuestro servidor DNS para que este sea el de nuestra máquina Linux Remnux recientemente configurada, para esto procederemos a ir al apartado de **Network Connections** en nuestra máquina Windows Flare-VM, posteriormente a nuestro **Ethernet0** -> **Properties** -> **Internet Protocol Version 4 (TCP/IPv4)** y modiciamos las propiedades para hacer uso de un servidor DNS ingresado manualmente, el cual será nuestra máquina Linux Remnux, por lo que marcamos la opción **Use the following DNS server addresses:** y posteriormente ingresamos en **Preferred DNS server:** la IP de nuestra máquina Linux Remnux.

De esta manera todas las peticiones que pueda llegar a realizar un malware se recibiran y procesaran por nuestra máquina Linux Remnux. 